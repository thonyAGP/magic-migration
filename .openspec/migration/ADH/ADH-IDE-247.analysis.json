{
  "domain": "deversementTransaction",
  "domainPascal": "DeversementTransaction",
  "complexity": "HIGH",
  "entities": [
    {
      "name": "Vente",
      "fields": [
        {
          "name": "id",
          "type": "number",
          "source": "vente.id",
          "nullable": false
        },
        {
          "name": "societe",
          "type": "string",
          "source": "vente.societe",
          "nullable": false
        },
        {
          "name": "compte",
          "type": "string",
          "source": "vente.compte",
          "nullable": false
        },
        {
          "name": "filiation",
          "type": "number",
          "source": "vente.filiation",
          "nullable": false
        },
        {
          "name": "dateEncaissement",
          "type": "Date",
          "source": "vente.date_encaissement",
          "nullable": true
        },
        {
          "name": "montant",
          "type": "number",
          "source": "vente.montant",
          "nullable": false
        },
        {
          "name": "annulation",
          "type": "boolean",
          "source": "vente.annulation",
          "nullable": false
        },
        {
          "name": "typeVente",
          "type": "string",
          "source": "vente.type_vente",
          "nullable": true
        }
      ]
    },
    {
      "name": "OperationDiverse",
      "fields": [
        {
          "name": "id",
          "type": "number",
          "source": "comptable_cte.id",
          "nullable": false
        },
        {
          "name": "societe",
          "type": "string",
          "source": "comptable_cte.societe",
          "nullable": false
        },
        {
          "name": "compte",
          "type": "string",
          "source": "comptable_cte.compte",
          "nullable": false
        },
        {
          "name": "typeOD",
          "type": "string",
          "source": "comptable_cte.type_od",
          "nullable": false
        },
        {
          "name": "montant",
          "type": "number",
          "source": "comptable_cte.montant",
          "nullable": false
        },
        {
          "name": "dateOperation",
          "type": "Date",
          "source": "comptable_cte.date_operation",
          "nullable": false
        }
      ]
    },
    {
      "name": "CompteGM",
      "fields": [
        {
          "name": "societe",
          "type": "string",
          "source": "compte_gm_cgm.societe",
          "nullable": false
        },
        {
          "name": "compte",
          "type": "string",
          "source": "compte_gm_cgm.compte",
          "nullable": false
        },
        {
          "name": "solde",
          "type": "number",
          "source": "compte_gm_cgm.solde",
          "nullable": false
        },
        {
          "name": "dateMAJ",
          "type": "Date",
          "source": "compte_gm_cgm.date_maj",
          "nullable": false
        }
      ]
    },
    {
      "name": "Hebergement",
      "fields": [
        {
          "name": "societe",
          "type": "string",
          "source": "hebergement_heb.societe",
          "nullable": false
        },
        {
          "name": "compte",
          "type": "string",
          "source": "hebergement_heb.compte",
          "nullable": false
        },
        {
          "name": "chambre",
          "type": "string",
          "source": "hebergement_heb.chambre",
          "nullable": true
        },
        {
          "name": "dateDebut",
          "type": "Date",
          "source": "hebergement_heb.date_debut",
          "nullable": true
        },
        {
          "name": "dateFin",
          "type": "Date",
          "source": "hebergement_heb.date_fin",
          "nullable": true
        },
        {
          "name": "statut",
          "type": "string",
          "source": "hebergement_heb.statut",
          "nullable": true
        }
      ]
    },
    {
      "name": "TransfertAffectation",
      "fields": [
        {
          "name": "id",
          "type": "number",
          "source": "generated",
          "nullable": false
        },
        {
          "name": "venteId",
          "type": "number",
          "source": "vente.id",
          "nullable": false
        },
        {
          "name": "affectation",
          "type": "string",
          "source": "user_input",
          "nullable": true
        },
        {
          "name": "dateTransfert",
          "type": "Date",
          "source": "generated",
          "nullable": false
        }
      ]
    }
  ],
  "stateFields": [
    {
      "name": "vente",
      "type": "Vente | null",
      "default": "null"
    },
    {
      "name": "operationsDiverses",
      "type": "OperationDiverse[]",
      "default": "[]"
    },
    {
      "name": "isProcessing",
      "type": "boolean",
      "default": "false"
    },
    {
      "name": "error",
      "type": "string | null",
      "default": "null"
    },
    {
      "name": "affectationTransfert",
      "type": "string",
      "default": "''"
    },
    {
      "name": "showAffectationModal",
      "type": "boolean",
      "default": "false"
    },
    {
      "name": "numeroTicket",
      "type": "number | null",
      "default": "null"
    },
    {
      "name": "venteVrlVsl",
      "type": "boolean",
      "default": "false"
    },
    {
      "name": "complementsBiking",
      "type": "any[]",
      "default": "[]"
    }
  ],
  "actions": [
    {
      "name": "deverserVente",
      "params": [
        "venteId: number",
        "annulation: boolean"
      ],
      "businessRules": [
        "RM-001: Si le type de compte est 'OD', utiliser 'OD' comme préfixe",
        "RM-002: Si annulation, additionner le montant absolu au solde, sinon le soustraire",
        "Créer 9 opérations diverses (OD) pour différents comptes et services",
        "Mettre à jour le compte GM avec le nouveau solde",
        "Mettre à jour l'hébergement si applicable",
        "Incrémenter les compteurs de ventes",
        "Gérer les ventes VRL/VSL avec numérotation de ticket spécifique",
        "Créer les enregistrements de transfert si affectation définie",
        "Mettre à jour les compléments biking si applicable",
        "Gérer la libération LCO et l'heure de libération",
        "Vérifier et envoyer les notifications email si configuré"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "creerOperationDiverse",
      "params": [
        "vente: Vente",
        "typeOD: string",
        "montant: number"
      ],
      "businessRules": [
        "Créer une OD avec le type, compte, montant et date appropriés",
        "Utiliser la date d'encaissement de la vente ou la date du jour"
      ],
      "returns": "Promise<OperationDiverse>"
    },
    {
      "name": "mettreAJourCompteGM",
      "params": [
        "societe: string",
        "compte: string",
        "montant: number",
        "annulation: boolean"
      ],
      "businessRules": [
        "RM-002: Calculer le nouveau solde selon si c'est une annulation ou non",
        "Mettre à jour la date de dernière modification"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "mettreAJourHebergement",
      "params": [
        "societe: string",
        "compte: string",
        "statut: string"
      ],
      "businessRules": [
        "Mettre à jour le statut de l'hébergement (T17: Maj hebergement Z)",
        "Gérer la libération LCO si applicable (T21)",
        "Mettre à jour l'heure de libération (T22)"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "affecterTransfert",
      "params": [
        "venteId: number",
        "affectation: string"
      ],
      "businessRules": [
        "Créer un enregistrement de transfert avec l'affectation saisie (T16)",
        "Associer le transfert à la vente concernée"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "razAffectationTransfert",
      "params": [
        "venteId: number"
      ],
      "businessRules": [
        "Réinitialiser l'affectation de transfert pour la vente (T18)",
        "Supprimer les enregistrements de transfert temporaires"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "incrementerNumeroTicket",
      "params": [
        "typeVente: 'VRL' | 'VSL'"
      ],
      "businessRules": [
        "T13: Incrémenter le compteur de numéros de ticket pour VRL/VSL",
        "Retourner le nouveau numéro de ticket généré"
      ],
      "returns": "Promise<number>"
    },
    {
      "name": "mettreAJourComplementsBiking",
      "params": [
        "venteId: number"
      ],
      "businessRules": [
        "T19 et T20: Mettre à jour les compléments biking associés à la vente",
        "Synchroniser les informations de location de vélos"
      ],
      "returns": "Promise<void>"
    },
    {
      "name": "verifierEtEnvoyerMail",
      "params": [
        "venteId: number"
      ],
      "businessRules": [
        "T23: Vérifier si une notification email doit être envoyée",
        "Envoyer l'email de confirmation si configuré"
      ],
      "returns": "Promise<void>"
    }
  ],
  "apiEndpoints": [
    {
      "method": "POST",
      "path": "/api/ventes/deversement",
      "queryParams": [],
      "response": "{ success: boolean; operationsDiverses: OperationDiverse[]; numeroTicket?: number }"
    },
    {
      "method": "GET",
      "path": "/api/ventes/:id/od",
      "queryParams": [],
      "response": "OperationDiverse[]"
    },
    {
      "method": "POST",
      "path": "/api/ventes/:id/affectation",
      "queryParams": [],
      "response": "{ success: boolean; transfertId: number }"
    },
    {
      "method": "DELETE",
      "path": "/api/ventes/:id/affectation",
      "queryParams": [],
      "response": "{ success: boolean }"
    },
    {
      "method": "GET",
      "path": "/api/comptes/gm/:societe/:compte",
      "queryParams": [],
      "response": "CompteGM"
    },
    {
      "method": "POST",
      "path": "/api/tickets/increment",
      "queryParams": [
        "type: 'VRL' | 'VSL'"
      ],
      "response": "{ numeroTicket: number }"
    }
  ],
  "uiLayout": {
    "type": "multi-step-process",
    "sections": [
      {
        "name": "deversementForm",
        "controls": [
          "societeField",
          "compteField",
          "filiationField",
          "montantField",
          "annulationCheckbox",
          "typeVenteSelect",
          "deverserButton"
        ]
      },
      {
        "name": "operationsDiversesTable",
        "controls": [
          "odListGrid",
          "typeODColumn",
          "montantColumn",
          "dateColumn"
        ]
      },
      {
        "name": "affectationModal",
        "controls": [
          "affectationInput",
          "confirmerButton",
          "annulerButton"
        ]
      },
      {
        "name": "resultatDeversement",
        "controls": [
          "numeroTicketDisplay",
          "statutMessage",
          "errorDisplay"
        ]
      }
    ]
  },
  "mockData": {
    "count": 5,
    "description": "5 ventes avec déversement simulé - 2 ventes standards, 1 annulation, 1 VRL, 1 VSL - Comptes GM avec soldes variés - 9 OD par vente (types compte, service, statistiques) - Numéros de ticket incrémentés pour VRL/VSL - Affectations de transfert pour 2 ventes - Compléments biking pour 1 vente"
  },
  "dependencies": {
    "stores": [
      "useTransactionStore",
      "useDataSourceStore",
      "usePrintStore"
    ],
    "sharedTypes": [
      "Societe",
      "Compte",
      "Service",
      "MoyenPaiement"
    ],
    "externalApis": [
      "/api/comptes/gm",
      "/api/hebergement",
      "/api/compteurs",
      "/api/notifications/email"
    ]
  }
}