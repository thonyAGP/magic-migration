# SPECMAP Migration Contract
# Generated: 2026-02-11
# Program: ADH IDE 137 - Ticket ouverture session

program:
  id: 137
  name: "Ticket ouverture session"
  complexity: "BASSE"
  callers: [122, 297]
  callees: [43, 179, 181, 182]
  tasks_count: 23
  tables_count: 8
  expressions_count: 10

rules:
  - id: RM-001
    description: "Condition: W0 fin tache egale F"
    condition: "W0 fin tache [V]='F'"
    variables: ["FI (W0 fin tache)"]
    status: N/A
    target_file: ""
    gap_notes: "Internal task control flag - not needed in React print flow"
  - id: RM-002
    description: "Verification que l'imprimante courante est la n1"
    condition: "GetParam ('CURRENTPRINTERNUM')=1"
    variables: []
    status: IMPL
    target_file: "src/services/printer/printService.ts"
    gap_notes: "Printer routing replaced by PrinterChoice: pdf-browser / pdf-download / escpos"
  - id: RM-003
    description: "Verification que l'imprimante courante est la n9"
    condition: "GetParam ('CURRENTPRINTERNUM')=9"
    variables: []
    status: IMPL
    target_file: "src/services/printer/printService.ts"
    gap_notes: "Printer 9 (TMT88IV) mapped to escpos choice in PrinterChoice dialog"

variables:
  # Parameters (9 received from IDE 122)
  - letter: "EN"
    name: "P0 societe"
    type: "Parameter"
    status: IMPL
    target_file: "src/pages/SessionOuverturePage.tsx"
    gap_notes: "Mapped to config.libelle in ticket header.societe"
  - letter: "EO"
    name: "P0 nbre decimales"
    type: "Parameter"
    status: N/A
    target_file: ""
    gap_notes: "Number formatting handled by JS Intl/toFixed"
  - letter: "EP"
    name: "P0 nom village"
    type: "Parameter"
    status: IMPL
    target_file: "src/services/printer/generators/ouvertureTicketGenerator.ts"
    gap_notes: "OuvertureTicketData.village maps this"
  - letter: "EQ"
    name: "P0 masque cumul"
    type: "Parameter"
    status: N/A
    target_file: ""
    gap_notes: "Display mask - handled by JS formatting"
  - letter: "ER"
    name: "P0 devise locale"
    type: "Parameter"
    status: IMPL
    target_file: "src/pages/SessionOuverturePage.tsx"
    gap_notes: "config.devisePrincipale used in ticket generation"
  - letter: "ES"
    name: "P0 Uni/Bilateral"
    type: "Parameter"
    status: N/A
    target_file: ""
    gap_notes: "Backend routing parameter"
  - letter: "ET"
    name: "P0 village TAI"
    type: "Parameter"
    status: N/A
    target_file: ""
    gap_notes: "TAI village code - not used in web version"
  - letter: "EU"
    name: "P0 date comptable"
    type: "Parameter"
    status: IMPL
    target_file: "src/pages/SessionOuverturePage.tsx"
    gap_notes: "dateComptable from caisseStore displayed and used in ticket"
  - letter: "EV"
    name: "P0 session"
    type: "Parameter"
    status: IMPL
    target_file: "src/stores/sessionStore.ts"
    gap_notes: "currentSession.id maps the session number"
  # Work variables (17)
  - letter: "EX"
    name: "W0 caisse depart"
    type: "Virtual"
    status: IMPL
    target_file: "src/pages/SessionOuverturePage.tsx"
    gap_notes: "totalCompte from computeResults() counting aggregation"
  - letter: "EY"
    name: "W0 apport coffre"
    type: "Virtual"
    status: IMPL
    target_file: "src/stores/caisseOpsStore.ts"
    gap_notes: "executeApportCoffre() populates apport via ApportCoffreData.montant"
  - letter: "EZ"
    name: "W0 piece caisse Rec"
    type: "Virtual"
    status: IMPL
    target_file: "src/stores/caisseOpsStore.ts"
    gap_notes: "Piece count tracked in CaisseOpsStore operations"
  - letter: "FA"
    name: "W0 piece caisse Dep"
    type: "Virtual"
    status: IMPL
    target_file: "src/stores/caisseOpsStore.ts"
    gap_notes: "Disbursement piece count tracked in operations"
  - letter: "FB"
    name: "W0 date comptable"
    type: "Virtual"
    status: IMPL
    target_file: "src/pages/SessionOuverturePage.tsx"
    gap_notes: "dateComptable displayed on page"
  - letter: "FC"
    name: "W0 versement"
    type: "Virtual"
    status: IMPL
    target_file: "src/stores/caisseOpsStore.ts"
    gap_notes: "Versement (bank deposit) tracked via executeVersement()"
  - letter: "FD"
    name: "W0 retrait"
    type: "Virtual"
    status: IMPL
    target_file: "src/stores/caisseOpsStore.ts"
    gap_notes: "Retrait (withdrawal) tracked via executeRetrait()"
  - letter: "FE"
    name: "W0 solde cash"
    type: "Virtual"
    status: PARTIAL
    target_file: "src/pages/SessionOuverturePage.tsx"
    gap_notes: "Total cash counted but not broken down by MOP in ouverture ticket"
  - letter: "FF"
    name: "W0 solde carte"
    type: "Virtual"
    status: MISSING
    target_file: ""
    gap_notes: "Card balance not tracked at ouverture"
  - letter: "FG"
    name: "W0 change"
    type: "Virtual"
    status: MISSING
    target_file: ""
    gap_notes: "Exchange rate not computed in ouverture ticket"
  - letter: "FH"
    name: "W0 frais de change"
    type: "Virtual"
    status: MISSING
    target_file: ""
    gap_notes: "Exchange fees not computed in ouverture ticket"
  - letter: "FI"
    name: "W0 fin tache"
    type: "Virtual"
    status: N/A
    target_file: ""
    gap_notes: "Internal task control - not needed in React"
  - letter: "FJ"
    name: "W0 Existe Carnet Bar"
    type: "Virtual"
    status: N/A
    target_file: ""
    gap_notes: "Carnet Bar feature not migrated"
  - letter: "FK"
    name: "W0 Existe TAI"
    type: "Virtual"
    status: N/A
    target_file: ""
    gap_notes: "TAI feature not migrated"
  - letter: "FL"
    name: "W0 titre"
    type: "Virtual"
    status: IMPL
    target_file: "src/services/printer/generators/ouvertureTicketGenerator.ts"
    gap_notes: "Hardcoded as 'OUVERTURE DE CAISSE' in ticket lines"
  - letter: "FM"
    name: "W0 date debut session"
    type: "Virtual"
    status: IMPL
    target_file: "src/pages/SessionOuverturePage.tsx"
    gap_notes: "new Date().toLocaleDateString in ticket header"
  - letter: "FN"
    name: "W0 heure debut session"
    type: "Virtual"
    status: IMPL
    target_file: "src/pages/SessionOuverturePage.tsx"
    gap_notes: "new Date().toLocaleTimeString in ticket header"
  # Other
  - letter: "EW"
    name: "Edition detaillee"
    type: "Virtual"
    status: MISSING
    target_file: ""
    gap_notes: "Detailed edition flag not implemented - ticket always simplified"

tables:
  - id: 463
    name: "heure_de_passage"
    mode: "R"
    status: N/A
    target_file: ""
    gap_notes: "Backend time reference table"
  - id: 693
    name: "devise_in"
    mode: "R"
    status: IMPL
    target_file: "src/stores/sessionStore.ts"
    gap_notes: "Devise info loaded via caisseStore config"
  - id: 266
    name: "cc_comptable"
    mode: "R"
    status: MISSING
    target_file: ""
    gap_notes: "Accounting accumulation table not mapped in frontend"
  - id: 30
    name: "gm-recherche_____gmr"
    mode: "R"
    status: N/A
    target_file: ""
    gap_notes: "Backend search index table"
  - id: 70
    name: "date_comptable___dat"
    mode: "R"
    status: IMPL
    target_file: "src/stores/caisseStore.ts"
    gap_notes: "dateComptable loaded from caisseStore"
  - id: 249
    name: "histo_sessions_caisse_detail"
    mode: "R"
    status: PARTIAL
    target_file: "src/stores/sessionStore.ts"
    gap_notes: "Session history loaded but detail-level amounts limited"
  - id: 513
    name: "pv_invoiceprintfiliationtmp"
    mode: "L"
    status: N/A
    target_file: ""
    gap_notes: "Temp print table - not applicable in web"
  - id: 511
    name: "pv_invoicedisplaytmp"
    mode: "L"
    status: N/A
    target_file: ""
    gap_notes: "Temp display table - not applicable in web"

callees:
  - ide: 43
    name: "Recuperation du titre"
    calls: 1
    context: "Recuperation donnees"
    status: IMPL
    target: "Hardcoded labels in ouvertureTicketGenerator.ts"
    gap_notes: "Title 'OUVERTURE DE CAISSE' hardcoded - no dynamic title lookup needed"
  - ide: 179
    name: "Get Printer"
    calls: 1
    context: "Impression ticket/document"
    status: IMPL
    target: "PrinterChoiceDialog + executePrint()"
    gap_notes: "Printer selection via PrinterChoiceDialog UI replacing Magic GetPrinter call"
  - ide: 181
    name: "Set Listing Number"
    calls: 1
    context: "Configuration impression"
    status: N/A
    target: ""
    gap_notes: "Listing number configuration not applicable in PDF/ESC-POS web printing"
  - ide: 182
    name: "Raz Current Printer"
    calls: 1
    context: "Impression ticket/document"
    status: N/A
    target: ""
    gap_notes: "Printer reset not needed - web print is stateless"

overall:
  rules_total: 3
  rules_impl: 2
  rules_partial: 0
  rules_missing: 0
  rules_na: 1
  variables_key_count: 27
  callees_total: 4
  callees_impl: 2
  callees_missing: 0
  coverage_pct: 58
  status: contracted
  generated: "2026-02-11"
  notes: "IDE 137 generates the ouverture session ticket. The React app has a complete ouverture ticket generator (ouvertureTicketGenerator.ts) with PrinterChoice dialog, but the ticket content is simplified compared to Magic. Missing elements: multi-devise accumulation (change/frais), detailed edition mode, versement/retrait tracking, piece caisse counts, carnet bar / TAI features. The core print flow (generate + choose printer + execute) is fully implemented."
