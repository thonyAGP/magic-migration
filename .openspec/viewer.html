<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenSpec Viewer - Lecteur Magic</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --border: #30363d;
      --accent: #58a6ff;
      --accent-hover: #79b8ff;
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
      --purple: #a371f7;
      --orange: #f0883e;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 340px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow-y: auto;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-tertiary);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .sidebar-header h1 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-header h1::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--success);
      border-radius: 50%;
    }

    .sidebar-header .updated {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .nav-section {
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .nav-section.collapsed .nav-items { display: none; }
    .nav-section.collapsed .nav-section-title .collapse-icon { transform: rotate(-90deg); }

    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      padding: 4px 16px 8px;
      letter-spacing: 0.5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-section-title:hover { color: var(--text-primary); }

    .nav-section-title .collapse-icon {
      font-size: 10px;
      transition: transform 0.2s;
    }

    .nav-section-title .count {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 10px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: auto;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      padding: 10px 16px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      border-left: 3px solid transparent;
      position: relative;
    }

    .nav-item:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--bg-tertiary);
      color: var(--accent);
      border-left-color: var(--accent);
    }

    .nav-item .row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-item .title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 500;
    }

    .nav-item .subtitle {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-item .actions {
      display: none;
      gap: 4px;
    }

    .nav-item:hover .actions { display: flex; }

    .nav-item .action-btn {
      width: 22px;
      height: 22px;
      border: none;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-item .action-btn:hover {
      background: var(--accent);
      color: #000;
    }

    .nav-item .action-btn.archive:hover { background: var(--warning); }
    .nav-item .action-btn.unarchive:hover { background: var(--success); }

    /* Badges */
    .badge {
      font-size: 9px;
      padding: 3px 7px;
      border-radius: 4px;
      background: var(--bg-tertiary);
      text-transform: uppercase;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: 0.3px;
    }

    .badge:hover { filter: brightness(1.2); }

    .badge.resolved { background: var(--success); color: #000; }
    .badge.dev { background: var(--warning); color: #000; }
    .badge.spec { background: var(--purple); color: #fff; }
    .badge.progress { background: var(--accent); color: #000; }
    .badge.rejected { background: var(--danger); color: #fff; }

    /* J+X Badge */
    .days-badge {
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', 'Consolas', monospace;
    }

    .days-badge.fresh { background: var(--success); color: #000; }      /* J+0 to J+2 */
    .days-badge.normal { background: var(--accent); color: #000; }      /* J+3 to J+7 */
    .days-badge.warning { background: var(--orange); color: #000; }     /* J+8 to J+14 */
    .days-badge.old { background: var(--danger); color: #fff; }         /* J+15+ */

    .date-info {
      font-size: 10px;
      color: var(--text-secondary);
      opacity: 0.7;
    }

    .archives-section { opacity: 0.8; }
    .archives-section .nav-item { padding: 8px 16px; }
    .archives-section .nav-item .title { font-size: 12px; }

    /* Status dropdown */
    .status-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      right: 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 4px;
      z-index: 100;
      min-width: 130px;
    }

    .status-dropdown.show { display: block; }

    .status-option {
      display: block;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 4px;
    }

    .status-option:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    /* Save indicator */
    .save-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--success);
      color: #000;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      display: none;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .save-indicator.show { display: flex; align-items: center; gap: 8px; }
    .save-indicator.error { background: var(--danger); color: #fff; }

    /* Main Content */
    .main {
      flex: 1;
      overflow: auto;
      padding: 32px 48px;
    }

    .content {
      max-width: 900px;
      margin: 0 auto;
    }

    /* Typography */
    .content h1 { font-size: 28px; font-weight: 600; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
    .content h2 { font-size: 22px; font-weight: 600; margin: 32px 0 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
    .content h3 { font-size: 18px; font-weight: 600; margin: 24px 0 12px; color: var(--text-primary); }
    .content h4 { font-size: 15px; font-weight: 600; margin: 20px 0 8px; color: var(--text-secondary); }
    .content p { margin: 12px 0; line-height: 1.7; color: var(--text-secondary); }
    .content strong { color: var(--text-primary); }
    .content a { color: var(--accent); text-decoration: none; }
    .content a:hover { text-decoration: underline; }
    .content ul, .content ol { margin: 12px 0; padding-left: 24px; color: var(--text-secondary); }
    .content li { margin: 6px 0; line-height: 1.6; }
    .content hr { border: none; border-top: 1px solid var(--border); margin: 32px 0; }

    /* Tables */
    .content table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 13px; }
    .content th { background: var(--bg-tertiary); font-weight: 600; text-align: left; padding: 10px 12px; border: 1px solid var(--border); color: var(--text-primary); white-space: nowrap; }
    .content td { padding: 10px 12px; border: 1px solid var(--border); color: var(--text-secondary); vertical-align: top; }
    .content tr:hover td { background: var(--bg-secondary); }
    .content td:first-child { color: var(--text-primary); font-weight: 500; }

    /* Code */
    .content code { font-family: 'SF Mono', 'Consolas', 'Monaco', monospace; font-size: 12px; background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; color: var(--accent); }
    .content pre { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; padding: 16px; overflow-x: auto; margin: 16px 0; }
    .content pre code { background: none; padding: 0; color: var(--text-secondary); font-size: 13px; line-height: 1.5; }

    /* Blockquote */
    .content blockquote { border-left: 3px solid var(--accent); padding-left: 16px; margin: 16px 0; color: var(--text-secondary); font-style: italic; }

    /* Welcome */
    .welcome { text-align: center; padding: 64px 32px; }
    .welcome h2 { border: none; color: var(--text-primary); }
    .welcome p { max-width: 400px; margin: 12px auto; }

    /* Loading */
    .loading { text-align: center; padding: 48px; color: var(--text-secondary); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

    /* File tabs */
    .file-tabs { display: flex; gap: 4px; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 8px; flex-wrap: wrap; }
    .file-tab { padding: 6px 12px; font-size: 12px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px 4px 0 0; cursor: pointer; color: var(--text-secondary); }
    .file-tab:hover { color: var(--text-primary); }
    .file-tab.active { background: var(--accent); color: #000; border-color: var(--accent); }
    .file-tab.commits { background: var(--bg-tertiary); border-color: var(--purple); color: var(--purple); }
    .file-tab.commits:hover { background: var(--purple); color: #fff; }
    .file-tab.commits.active { background: var(--purple); color: #fff; }

    /* Ticket header with date/time */
    .ticket-header {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .ticket-header .ticket-id {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }

    .ticket-header .ticket-meta {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .ticket-header .meta-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .ticket-header .meta-label {
      font-size: 10px;
      text-transform: uppercase;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
    }

    .ticket-header .meta-value {
      font-size: 13px;
      color: var(--text-primary);
      font-weight: 500;
    }

    .ticket-header .meta-value.highlight {
      color: var(--success);
      font-family: 'SF Mono', 'Consolas', monospace;
    }

    /* Analysis time in sidebar */
    .analysis-time {
      font-size: 10px;
      color: var(--purple);
      font-family: 'SF Mono', 'Consolas', monospace;
      margin-top: 2px;
    }

    /* Commits panel */
    .commits-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
    }

    .commits-panel h3 {
      margin: 0 0 16px 0;
      font-size: 16px;
      color: var(--purple);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .commit-item {
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 3px solid var(--purple);
    }

    .commit-item .commit-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .commit-item .commit-hash {
      font-family: 'SF Mono', 'Consolas', monospace;
      font-size: 12px;
      color: var(--accent);
      background: var(--bg-primary);
      padding: 2px 8px;
      border-radius: 4px;
    }

    .commit-item .commit-date {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .commit-item .commit-message {
      font-size: 13px;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .commit-item .commit-files {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .commit-item .commit-files code {
      font-size: 10px;
      background: var(--bg-primary);
      padding: 1px 4px;
      border-radius: 3px;
      margin-right: 4px;
    }

    .commits-empty {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .commits-loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .btn-github {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      text-decoration: none;
      font-size: 12px;
      margin-top: 16px;
    }

    .btn-github:hover {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>OpenSpec Viewer</h1>
      <div class="updated" id="lastUpdated"></div>
    </div>
    <div id="navigation"></div>
  </aside>

  <main class="main">
    <div class="content" id="content">
      <div class="welcome">
        <h2>OpenSpec Viewer</h2>
        <p>Selectionnez un document dans la barre laterale.</p>
      </div>
    </div>
  </main>

  <div class="save-indicator" id="saveIndicator">
    <span id="saveText">Sauvegarde...</span>
  </div>

  <script>
    const content = document.getElementById('content');
    const navigation = document.getElementById('navigation');
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const saveIndicator = document.getElementById('saveIndicator');
    const saveText = document.getElementById('saveText');
    let indexData = null;

    marked.setOptions({ breaks: true, gfm: true });

    const STATUSES = [
      { id: 'progress', label: 'En cours' },
      { id: 'spec', label: 'Specification' },
      { id: 'dev', label: 'Developpement' },
      { id: 'resolved', label: 'Resolu' },
      { id: 'rejected', label: 'Rejete/KO' }
    ];

    function getDaysAgo(dateStr) {
      if (!dateStr) return null;
      const date = new Date(dateStr);
      const today = new Date();
      const diffTime = today - date;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
    }

    function getDaysBadgeClass(days) {
      if (days === null) return 'normal';
      if (days <= 2) return 'fresh';
      if (days <= 7) return 'normal';
      if (days <= 14) return 'warning';
      return 'old';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }) +
             ' ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }

    function formatFullDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      }) + ' a ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }

    async function init() {
      try {
        const response = await fetch('index.json?t=' + Date.now());
        indexData = await response.json();
        buildNavigation();
        updateLastUpdated();

        if (window.location.hash) {
          const file = decodeURIComponent(window.location.hash.slice(1));
          loadFile(file);
          setActiveNav(file);
        }
      } catch (err) {
        navigation.innerHTML = '<div style="padding:16px;color:var(--danger)">Erreur: index.json non trouve</div>';
      }
    }

    function updateLastUpdated() {
      const date = new Date(indexData.lastUpdated);
      lastUpdatedEl.textContent = `Maj: ${date.toLocaleDateString('fr-FR')} ${date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'})}`;
    }

    function buildNavigation() {
      let html = '';

      const principal = indexData.reports.filter(r => r.category === 'principal');
      html += buildSection('Principal', principal.map(r => ({ title: r.title, file: r.file })), principal.length);

      const reports = indexData.reports.filter(r => r.category === 'reports');
      html += buildSection('Rapports', reports.map(r => ({ title: r.title, file: r.file })), reports.length);

      html += buildTicketSection('Tickets en cours', indexData.tickets.active, false);
      html += buildTicketSection('Archives', indexData.tickets.archived, true);

      navigation.innerHTML = html;

      // Section collapse
      document.querySelectorAll('.nav-section-title').forEach(title => {
        title.addEventListener('click', (e) => {
          if (e.target.closest('.action-btn')) return;
          title.parentElement.classList.toggle('collapsed');
        });
      });

      // Nav items
      document.querySelectorAll('.nav-item[data-file]').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.closest('.action-btn') || e.target.closest('.badge') || e.target.closest('.status-dropdown')) return;
          const file = item.dataset.file;
          loadFile(file);
          setActiveNav(file);
          window.location.hash = encodeURIComponent(file);
        });
      });

      // Close dropdowns on outside click
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.badge') && !e.target.closest('.status-dropdown')) {
          document.querySelectorAll('.status-dropdown.show').forEach(d => d.classList.remove('show'));
        }
      });
    }

    function buildSection(title, items, count) {
      let html = `<nav class="nav-section">
        <div class="nav-section-title">
          <span class="collapse-icon">â–¼</span>
          ${title}
          <span class="count">${count}</span>
        </div>
        <div class="nav-items">`;
      items.forEach(item => {
        html += `<a class="nav-item" data-file="${item.file}">
          <div class="row"><span class="title">${item.title}</span></div>
        </a>`;
      });
      html += '</div></nav>';
      return html;
    }

    function buildTicketSection(title, tickets, isArchive) {
      const archiveClass = isArchive ? 'archives-section collapsed' : '';
      let html = `<nav class="nav-section ${archiveClass}">
        <div class="nav-section-title">
          <span class="collapse-icon">â–¼</span>
          ${title}
          <span class="count">${tickets.length}</span>
        </div>
        <div class="nav-items">`;

      tickets.forEach(t => {
        const days = getDaysAgo(t.createdDate);
        const daysClass = getDaysBadgeClass(days);
        const daysText = days !== null ? `J+${days}` : '';

        const actionBtn = isArchive
          ? `<button class="action-btn unarchive" onclick="unarchiveTicket('${t.id}')" title="Desarchiver">â†©</button>`
          : `<button class="action-btn archive" onclick="archiveTicket('${t.id}')" title="Archiver">ðŸ“¥</button>`;

        // Use lastAnalysisTime if available, fallback to lastAnalysis
        const analysisTimeStr = t.lastAnalysisTime || t.lastAnalysis;
        const lastAnalysisText = analysisTimeStr ? formatDateTime(analysisTimeStr) : '-';
        const createdText = t.createdDate ? `Cree: ${formatDate(t.createdDate)}` : '';
        const programText = t.program ? `<span class="date-info" style="color: var(--accent);">${t.program}</span>` : '';

        html += `<a class="nav-item" data-file="${t.file}" data-ticket-id="${t.id}">
          <div class="row">
            <span class="title">${t.id}</span>
            ${daysText ? `<span class="days-badge ${daysClass}">${daysText}</span>` : ''}
            <span class="badge ${t.status}" onclick="toggleStatusDropdown(event, '${t.id}')">${t.status}</span>
            <div class="actions">${actionBtn}</div>
          </div>
          <div class="subtitle">
            <span>${t.title}</span>
          </div>
          <div class="subtitle">
            <span class="date-info">${createdText}</span>
            ${programText}
          </div>
          <div class="analysis-time">Analyse: ${lastAnalysisText}</div>
          <div class="status-dropdown" id="dropdown-${t.id}">
            ${STATUSES.map(s => `<div class="status-option" onclick="changeStatus('${t.id}', '${s.id}')">${s.label}</div>`).join('')}
          </div>
        </a>`;
      });

      html += '</div></nav>';
      return html;
    }

    function toggleStatusDropdown(e, ticketId) {
      e.stopPropagation();
      const dropdown = document.getElementById('dropdown-' + ticketId);
      document.querySelectorAll('.status-dropdown.show').forEach(d => {
        if (d !== dropdown) d.classList.remove('show');
      });
      dropdown.classList.toggle('show');
    }

    async function changeStatus(ticketId, newStatus) {
      document.querySelectorAll('.status-dropdown.show').forEach(d => d.classList.remove('show'));
      await callApi('change-status', ticketId, newStatus);
    }

    async function archiveTicket(ticketId) {
      await callApi('archive', ticketId);
    }

    async function unarchiveTicket(ticketId) {
      await callApi('unarchive', ticketId);
    }

    async function callApi(action, ticketId, newStatus = null) {
      saveIndicator.classList.remove('error');
      saveIndicator.classList.add('show');
      saveText.textContent = 'Sauvegarde...';

      try {
        const body = { action, ticketId };
        if (newStatus) body.newStatus = newStatus;

        const response = await fetch('/api/update-ticket', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Erreur API');
        }

        saveText.textContent = 'âœ“ Sauvegarde! Actualisation dans 30s...';

        // Refresh data after a short delay (Vercel redeploys)
        setTimeout(async () => {
          saveIndicator.classList.remove('show');
          // Reload the index
          const newIndex = await fetch('index.json?t=' + Date.now());
          indexData = await newIndex.json();
          buildNavigation();
          updateLastUpdated();
        }, 2000);

      } catch (err) {
        console.error('API Error:', err);
        saveText.textContent = 'âœ— Erreur: ' + err.message;
        saveIndicator.classList.add('error');
        setTimeout(() => {
          saveIndicator.classList.remove('show');
        }, 4000);
      }
    }

    function setActiveNav(file) {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.file === file);
      });
    }

    async function loadFile(path, showCommits = false) {
      content.innerHTML = '<div class="loading">Chargement...</div>';

      const isTicket = path.includes('tickets/');
      let headerHtml = '';
      let tabsHtml = '';
      let ticketId = null;
      let ticketData = null;

      if (isTicket) {
        const ticketDir = path.substring(0, path.lastIndexOf('/') + 1);
        const files = ['analysis.md', 'resolution.md', 'implementation.md', 'notes.md'];
        const currentFile = path.substring(path.lastIndexOf('/') + 1);

        // Extract ticket ID from path
        const match = path.match(/tickets\/([A-Z]+-\d+)\//);
        if (match) {
          ticketId = match[1];
          // Find ticket data in index
          ticketData = [...indexData.tickets.active, ...indexData.tickets.archived]
            .find(t => t.id === ticketId);
        }

        // Build ticket header with date/time
        if (ticketData) {
          const analysisTime = ticketData.lastAnalysisTime || ticketData.lastAnalysis;
          const fullDateTime = formatFullDateTime(analysisTime);
          const jiraUrl = `https://clubmed.atlassian.net/browse/${ticketId}`;

          headerHtml = `
            <div class="ticket-header">
              <div>
                <a href="${jiraUrl}" target="_blank" class="ticket-id">${ticketId}</a>
                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">${ticketData.title}</div>
              </div>
              <div class="ticket-meta">
                <div class="meta-item">
                  <span class="meta-label">Derniere analyse</span>
                  <span class="meta-value highlight">${fullDateTime}</span>
                </div>
                ${ticketData.program ? `
                <div class="meta-item">
                  <span class="meta-label">Programme</span>
                  <span class="meta-value">${ticketData.program}</span>
                </div>` : ''}
                <div class="meta-item">
                  <span class="meta-label">Statut</span>
                  <span class="meta-value">${ticketData.status}</span>
                </div>
              </div>
            </div>`;
        }

        // Build tabs with Commits tab
        tabsHtml = '<div class="file-tabs">';
        for (const f of files) {
          const fullPath = ticketDir + f;
          const active = (f === currentFile && !showCommits) ? 'active' : '';
          const label = f.replace('.md', '');
          tabsHtml += `<div class="file-tab ${active}" onclick="loadFile('${fullPath}'); setActiveNav('${ticketDir}analysis.md')">${label}</div>`;
        }
        // Add Commits tab
        const commitsActive = showCommits ? 'active' : '';
        tabsHtml += `<div class="file-tab commits ${commitsActive}" onclick="loadFile('${ticketDir}analysis.md', true); setActiveNav('${ticketDir}analysis.md')">ðŸ“œ Commits</div>`;
        tabsHtml += '</div>';
      }

      // If showing commits panel
      if (showCommits && ticketId) {
        content.innerHTML = headerHtml + tabsHtml + buildCommitsPanel(ticketId);
        return;
      }

      try {
        const response = await fetch(path + '?t=' + Date.now());
        if (!response.ok) throw new Error('Fichier non trouve');
        const text = await response.text();
        content.innerHTML = headerHtml + tabsHtml + marked.parse(text);
      } catch (err) {
        content.innerHTML = headerHtml + tabsHtml + `<div class="welcome"><h2>Fichier non trouve</h2><p>${path}</p></div>`;
      }
    }

    function buildCommitsPanel(ticketId) {
      // Get commits data from index (if available) or show placeholder
      const ticket = [...indexData.tickets.active, ...indexData.tickets.archived]
        .find(t => t.id === ticketId);

      const commits = ticket?.commits || [];
      const githubUrl = `https://github.com/thonyAGP/lecteur-magic/commits/master/.openspec/tickets/${ticketId}`;

      if (commits.length === 0) {
        return `
          <div class="commits-panel">
            <h3>ðŸ“œ Historique Git</h3>
            <div class="commits-empty">
              <p>Les commits pour ce ticket seront synchronises automatiquement.</p>
              <p style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                En attendant, vous pouvez consulter l'historique sur GitHub :
              </p>
              <a href="${githubUrl}" target="_blank" class="btn-github">
                ðŸ”— Voir sur GitHub
              </a>
            </div>
          </div>`;
      }

      let commitsHtml = commits.map(c => `
        <div class="commit-item">
          <div class="commit-header">
            <span class="commit-hash">${c.hash?.substring(0, 7) || '?'}</span>
            <span class="commit-date">${formatDateTime(c.date)}</span>
          </div>
          <div class="commit-message">${c.message || '-'}</div>
          ${c.files ? `<div class="commit-files">${c.files.map(f => `<code>${f}</code>`).join('')}</div>` : ''}
        </div>
      `).join('');

      return `
        <div class="commits-panel">
          <h3>ðŸ“œ Historique Git (${commits.length} commits)</h3>
          ${commitsHtml}
          <a href="${githubUrl}" target="_blank" class="btn-github">
            ðŸ”— Voir tous les commits sur GitHub
          </a>
        </div>`;
    }

    window.loadFile = loadFile;
    window.setActiveNav = setActiveNav;
    window.archiveTicket = archiveTicket;
    window.unarchiveTicket = unarchiveTicket;
    window.changeStatus = changeStatus;
    window.toggleStatusDropdown = toggleStatusDropdown;

    init();
  </script>
</body>
</html>
