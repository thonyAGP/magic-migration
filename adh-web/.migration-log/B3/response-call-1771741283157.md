```typescript
import { describe, it, expect, beforeEach, vi, afterEach } from 'vitest';
import { useVillageAddressStore } from '@/stores/villageAddressStore';
import { useDataSourceStore } from '@/stores/dataSourceStore';
import { apiClient } from '@/services/api/apiClient';
import type { ApiResponse } from '@/services/api/apiClient';
import type {
  VillageAddress,
  SetVillageAddressResponse,
  GetVillageAddressResponse,
} from '@/types/villageAddress';

vi.mock('@/services/api/apiClient', () => ({
  apiClient: {
    get: vi.fn(),
    put: vi.fn(),
  },
}));

const MOCK_ADDRESS: VillageAddress = {
  clubCode: 'CLUB001',
  name: 'Village Principal',
  address1: '123 Rue de la Paix',
  address2: 'Bâtiment A',
  zipCode: '75001',
  phone: '+33123456789',
  email: 'contact@village.fr',
  siret: '12345678901234',
  vatNumber: 'FR12345678901',
};

const MOCK_ADDRESS_WITH_WHITESPACE: VillageAddress = {
  clubCode: 'CLUB001',
  name: 'Village Principal',
  address1: '123 Rue de la Paix',
  address2: 'Bâtiment A',
  zipCode: '  75001  ',
  phone: '  +33123456789  ',
  email: '  contact@village.fr  ',
  siret: '  12345678901234  ',
  vatNumber: '  FR12345678901  ',
};

const MOCK_ADDRESS_MINIMAL: VillageAddress = {
  clubCode: 'CLUB002',
  name: 'Village Minimal',
  address1: '456 Avenue du Soleil',
  address2: null,
  zipCode: '13001',
  phone: null,
  email: null,
  siret: null,
  vatNumber: null,
};

describe('villageAddressStore', () => {
  beforeEach(() => {
    const initialState = {
      villageAddress: null,
      isLoading: false,
      error: null,
    };
    useVillageAddressStore.setState(initialState, true);
    useDataSourceStore.setState({ isRealApi: false });
    vi.clearAllMocks();
  });

  afterEach(() => {
    vi.restoreAllMocks();
  });

  describe('setVillageAddress', () => {
    it('should set village address in mock mode', async () => {
      const { setVillageAddress } = useVillageAddressStore.getState();

      await setVillageAddress(MOCK_ADDRESS);

      const state = useVillageAddressStore.getState();
      expect(state.villageAddress).toEqual(MOCK_ADDRESS);
      expect(state.isLoading).toBe(false);
      expect(state.error).toBeNull();
    });

    it('should trim whitespace from optional fields in mock mode', async () => {
      const { setVillageAddress } = useVillageAddressStore.getState();

      await setVillageAddress(MOCK_ADDRESS_WITH_WHITESPACE);

      const state = useVillageAddressStore.getState();
      expect(state.villageAddress?.zipCode).toBe('75001');
      expect(state.villageAddress?.phone).toBe('+33123456789');
      expect(state.villageAddress?.email).toBe('contact@village.fr');
      expect(state.villageAddress?.siret).toBe('12345678901234');
      expect(state.villageAddress?.vatNumber).toBe('FR12345678901');
    });

    it('should handle address with null optional fields in mock mode', async () => {
      const { setVillageAddress } = useVillageAddressStore.getState();

      await setVillageAddress(MOCK_ADDRESS_MINIMAL);

      const state = useVillageAddressStore.getState();
      expect(state.villageAddress).toEqual(MOCK_ADDRESS_MINIMAL);
      expect(state.villageAddress?.phone).toBeNull();
      expect(state.villageAddress?.email).toBeNull();
      expect(state.villageAddress?.siret).toBeNull();
      expect(state.villageAddress?.vatNumber).toBeNull();
    });

    it('should set loading state during operation', async () => {
      const { setVillageAddress } = useVillageAddressStore.getState();

      const setStatePromise = new Promise<void>((resolve) => {
        const unsubscribe = useVillageAddressStore.subscribe((state) => {
          if (state.isLoading === true) {
            resolve();
            unsubscribe();
          }
        });
      });

      const promise = setVillageAddress(MOCK_ADDRESS);
      await setStatePromise;

      expect(useVillageAddressStore.getState().isLoading).toBe(true);

      await promise;
      expect(useVillageAddressStore.getState().isLoading).toBe(false);
    });

    it('should set village address via API in real mode', async () => {
      useDataSourceStore.setState({ isRealApi: true });
      vi.mocked(apiClient.put).mockResolvedValueOnce({
        data: {
          success: true,
          data: { success: true, message: 'Adresse mise à jour' },
        },
      } as ApiResponse<SetVillageAddressResponse>);

      const { setVillageAddress } = useVillageAddressStore.getState();
      await setVillageAddress(MOCK_ADDRESS);

      expect(apiClient.put).toHaveBeenCalledWith('/api/village-address', {
        clubCode: 'CLUB001',
        name: 'Village Principal',
        address1: '123 Rue de la Paix',
        address2: 'Bâtiment A',
        zipCode: '75001',
        phone: '+33123456789',
        email: 'contact@village.fr',
        siret: '12345678901234',
        vatNumber: 'FR12345678901',
      });

      const state = useVillageAddressStore.getState();
      expect(state.villageAddress).toEqual(MOCK_ADDRESS);
      expect(state.error).toBeNull();
    });

    it('should trim whitespace before API call in real mode', async () => {
      useDataSourceStore.setState({ isRealApi: true });
      vi.mocked(apiClient.put).mockResolvedValueOnce({
        data: {
          success: true,
          data: { success: true },
        },
      } as ApiResponse<SetVillageAddressResponse>);

      const { setVillageAddress } = useVillageAddressStore.getState();
      await setVillageAddress(MOCK_ADDRESS_WITH_WHITESPACE);

      expect(apiClient.put).toHaveBeenCalledWith(
        '/api/village-address',
        expect.objectContaining({
          zipCode: '75001',
          phone: '+33123456789',
          email: 'contact@village.fr',
          siret: '12345678901234',
          vatNumber: 'FR12345678901',
        }),
      );
    });

    it('should handle null optional fields in API mode', async () => {
      useDataSourceStore.setState({ isRealApi: true });
      vi.mocked(apiClient.put).mockResolvedValueOnce({
        data: {
          success: true,
          data: { success: true },
        },
      } as ApiResponse<SetVillageAddressResponse>);

      const { setVillageAddress } = useVillageAddressStore.getState();
      await setVillageAddress(MOCK_ADDRESS_MINIMAL);

      const payload = vi.mocked(apiClient.put).mock.calls[0][1] as Record<string, unknown>;
      
      expect(payload.clubCode).toBe('CLUB002');
      expect(payload.name).toBe('Village Minimal');
      expect(payload.address1).toBe('456 Avenue du Soleil');
      expect(payload.zipCode).toBe('13001');
      expect(payload.phone).toBeUndefined();
      expect(payload.email).toBeUndefined();
      expect(payload.siret).toBeUndefined();
      expect(payload.vatNumber).toBeUndefined();
    });

    it('should handle API error response', async () => {
      useDataSourceStore.setState({ isRealApi: true });
      vi.mocked(apiClient.put).mockResolvedValueOnce({
        data: {
          success: false,
          error: 'Code club invalide',
        },
      } as ApiResponse<SetVillageAddressResponse>);

      const { setVillageAddress } = useVillageAddressStore.getState();
      await setVillageAddress(MOCK_ADDRESS);

      const state = useVillageAddressStore.getState();
      expect(state.error).toBe('Code club invalide');
      expect(state.villageAddress).toBeNull();
      expect(state.isLoading).toBe(false);
    });

    it('should handle API network error', async () => {
      useDataSourceStore.setState({ isRealApi: true });
      vi.mocked(apiClient.put).mockRejectedValueOnce(
        new Error('Network error'),
      );

      const { setVillageAddress } = useVillageAddressStore.getState();
      await setVillageAddress(MOCK_ADDRESS);

      const state = useVillageAddressStore.getState();
      expect(state.error).toBe('Network error');
      expect(state.isLoading).toBe(false);
    });

    it('should handle unknown error type', async () => {
      useDataSourceStore.setState({ isRealApi: true });
      vi.mocked(apiClient.put).mockRejectedValueOnce('Unknown error');

      const { setVillageAddress } = useVillageAddressStore.getState();
      await setVillageAddress(MOCK_ADDRESS);

      const state = useVillageAddressStore.getState();
      expect(state.error).toBe('Erreur mise à jour adresse');
      expect(state.isLoading).toBe(false);
    });

    it('should clear previous error on new request', async () => {
      useVillageAddressStore.setState({ error: 'Previous error' });

      const { setVillageAddress } = useVillageAddressStore.getState();
      await setVillageAddress(MOCK_ADDRESS);

      const state = useVillageAddressStore.getState();
      expect(state.error).toBeNull();
    });
  });

  describe('loadVillageAddress', () => {
    it('should load mock data in mock mode', async () => {
      const { loadVillageAddress } = useVillageAddressStore.getState();

      const result = await loadVillageAddress();

      expect(result).toBeDefined();
      expect(result?.clubCode).toBe('CLUB001');
      expect(result?.name).toBe('Village Principal');

      const state = useVillageAddressStore.getState();
      expect(state.villageAddress).toEqual(result);
      expect(state.isLoading).toBe(false);
      expect(state.error).toBeNull();
    });

    it('should set loading state during operation', async () => {
      const { loadVillageAddress } = useVillageAddressStore.getState();

      const setStatePromise = new Promise<void>((resolve) => {
        const unsubscribe = useVillageAddressStore.subscribe((state) => {
          if (state.isLoading === true) {
            resolve();
            unsubscribe();
          }
        });
      });

      const promise = loadVillageAddress();
      await setStatePromise;

      expect(useVillageAddressStore.getState().isLoading).toBe(true);

      await promise;
      expect(useVillageAddressStore.getState().isLoading).toBe(false);
    });

    it('should load data from API in real mode', async () => {
      useDataSourceStore.setState({ isRealApi: true });
      const apiResponse: GetVillageAddressResponse = {
        ...MOCK_ADDRESS,
        retrievedAt: '2026-02-21T10:00:00Z',
      };
      vi.mocked(apiClient.get).mockResolvedValueOnce({
        data: {
          success: true,
          data: apiResponse,
        },
      } as ApiResponse<GetVillageAddressResponse>);

      const { loadVillageAddress } = useVillageAddressStore.getState();
      const result = await loadVillageAddress();

      expect(apiClient.get).toHaveBeenCalledWith('/api/village-address');
      expect(result).toEqual(MOCK_ADDRESS);

      const state = useVillageAddressStore.getState();
      expect(state.villageAddress).toEqual(MOCK_ADDRESS);
      expect(state.error).toBeNull();
    });

    it('should handle API error response', async () => {
      useDataSourceStore.setState({ isRealApi: true });
      vi.mocked(apiClient.get).mockResolvedValueOnce({
        data: {
          success: false,
          error: 'Adresse non trouvée',
        },
      } as ApiResponse<GetVillageAddressResponse>);

      const { loadVillageAddress } = useVillageAddressStore.getState();
      const result = await loadVillageAddress();

      expect(result).toBeNull();

      const state = useVillageAddressStore.getState();
      expect(state.error).toBe('Adresse non trouvée');
      expect(state.villageAddress).toBeNull();
      expect(state.isLoading).toBe(false);
    });

    it('should handle missing data in API response', async () => {
      useDataSourceStore.setState({ isRealApi: true });
      vi.mocked(apiClient.get).mockResolvedValueOnce({
        data: {
          success: true,
          data: null,
        },
      } as unknown as ApiResponse<GetVillageAddressResponse>);

      const { loadVillageAddress } = useVillageAddressStore.getState();
      const result = await loadVillageAddress();

      expect(result).toBeNull();

      const state = useVillageAddressStore.getState();
      expect(state.error).toBe('Aucune adresse village trouvée');
      expect(state.isLoading).toBe(false);
    });

    it('should handle API network error', async () => {
      useDataSourceStore.setState({ isRealApi: true });
      vi.mocked(apiClient.get).mockRejectedValueOnce(
        new Error('Connection timeout'),
      );

      const { loadVillageAddress } = useVillageAddressStore.getState();
      const result = await loadVillageAddress();

      expect(result).toBeNull();

      const state = useVillageAddressStore.getState();
      expect(state.error).toBe('Connection timeout');
      expect(state.isLoading).toBe(false);
    });

    it('should handle unknown error type', async () => {
      useDataSourceStore.setState({ isRealApi: true });
      vi.mocked(apiClient.get).mockRejectedValueOnce('Unknown error');

      const { loadVillageAddress } = useVillageAddressStore.getState();
      const result = await loadVillageAddress();

      expect(result).toBeNull();

      const state = useVillageAddressStore.getState();
      expect(state.error).toBe('Erreur chargement adresse');
      expect(state.isLoading).toBe(false);
    });

    it('should clear previous error on new request', async () => {
      useVillageAddressStore.setState({ error: 'Previous error' });

      const { loadVillageAddress } = useVillageAddressStore.getState();
      await loadVillageAddress();

      const stateAfter = useVillageAddressStore.getState();
      expect(stateAfter.error).toBeNull();
    });
  });

  describe('clearError', () => {
    it('should clear error state', () => {
      useVillageAddressStore.setState({ error: 'Test error' });

      const { clearError } = useVillageAddressStore.getState();
      clearError();

      const state = useVillageAddressStore.getState();
      expect(state.error).toBeNull();
    });

    it('should not affect other state properties', () => {
      useVillageAddressStore.setState({
        villageAddress: MOCK_ADDRESS,
        error: 'Test error',
        isLoading: true,
      });

      const { clearError } = useVillageAddressStore.getState();
      clearError();

      const state = useVillageAddressStore.getState();
      expect(state.error).toBeNull();
      expect(state.villageAddress).toEqual(MOCK_ADDRESS);
      expect(state.isLoading).toBe(true);
    });
  });

  describe('reset', () => {
    it('should reset store to initial state', () => {
      useVillageAddressStore.setState({
        villageAddress: MOCK_ADDRESS,
        isLoading: true,
        error: 'Test error',
      });

      const { reset } = useVillageAddressStore.getState();
      reset();

      const state = useVillageAddressStore.getState();
      expect(state.villageAddress).toBeNull();
      expect(state.isLoading).toBe(false);
      expect(state.error).toBeNull();
    });
  });
});
```