You are a software architect producing a design document for migrating a Magic Unipaas program to React/TypeScript.

Produce a JSON document following this EXACT structure:
```json
{
  "domain": "camelCaseDomainName",
  "domainPascal": "PascalCaseDomainName",
  "complexity": "LOW|MEDIUM|HIGH",
  "entities": [
    {
      "name": "EntityName",
      "fields": [
        {
          "name": "fieldName",
          "type": "string|number|boolean|Date",
          "source": "table.column",
          "nullable": false
        }
      ]
    }
  ],
  "stateFields": [
    {
      "name": "fieldName",
      "type": "TypeName[]",
      "default": "[]"
    }
  ],
  "actions": [
    {
      "name": "actionName",
      "params": [
        "param: type"
      ],
      "businessRules": [
        "Rule description"
      ],
      "returns": "Promise<void>"
    }
  ],
  "apiEndpoints": [
    {
      "method": "GET",
      "path": "/api/domain/resource",
      "queryParams": [
        "param?"
      ],
      "response": "ResponseType"
    }
  ],
  "uiLayout": {
    "type": "page-type",
    "sections": [
      {
        "name": "sectionName",
        "controls": [
          "control1"
        ]
      }
    ]
  },
  "mockData": {
    "count": 5,
    "description": "Description of mock data"
  },
  "dependencies": {
    "stores": [
      "useDataSourceStore"
    ],
    "sharedTypes": [],
    "externalApis": []
  }
}
```

IMPORTANT:
- Derive entity fields from actual DB column types when DB metadata is available
- Each business rule from the spec/contract MUST map to an action
- API endpoints should follow existing patterns: /api/{domain}/{resource}
- State fields must cover ALL data the UI needs to display
- Include isLoading, error, and filter states

PROGRAM SPEC:
﻿# ADH IDE 247 - Deversement Transaction

> **Analyse**: Phases 1-4 2026-01-30 09:43 -> 09:43 (8s) | Assemblage 09:43
> **Pipeline**: V7.2 Enrichi
> **Structure**: 4 onglets (Resume | Ecrans | Donnees | Connexions)

<!-- TAB:Resume -->

## 1. FICHE D'IDENTITE

| Attribut | Valeur |
|----------|--------|
| Projet | ADH |
| IDE Position | 247 |
| Nom Programme | Deversement Transaction |
| Fichier source | `Prg_247.xml` |
| Domaine metier | Ventes |
| Taches | 25 (3 ecrans visibles) |
| Tables modifiees | 11 |
| Programmes appeles | 1 |

## 2. DESCRIPTION FONCTIONNELLE

**Deversement Transaction** est le **moteur de comptabilisation des ventes** qui **transforme une vente validee en ecritures comptables et met a jour toutes les tables transactionnelles**.

**Objectif metier** : Effectuer le deversement comptable apres validation d'une vente. Ce programme critique (25 taches, 1467 lignes, 30 tables dont 11 en ecriture) cree les OD (operations diverses), met a jour les comptes GM, l'hebergement, les ventes, les statistiques et les compteurs. Il gere egalement les cas d'annulation, les ventes VRL/VSL, les affectations de transfert et les complements biking. C'est le coeur du traitement comptable post-vente.

Ce programme est accessible depuis [Histo ventes payantes /PMS-623 (IDE 245)](ADH-IDE-245.md), [Transaction Nouv vente avec GP (IDE 237)](ADH-IDE-237.md), [Transaction Nouv vente PMS-584 (IDE 238)](ADH-IDE-238.md), [Transaction Nouv vente PMS-721 (IDE 239)](ADH-IDE-239.md), [Transaction Nouv vente PMS-710 (IDE 240)](ADH-IDE-240.md), [Histo ventes payantes (IDE 243)](ADH-IDE-243.md), [Histo ventes payantes /PMS-605 (IDE 244)](ADH-IDE-244.md), [Histo ventes Gratuités (IDE 253)](ADH-IDE-253.md), [Ventes Gratuites (IDE 305)](ADH-IDE-305.md), [Saisie transaction 154  N.U (IDE 307)](ADH-IDE-307.md), [Saisie transaction Nouv vente (IDE 310)](ADH-IDE-310.md), [Historique des ventes - Gratui (IDE 312)](ADH-IDE-312.md), [Ventes Gratuites (IDE 315)](ADH-IDE-315.md), [Historique des ventes P247 (IDE 318)](ADH-IDE-318.md), [Annulation Ventes Gratuites (IDE 319)](ADH-IDE-319.md).

Le flux de traitement s'organise en **5 blocs fonctionnels** :

- **Traitement** (10 taches) : traitements metier divers
- **Creation** (9 taches) : insertion d'enregistrements en base (mouvements, prestations)
- **Saisie** (4 taches) : ecrans de saisie utilisateur (formulaires, champs, donnees)
- **Transfert** (1 tache) : transferts de donnees entre modules ou deversements
- **Impression** (1 tache) : generation de tickets et documents

**Donnees modifiees** : 11 tables en ecriture (hebergement______heb, comptable_gratuite, compte_gm________cgm, compteurs________cpt, vente, vente_gratuite, comptage_caisse, valeur_credit_bar_defaut, Boo_ResultsRechercheHoraire, Table_1033, Table_1069).

**Logique metier** : 3 regles identifiees couvrant conditions metier.

<details>
<summary>Detail : phases du traitement</summary>

#### Phase 1 : Saisie (4 taches)

- **T1** - Deversement Transaction **[ECRAN]**
- **T11** - Vente VRL VSL
- **T12** - Compte ligne vente
- **T24** - create vente_assurance

#### Phase 2 : Creation (9 taches)

- **T2** - Creation d'un O.D
- **T3** - Creation d'un O.D
- **T4** - Creation d'un O.D
- **T5** - Creation d'un O.D
- **T7** - Creation d'un O.D
- **T8** - Creation d'un O.D
- **T9** - Creation d'un O.D
- **T14** - Creation d'un O.D
- **T16** - Creation Enregistrement Transf **[ECRAN]**

#### Phase 3 : Traitement (10 taches)

- **T6** - Maj Service
- **T10** - Maj Service
- **T15** - Affectation **[ECRAN]**
- **T17** - Maj hebergement Z
- **T19** - Màj compléments biking
- **T20** - Màj compléments biking
- **T21** - Maj LCO liberation
- **T22** - Maj heure liberation
- **T23** - check mail
- **T25** - (sans nom)

#### Phase 4 : Impression (1 tache)

- **T13** - Increment Num. Ticket(VRL/VSL)

#### Phase 5 : Transfert (1 tache)

- **T18** - Raz Affectation Transfert

#### Tables impactees

| Table | Operations | Role metier |
|-------|-----------|-------------|
| vente | R/**W**/L (5 usages) | Donnees de ventes |
| vente_gratuite | **W**/L (4 usages) | Donnees de ventes |
| hebergement______heb | **W**/L (3 usages) | Hebergement (chambres) |
| comptable_gratuite | **W**/L (3 usages) |  |
| Table_1033 | **W** (2 usages) |  |
| compte_gm________cgm | **W** (2 usages) | Comptes GM (generaux) |
| Boo_ResultsRechercheHoraire | R/**W** (2 usages) | Index de recherche |
| Table_1069 | **W** (1 usages) |  |
| comptage_caisse | **W** (1 usages) | Sessions de caisse |
| valeur_credit_bar_defaut | **W** (1 usages) |  |
| compteurs________cpt | **W** (1 usages) | Comptes GM (generaux) |

</details>

## 3. BLOCS FONCTIONNELS

### 3.1 Saisie (4 taches)

L'operateur saisit les donnees de la transaction via 1 ecran (Deversement Transaction).

---

#### <a id="t1"></a>T1 - Deversement Transaction [ECRAN]

**Role** : Ecran de saisie pour la transaction.
**Ecran** : 646 x 548 DLU (MDI) | [Voir mockup](#ecran-t1)

---

#### <a id="t11"></a>T11 - Vente VRL VSL

**Role** : Ecran de saisie pour la transaction.

---

#### <a id="t12"></a>T12 - Compte ligne vente

**Role** : Ecran de saisie pour la transaction.

---

#### <a id="t24"></a>T24 - create vente_assurance

**Role** : Ecran de saisie pour la transaction.


### 3.2 Creation (9 taches)

Insertion de nouveaux enregistrements en base.

---

#### <a id="t2"></a>T2 - Creation d'un O.D

**Role** : Insertion de donnees en base.

---

#### <a id="t3"></a>T3 - Creation d'un O.D

**Role** : Insertion de donnees en base.

---

#### <a id="t4"></a>T4 - Creation d'un O.D

**Role** : Insertion de donnees en base.

---

#### <a id="t5"></a>T5 - Creation d'un O.D

**Role** : Insertion de donnees en base.

---

#### <a id="t7"></a>T7 - Creation d'un O.D

**Role** : Insertion de donnees en base.

---

#### <a id="t8"></a>T8 - Creation d'un O.D

**Role** : Insertion de donnees en base.

---

#### <a id="t9"></a>T9 - Creation d'un O.D

**Role** : Insertion de donnees en base.

---

#### <a id="t14"></a>T14 - Creation d'un O.D

**Role** : Insertion de donnees en base.

---

#### <a id="t16"></a>T16 - Creation Enregistrement Transf [ECRAN]

**Role** : Insertion de donnees en base.
**Ecran** : 672 x 58 DLU | [Voir mockup](#ecran-t16)


### 3.3 Traitement (10 taches)

Traitements internes.

---

#### <a id="t6"></a>T6 - Maj Service

**Role** : Traitement interne.

---

#### <a id="t10"></a>T10 - Maj Service

**Role** : Traitement interne.

---

#### <a id="t15"></a>T15 - Affectation [ECRAN]

**Role** : Traitement interne.
**Ecran** : 584 x 253 DLU | [Voir mockup](#ecran-t15)

---

#### <a id="t17"></a>T17 - Maj hebergement Z

**Role** : Traitement interne.

---

#### <a id="t19"></a>T19 - Màj compléments biking

**Role** : Traitement interne.

---

#### <a id="t20"></a>T20 - Màj compléments biking

**Role** : Traitement interne.

---

#### <a id="t21"></a>T21 - Maj LCO liberation

**Role** : Traitement interne.

---

#### <a id="t22"></a>T22 - Maj heure liberation

**Role** : Traitement interne.

---

#### <a id="t23"></a>T23 - check mail

**Role** : Traitement interne.

---

#### <a id="t25"></a>T25 - (sans nom)

**Role** : Traitement interne.


### 3.4 Impression (1 tache)

Generation des documents et tickets.

---

#### <a id="t13"></a>T13 - Increment Num. Ticket(VRL/VSL)

**Role** : Generation de ticket ou document.


### 3.5 Transfert (1 tache)

Transfert de donnees entre modules.

---

#### <a id="t18"></a>T18 - Raz Affectation Transfert

**Role** : Transfert de donnees vers un autre module.


## 5. REGLES METIER

3 regles identifiees:

### Autres (3 regles)

#### <a id="rm-RM-001"></a>[RM-001] Si Trim([AA])='OD' alors 'OD' sinon '')

| Element | Detail |
|---------|--------|
| **Condition** | `IF(Trim([AA])='OD','OD','')` |
| **Action** | Si Trim([AA])='OD' alors 'OD' sinon '') |

#### <a id="rm-RM-002"></a>[RM-002] Si p.Annulation [B]='O' alors [EG]+(ABS([AZ])) sinon [EG]-(ABS([AZ])))

| Element | Detail |
|---------|--------|
| **Condition** | `IF(p.

CONTRACT:
{
  "program": {
    "id": 0,
    "name": "",
    "complexity": "MEDIUM",
    "callers": [],
    "callees": [],
    "tasksCount": 25,
    "tablesCount": 11,
    "expressionsCount": 69
  },
  "rules": [
    {
      "id": "RM-001",
      "description": "Si Trim([AA])='OD' alors 'OD' sinon '')",
      "condition": "IF(Trim([AA])='OD','OD','')",
      "variables": [
        "B"
      ],
      "status": "IMPL",
      "targetFile": "adh-web/src/stores/saisieContenuCaisseStore.ts",
      "gapNotes": ""
    },
    {
      "id": "RM-002",
      "description": "Si p.Annulation [B]='O' alors [EG]+(ABS([AZ])) sinon [EG]-(ABS([AZ])))",
      "condition": "IF(p.Annulation [B]='O',[EG]+(ABS([AZ])),[EG]-(ABS([AZ])))",
      "variables": [
        "B"
      ],
      "status": "IMPL",
      "targetFile": "adh-web/src/services/printer/generators/ouvertureTicketGenerator.ts",
      "gapNotes": ""
    },
    {
      "id": "RM-003",
      "description": "Si [CN] alors [CQ] sinon v0.Date Encaissement [BC])",
      "condition": "IF([CN],[CQ],v0.Date Encaissement [BC])",
      "variables": [
        "BC"
      ],
      "status": "IMPL",
      "targetFile": "adh-web/src/types/calculEquivalent.ts",
      "gapNotes": ""
    }
  ],
  "tables": [
    {
      "id": 26,
      "name": "comptes_speciaux_spc",
      "mode": "R",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 30,
      "name": "gm-recherche_____gmr",
      "mode": "R",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 31,
      "name": "gm-complet_______gmc",
      "mode": "R",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 34,
      "name": "hebergement______heb",
      "mode": "W",
      "status": "IMPL",
      "targetFile": "adh-web/src/components/caisse/facture/FactureForm.tsx",
      "gapNotes": ""
    },
    {
      "id": 38,
      "name": "comptable_gratuite",
      "mode": "W",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 40,
      "name": "comptable________cte",
      "mode": "R",
      "status": "IMPL",
      "targetFile": "adh-web/src/components/caisse/recapWorksheet/FiltresPanel.tsx",
      "gapNotes": ""
    },
    {
      "id": 47,
      "name": "compte_gm________cgm",
      "mode": "W",
      "status": "IMPL",
      "targetFile": "adh-web/src/components/caisse/transaction/TransactionForm.tsx",
      "gapNotes": ""
    },
    {
      "id": 65,
      "name": "comptes_recette__cre",
      "mode": "R",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 67,
      "name": "tables___________tab",
      "mode": "R",
      "status": "IMPL",
      "targetFile": "adh-web/src/pages/IntegriteDatesPage.tsx",
      "gapNotes": ""
    },
    {
      "id": 68,
      "name": "compteurs________cpt",
      "mode": "W",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 77,
      "name": "articles_________art",
      "mode": "R",
      "status": "IMPL",
      "targetFile": "adh-web/src/components/caisse/apportArticles/ArticleEntryPanel.tsx",
      "gapNotes": ""
    },
    {
      "id": 89,
      "name": "moyen_paiement___mop",
      "mode": "R",
      "status": "IMPL",
      "targetFile": "adh-web/src/components/caisse/datacatch/DataCatchCompletion.tsx",
      "gapNotes": ""
    },
    {
      "id": 113,
      "name": "tables_village",
      "mode": "R",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 263,
      "name": "vente",
      "mode": "RW",
      "status": "IMPL",
      "targetFile": "adh-web/src/App.tsx",
      "gapNotes": ""
    },
    {
      "id": 264,
      "name": "vente_gratuite",
      "mode": "W",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 268,
      "name": "cc_total_par_type",
      "mode": "R",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 271,
      "name": "cc_total",
      "mode": "R",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 382,
      "name": "pv_discount_reasons",
      "mode": "R",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 473,
      "name": "comptage_caisse",
      "mode": "W",
      "status": "IMPL",
      "targetFile": "adh-web/src/pages/CaisseMenuPage.tsx",
      "gapNotes": ""
    },
    {
      "id": 596,
      "name": "tempo_ecran_police",
      "mode": "R",
      "status": "N/A",
      "targetFile": "",
      "gapNotes": "Legacy-only (memory/temp table)"
    },
    {
      "id": 804,
      "name": "valeur_credit_bar_defaut",
      "mode": "W",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 839,
      "name": "##_pv_compta_dat",
      "mode": "R",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 847,
      "name": "stat_lieu_vente_date",
      "mode": "R",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 899,
      "name": "Boo_ResultsRechercheHoraire",
      "mode": "RW",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 933,
      "name": "taxe_add_vente",
      "mode": "R",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "id": 945,
      "name": "Table_945",
      "mode": "R",
      "status": "N/A",
      "targetFile": "",
      "gapNotes": "Legacy-only (memory/temp table)"
    },
    {
      "id": 980,
      "name": "Table_980",
      "mode": "R",
      "status": "N/A",
      "targetFile": "",
      "gapNotes": "Legacy-only (memory/temp table)"
    },
    {
      "id": 1033,
      "name": "Table_1033",
      "mode": "W",
      "status": "N/A",
      "targetFile": "",
      "gapNotes": "Legacy-only (memory/temp table)"
    },
    {
      "id": 1037,
      "name": "Table_1037",
      "mode": "R",
      "status": "N/A",
      "targetFile": "",
      "gapNotes": "Legacy-only (memory/temp table)"
    },
    {
      "id": 1069,
      "name": "Table_1069",
      "mode": "W",
      "status": "N/A",
      "targetFile": "",
      "gapNotes": "Legacy-only (memory/temp table)"
    }
  ],
  "callees": [
    {
      "id": 249,
      "name": "Reinit Aff PYR",
      "calls": 1,
      "context": "Reinitialisation",
      "status": "MISSING",
      "target": "",
      "gapNotes": ""
    }
  ],
  "variables": [
    {
      "localId": "B",
      "name": "p.Annulation",
      "type": "Real",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    },
    {
      "localId": "BC",
      "name": "v0.Date Encaissement",
      "type": "Real",
      "status": "MISSING",
      "targetFile": "",
      "gapNotes": ""
    }
  ]
}