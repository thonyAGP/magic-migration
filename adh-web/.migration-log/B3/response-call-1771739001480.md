```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';

const mockStore = {
  sessionId: null as number | null,
  deviseCode: null as string | null,
  caisseComptee: 0,
  soldePrecedent: 0,
  montantEcart: 0,
  commentaire: '',
  commentaireDevise: '',
  isLoading: false,
  error: null as string | null,
  ecartSaved: false,
  seuilAlerte: 50,
  calculerEcart: vi.fn(),
  validerSeuilEcart: vi.fn(() => ({ exceeded: false, blocking: false })),
  sauvegarderEcart: vi.fn(),
  setSessionId: vi.fn((value: number) => { mockStore.sessionId = value; }),
  setDeviseCode: vi.fn((value: string) => { mockStore.deviseCode = value; }),
  setCaisseComptee: vi.fn((value: number) => { mockStore.caisseComptee = value; }),
  setSoldePrecedent: vi.fn((value: number) => { mockStore.soldePrecedent = value; }),
  setCommentaire: vi.fn((value: string) => { mockStore.commentaire = value; }),
  setCommentaireDevise: vi.fn((value: string) => { mockStore.commentaireDevise = value; }),
  setSeuilAlerte: vi.fn((value: number) => { mockStore.seuilAlerte = value; }),
  setError: vi.fn((value: string | null) => { mockStore.error = value; }),
  reset: vi.fn(),
};

vi.mock('@/stores/sessionEcartStore', () => ({
  useSessionEcartStore: (selector: (state: typeof mockStore) => unknown) => selector(mockStore),
}));

vi.mock('@/components/layout', () => ({
  ScreenLayout: ({ children }: { children: React.ReactNode }) => <div data-testid="screen-layout">{children}</div>,
}));

vi.mock('@/components/ui', () => ({
  Button: ({ children, onClick, disabled, variant }: { children: React.ReactNode; onClick?: () => void; disabled?: boolean; variant?: string }) => (
    <button data-testid={`button-${variant || 'default'}`} onClick={onClick} disabled={disabled}>{children}</button>
  ),
  Dialog: ({ children, open, title, onClose }: { children: React.ReactNode; open: boolean; title: string; onClose?: () => void }) => (
    open ? <div data-testid="dialog" role="dialog"><h2>{title}</h2>{children}<button onClick={onClose}>Close Dialog</button></div> : null
  ),
  Input: ({ value, onChange, id, type, placeholder, autoFocus }: { value: string; onChange: (e: { target: { value: string } }) => void; id: string; type?: string; placeholder?: string; autoFocus?: boolean }) => (
    <input data-testid={id} type={type} value={value} onChange={onChange} placeholder={placeholder} autoFocus={autoFocus} />
  ),
}));

vi.mock('@/lib/utils', () => ({
  cn: (...args: unknown[]) => args.filter(Boolean).join(' '),
}));

import { SessionEcartPage } from '@/pages/SessionEcartPage';

describe('SessionEcartPage', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    mockStore.sessionId = null;
    mockStore.deviseCode = null;
    mockStore.caisseComptee = 0;
    mockStore.soldePrecedent = 0;
    mockStore.montantEcart = 0;
    mockStore.commentaire = '';
    mockStore.commentaireDevise = '';
    mockStore.isLoading = false;
    mockStore.error = null;
    mockStore.ecartSaved = false;
    mockStore.seuilAlerte = 50;
    mockStore.validerSeuilEcart = vi.fn(() => ({ exceeded: false, blocking: false }));
  });

  it('renders without crashing', () => {
    render(<SessionEcartPage />);
    expect(screen.getByTestId('screen-layout')).toBeInTheDocument();
    expect(screen.getByText('Saisie des écarts de caisse')).toBeInTheDocument();
  });

  it('initializes session data on mount', () => {
    render(<SessionEcartPage />);
    expect(mockStore.setSessionId).toHaveBeenCalledWith(1);
    expect(mockStore.setDeviseCode).toHaveBeenCalledWith('EUR');
    expect(mockStore.setSoldePrecedent).toHaveBeenCalledWith(1250.75);
    expect(mockStore.setSeuilAlerte).toHaveBeenCalledWith(50);
  });

  it('displays loading state when isLoading is true', () => {
    mockStore.isLoading = true;
    render(<SessionEcartPage />);
    expect(screen.getByText('Enregistrement...')).toBeInTheDocument();
  });

  it('displays error message when error exists', () => {
    mockStore.error = 'Une erreur est survenue';
    render(<SessionEcartPage />);
    expect(screen.getByText('Une erreur est survenue')).toBeInTheDocument();
  });

  it('displays success message when ecart is saved', () => {
    mockStore.ecartSaved = true;
    render(<SessionEcartPage />);
    expect(screen.getByText('Écart sauvegardé avec succès')).toBeInTheDocument();
  });

  it('displays devise and solde precedent data', () => {
    mockStore.deviseCode = 'EUR';
    mockStore.soldePrecedent = 1250.75;
    render(<SessionEcartPage />);
    expect(screen.getByText('EUR')).toBeInTheDocument();
    expect(screen.getByText('1250.75 EUR')).toBeInTheDocument();
  });

  it('displays caisse comptee when set', () => {
    mockStore.deviseCode = 'EUR';
    mockStore.caisseComptee = 1200.50;
    render(<SessionEcartPage />);
    expect(screen.getByText('1200.50 EUR')).toBeInTheDocument();
  });

  it('opens dialog when clicking nouvelle saisie button', () => {
    mockStore.soldePrecedent = 1250.75;
    render(<SessionEcartPage />);
    const nouvelleButton = screen.getByText('Nouvelle saisie');
    fireEvent.click(nouvelleButton);
    expect(screen.getByTestId('dialog')).toBeInTheDocument();
    expect(screen.getByText('Saisie caisse comptée')).toBeInTheDocument();
  });

  it('handles dialog form submission', () => {
    mockStore.soldePrecedent = 1250.75;
    render(<SessionEcartPage />);
    fireEvent.click(screen.getByText('Nouvelle saisie'));
    
    const caisseInput = screen.getByTestId('tempCaisseComptee');
    fireEvent.change(caisseInput, { target: { value: '1200.50' } });
    
    const calculerButton = screen.getByText('Calculer l\'écart');
    fireEvent.click(calculerButton);
    
    expect(mockStore.setCaisseComptee).toHaveBeenCalledWith(1200.50);
    expect(mockStore.calculerEcart).toHaveBeenCalledWith(1200.50, 1250.75);
  });

  it('updates commentaire when typing', () => {
    render(<SessionEcartPage />);
    const commentaireTextarea = screen.getByPlaceholderText('Optionnel');
    fireEvent.change(commentaireTextarea, { target: { value: 'Test commentaire' } });
    expect(mockStore.setCommentaire).toHaveBeenCalledWith('Test commentaire');
  });

  it('updates commentaire devise when typing', () => {
    render(<SessionEcartPage />);
    const commentaireDeviseTextarea = screen.getByPlaceholderText('Notes supplémentaires sur la devise');
    fireEvent.change(commentaireDeviseTextarea, { target: { value: 'Notes devise' } });
    expect(mockStore.setCommentaireDevise).toHaveBeenCalledWith('Notes devise');
  });

  it('displays alert when ecart exceeds threshold', () => {
    mockStore.montantEcart = 100;
    mockStore.seuilAlerte = 50;
    mockStore.deviseCode = 'EUR';
    mockStore.validerSeuilEcart = vi.fn(() => ({ exceeded: true, blocking: false }));
    render(<SessionEcartPage />);
    expect(screen.getByText(/L'écart dépasse le seuil d'alerte/)).toBeInTheDocument();
  });

  it('displays blocking alert when ecart is blocking', () => {
    mockStore.montantEcart = 200;
    mockStore.seuilAlerte = 50;
    mockStore.deviseCode = 'EUR';
    mockStore.validerSeuilEcart = vi.fn(() => ({ exceeded: true, blocking: true }));
    render(<SessionEcartPage />);
    expect(screen.getByText(/Écart bloquant détecté/)).toBeInTheDocument();
  });

  it('validates and saves ecart when clicking valider button', async () => {
    mockStore.sessionId = 1;
    mockStore.deviseCode = 'EUR';
    mockStore.caisseComptee = 1200.50;
    mockStore.montantEcart = -50.25;
    mockStore.commentaire = 'Test commentaire';
    mockStore.sauvegarderEcart = vi.fn().mockResolvedValue(undefined);
    
    render(<SessionEcartPage />);
    const validerButton = screen.getByText('Valider l\'écart');
    fireEvent.click(validerButton);
    
    await waitFor(() => {
      expect(mockStore.validerSeuilEcart).toHaveBeenCalled();
      expect(mockStore.sauvegarderEcart).toHaveBeenCalledWith({
        sessionId: 1,
        deviseCode: 'EUR',
        quand: 'F',
        caisseComptee: 1200.50,
        montantEcart: -50.25,
        commentaire: 'Test commentaire',
        commentaireDevise: null,
      });
    });
  });

  it('shows error when validating without session or devise', () => {
    mockStore.sessionId = null;
    mockStore.deviseCode = null;
    render(<SessionEcartPage />);
    const validerButton = screen.getByText('Valider l\'écart');
    fireEvent.click(validerButton);
    
    expect(mockStore.setError).toHaveBeenCalledWith('Session ou devise manquante');
  });

  it('requires commentaire when ecart exceeds threshold', () => {
    mockStore.sessionId = 1;
    mockStore.deviseCode = 'EUR';
    mockStore.caisseComptee = 1200;
    mockStore.montantEcart = 100;
    mockStore.commentaire = '';
    mockStore.validerSeuilEcart = vi.fn(() => ({ exceeded: true, blocking: false }));
    
    render(<SessionEcartPage />);
    const validerButton = screen.getByText('Valider l\'écart');
    fireEvent.click(validerButton);
    
    expect(mockStore.setError).toHaveBeenCalledWith('Un commentaire est obligatoire pour un écart supérieur au seuil');
  });

  it('disables valider button when caisse comptee is 0', () => {
    mockStore.caisseComptee = 0;
    render(<SessionEcartPage />);
    const validerButton = screen.getByText('Valider l\'écart') as HTMLButtonElement;
    expect(validerButton.disabled).toBe(true);
  });

  it('resets store on unmount', () => {
    const { unmount } = render(<SessionEcartPage />);
    unmount();
    expect(mockStore.reset).toHaveBeenCalled();
  });

  it('closes dialog when clicking annuler', () => {
    mockStore.soldePrecedent = 1250.75;
    render(<SessionEcartPage />);
    fireEvent.click(screen.getByText('Nouvelle saisie'));
    expect(screen.getByTestId('dialog')).toBeInTheDocument();
    
    fireEvent.click(screen.getByText('Annuler'));
    expect(screen.queryByTestId('dialog')).not.toBeInTheDocument();
  });
});
```