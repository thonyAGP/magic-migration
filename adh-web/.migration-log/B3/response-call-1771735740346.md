```tsx
import { useState, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { ScreenLayout } from '@/components/layout';
import { Button, Dialog, Input } from '@/components/ui';
import { useFacturationAppelStore } from '@/stores/facturationAppelStore';
import { useAuthStore } from '@/stores';
import type { HistoriqueAppel, FacturationRequest } from '@/types/facturationAppel';
import { cn } from '@/lib/utils';

export const FacturationAppelPage = () => {
  const navigate = useNavigate();
  const user = useAuthStore((s) => s.user);

  const historiqueAppels = useFacturationAppelStore((s) => s.historiqueAppels);
  const coefficientTelephone = useFacturationAppelStore((s) => s.coefficientTelephone);
  const cloture = useFacturationAppelStore((s) => s.cloture);
  const isLoading = useFacturationAppelStore((s) => s.isLoading);
  const error = useFacturationAppelStore((s) => s.error);
  const filterSociete = useFacturationAppelStore((s) => s.filterSociete);
  const filterDateDebut = useFacturationAppelStore((s) => s.filterDateDebut);
  const filterDateFin = useFacturationAppelStore((s) => s.filterDateFin);

  const chargerHistoriqueAppels = useFacturationAppelStore((s) => s.chargerHistoriqueAppels);
  const recupererCoefficient = useFacturationAppelStore((s) => s.recupererCoefficient);
  const facturerAppel = useFacturationAppelStore((s) => s.facturerAppel);
  const verifierCloture = useFacturationAppelStore((s) => s.verifierCloture);
  const debloquerCloture = useFacturationAppelStore((s) => s.debloquerCloture);
  const marquerGratuit = useFacturationAppelStore((s) => s.marquerGratuit);
  const annulerFacturation = useFacturationAppelStore((s) => s.annulerFacturation);
  const setFilterSociete = useFacturationAppelStore((s) => s.setFilterSociete);
  const setFilterDateDebut = useFacturationAppelStore((s) => s.setFilterDateDebut);
  const setFilterDateFin = useFacturationAppelStore((s) => s.setFilterDateFin);
  const resetFilters = useFacturationAppelStore((s) => s.resetFilters);
  const reset = useFacturationAppelStore((s) => s.reset);

  const [selectedAppel, setSelectedAppel] = useState<HistoriqueAppel | null>(null);
  const [showFacturationDialog, setShowFacturationDialog] = useState(false);
  const [showGratuitDialog, setShowGratuitDialog] = useState(false);
  const [showAnnulerDialog, setShowAnnulerDialog] = useState(false);
  const [showDebloquerDialog, setShowDebloquerDialog] = useState(false);

  const [prefixe, setPrefixe] = useState('CAI01');
  const [numeroCompte, setNumeroCompte] = useState('');
  const [filiation, setFiliation] = useState('');
  const [raisonGratuite, setRaisonGratuite] = useState('');

  useEffect(() => {
    recupererCoefficient();
    verifierCloture();
    return () => reset();
  }, [recupererCoefficient, verifierCloture, reset]);

  const handleRechercher = useCallback(() => {
    if (!filterSociete || !prefixe) return;
    chargerHistoriqueAppels(
      filterSociete,
      prefixe,
      filterDateDebut ?? undefined,
      filterDateFin ?? undefined,
    );
  }, [filterSociete, prefixe, filterDateDebut, filterDateFin, chargerHistoriqueAppels]);

  const handleFacturer = useCallback(async () => {
    if (!selectedAppel || !numeroCompte || !filiation) return;

    const clotureActif = await verifierCloture();
    if (clotureActif) {
      setShowDebloquerDialog(true);
      return;
    }

    const request: FacturationRequest = {
      appel: selectedAppel,
      numeroCompte: parseInt(numeroCompte, 10),
      filiation: parseInt(filiation, 10),
      typeCompte: 'GO',
    };

    await facturerAppel(request);
    setShowFacturationDialog(false);
    setSelectedAppel(null);
    handleRechercher();
  }, [selectedAppel, numeroCompte, filiation, facturerAppel, verifierCloture, handleRechercher]);

  const handleMarquerGratuit = useCallback(async () => {
    if (!selectedAppel?.id || !raisonGratuite) return;
    await marquerGratuit(selectedAppel.id, raisonGratuite);
    setShowGratuitDialog(false);
    setSelectedAppel(null);
    setRaisonGratuite('');
    handleRechercher();
  }, [selectedAppel, raisonGratuite, marquerGratuit, handleRechercher]);

  const handleAnnulerFacturation = useCallback(async () => {
    if (!selectedAppel?.id) return;
    await annulerFacturation(selectedAppel.id);
    setShowAnnulerDialog(false);
    setSelectedAppel(null);
    handleRechercher();
  }, [selectedAppel, annulerFacturation, handleRechercher]);

  const handleDebloquer = useCallback(async () => {
    await debloquerCloture();
    setShowDebloquerDialog(false);
    handleFacturer();
  }, [debloquerCloture, handleFacturer]);

  const formatDuree = (duree: string) => {
    const [h, m, s] = duree.split(':');
    return `${h}h${m}m${s}s`;
  };

  const formatDate = (date: Date) => {
    return new Intl.DateTimeFormat('fr-FR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
    }).format(date);
  };

  return (
    <ScreenLayout>
      <div className="space-y-6 max-w-6xl mx-auto">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-xl font-semibold">Facturation appels téléphoniques</h2>
            <p className="text-on-surface-muted text-sm mt-1">
              Consultation et facturation des appels téléphoniques
            </p>
          </div>
          {user && (
            <span className="text-xs text-on-surface-muted">
              {user.prenom} {user.nom}
            </span>
          )}
        </div>

        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md text-sm">
            {error}
          </div>
        )}

        {cloture?.cloture_enCours && (
          <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-md text-sm">
            ⚠️ Réseau en cours de clôture - Facturation bloquée
          </div>
        )}

        <div className="bg-surface border border-border rounded-lg p-4 space-y-4">
          <h3 className="font-medium text-sm">Filtres de recherche</h3>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-1">Société</label>
              <Input
                value={filterSociete}
                onChange={(e) => setFilterSociete(e.target.value)}
                placeholder="Code société"
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Préfixe caisse</label>
              <Input
                value={prefixe}
                onChange={(e) => setPrefixe(e.target.value)}
                placeholder="CAI01"
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Date début</label>
              <Input
                type="date"
                value={filterDateDebut ? filterDateDebut.toISOString().split('T')[0] : ''}
                onChange={(e) =>
                  setFilterDateDebut(e.target.value ? new Date(e.target.value) : null)
                }
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Date fin</label>
              <Input
                type="date"
                value={filterDateFin ? filterDateFin.toISOString().split('T')[0] : ''}
                onChange={(e) => setFilterDateFin(e.target.value ? new Date(e.target.value) : null)}
              />
            </div>
          </div>
          <div className="flex gap-3">
            <Button onClick={handleRechercher} disabled={isLoading || !filterSociete || !prefixe}>
              {isLoading ? 'Recherche...' : 'Rechercher'}
            </Button>
            <Button onClick={resetFilters} variant="outline">
              Réinitialiser
            </Button>
          </div>
        </div>

        {coefficientTelephone !== null && (
          <div className="bg-blue-50 border border-blue-200 px-4 py-2 rounded-md text-sm">
            <span className="font-medium">Coefficient appliqué:</span> {coefficientTelephone}
          </div>
        )}

        <div className="bg-surface border border-border rounded-lg overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-surface-hover border-b border-border">
                <tr>
                  <th className="text-left px-4 py-3 font-medium">Date</th>
                  <th className="text-left px-4 py-3 font-medium">Heure</th>
                  <th className="text-left px-4 py-3 font-medium">Numéro</th>
                  <th className="text-left px-4 py-3 font-medium">Durée</th>
                  <th className="text-right px-4 py-3 font-medium">Montant</th>
                  <th className="text-left px-4 py-3 font-medium">Qualité</th>
                  <th className="text-center px-4 py-3 font-medium">Gratuit</th>
                  <th className="text-center px-4 py-3 font-medium">Facturé</th>
                  <th className="text-center px-4 py-3 font-medium">Actions</th>
                </tr>
              </thead>
              <tbody>
                {isLoading ? (
                  <tr>
                    <td colSpan={9} className="text-center py-8 text-on-surface-muted">
                      Chargement...
                    </td>
                  </tr>
                ) : historiqueAppels.length === 0 ? (
                  <tr>
                    <td colSpan={9} className="text-center py-8 text-on-surface-muted">
                      Aucun appel trouvé
                    </td>
                  </tr>
                ) : (
                  historiqueAppels.map((appel) => (
                    <tr
                      key={appel.id}
                      className={cn(
                        'border-b border-border hover:bg-surface-hover cursor-pointer',
                        selectedAppel?.id === appel.id && 'bg-primary/10',
                      )}
                      onClick={() => setSelectedAppel(appel)}
                    >
                      <td className="px-4 py-3">{formatDate(appel.dateAppel)}</td>
                      <td className="px-4 py-3">{appel.heureAppel}</td>
                      <td className="px-4 py-3 font-mono text-xs">{appel.numeroTel}</td>
                      <td className="px-4 py-3">{formatDuree(appel.duree)}</td>
                      <td className="px-4 py-3 text-right font-medium">
                        {appel.montant.toFixed(2)} €
                      </td>
                      <td className="px-4 py-3">
                        <span
                          className={cn(
                            'px-2 py-1 rounded-full text-xs',
                            appel.qualite === 'OK' && 'bg-green-100 text-green-800',
                            appel.qualite === 'Mauvaise' && 'bg-red-100 text-red-800',
                            appel.qualite === 'Interruption' && 'bg-yellow-100 text-yellow-800',
                          )}
                        >
                          {appel.qualite ?? '-'}
                        </span>
                      </td>
                      <td className="px-4 py-3 text-center">
                        {appel.gratuite ? (
                          <span className="text-green-600">✓</span>
                        ) : (
                          <span className="text-on-surface-muted">-</span>
                        )}
                      </td>
                      <td className="px-4 py-3 text-center">
                        {appel.facture ? (
                          <span className="text-blue-600">✓</span>
                        ) : (
                          <span className="text-on-surface-muted">-</span>
                        )}
                      </td>
                      <td className="px-4 py-3 text-center">
                        <div className="flex gap-1 justify-center">
                          {!appel.facture && !appel.gratuite && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setSelectedAppel(appel);
                                setShowFacturationDialog(true);
                              }}
                              className="px-2 py-1 bg-primary text-white rounded text-xs hover:bg-primary-dark"
                            >
                              Facturer
                            </button>
                          )}
                          {appel.facture && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setSelectedAppel(appel);
                                setShowAnnulerDialog(true);
                              }}
                              className="px-2 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700"
                            >
                              Annuler
                            </button>
                          )}
                          {!appel.gratuite && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                setSelectedAppel(appel);
                                setShowGratuitDialog(true);
                              }}
                              className="px-2 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700"
                            >
                              Gratuit
                            </button>
                          )}
                        </div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {selectedAppel && (
          <div className="bg-surface border border-border rounded-lg p-4 space-y-3">
            <h3 className="font-medium text-sm">Détails de l'appel sélectionné</h3>
            <div className="grid grid-cols-3 gap-4 text-sm">
              <div>
                <span className="text-on-surface-muted">Société:</span>{' '}
                <span className="font-medium">{selectedAppel.societe}</span>
              </div>
              <div>
                <span className="text-on-surface-muted">Préfixe:</span>{' '}
                <span className="font-medium">{selectedAppel.prefixe}</span>
              </div>
              <div>
                <span className="text-on-surface-muted">Numéro:</span>{' '}
                <span className="font-mono text-xs">{selectedAppel.numeroTel}</span>
              </div>
              <div>
                <span className="text-on-surface-muted">Durée:</span>{' '}
                <span className="font-medium">{formatDuree(selectedAppel.duree)}</span>
              </div>
              <div>
                <span className="text-on-surface-muted">Montant:</span>{' '}
                <span className="font-medium">{selectedAppel.montant.toFixed(2)} €</span>
              </div>
              {selectedAppel.raisonGratuite && (
                <div className="col-span-3">
                  <span className="text-on-surface-muted">Raison gratuite:</span>{' '}
                  <span className="font-medium">{selectedAppel.raisonGratuite}</span>
                </div>
              )}
            </div>
          </div>
        )}

        <div className="flex justify-start">
          <Button onClick={() => navigate('/caisse/menu')} variant="outline">
            Retour au menu
          </Button>
        </div>

        <Dialog open={showFacturationDialog} onClose={() => setShowFacturationDialog(false)}>
          <div className="space-y-4">
            <h3 className="text-lg font-semibold">Facturer l'appel</h3>
            <div className="space-y-3">
              <div>
                <label className="block text-sm font-medium mb-1">Numéro de compte</label>
                <Input
                  value={numeroCompte}
                  onChange={(e) => setNumeroCompte(e.target.value)}
                  placeholder="12345"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Filiation</label>
                <Input
                  value={filiation}
                  onChange={(e) => setFiliation(e.target.value)}
                  placeholder="1"
                />
              </div>
            </div>
            <div className="flex gap-3 justify-end">
              <Button onClick={() => setShowFacturationDialog(false)} variant="outline">
                Annuler
              </Button>
              <Button onClick={handleFacturer} disabled={!numeroCompte || !filiation}>
                Facturer
              </Button>
            </div>
          </div>
        </Dialog>

        <Dialog open={showGratuitDialog} onClose={() => setShowGratuitDialog(false)}>
          <div className="space-y-4">
            <h3 className="text-lg font-semibold">Marquer comme gratuit</h3>
            <div>
              <label className="block text-sm font-medium mb-1">Raison</label>
              <Input
                value={raisonGratuite}
                onChange={(e) => setRaisonGratuite(e.target.value)}
                placeholder="Appel urgence médicale, etc."
              />
            </div>
            <div className="flex gap-3 justify-end">
              <Button onClick={() => setShowGratuitDialog(false)} variant="outline">
                Annuler
              </Button>
              <Button onClick={handleMarquerGratuit} disabled={!raisonGratuite}>
                Confirmer
              </Button>
            </div>
          </div>
        </Dialog>

        <Dialog open={showAnnulerDialog} onClose={() => setShowAnnulerDialog(false)}>
          <div className="space-y-4">
            <h3 className="text-lg font-semibold">Annuler la facturation</h3>
            <p className="text-sm text-on-surface-muted">
              Êtes-vous sûr de vouloir annuler la facturation de cet appel ?
            </p>
            <div className="flex gap-3 justify-end">
              <Button onClick={() => setShowAnnulerDialog(false)} variant="outline">
                Non
              </Button>
              <Button onClick={handleAnnulerFacturation} variant="danger">
                Oui, annuler
              </Button>
            </div>
          </div>
        </Dialog>

        <Dialog open={showDebloquerDialog} onClose={() => setShowDebloquerDialog(false)}>
          <div className="space-y-4">
            <h3 className="text-lg font-semibold">Réseau en clôture</h3>
            <p className="text-sm text-on-surface-muted">
              Le réseau est actuellement en cours de clôture. Voulez-vous débloquer pour facturer
              cet appel ?
            </p>
            <div className="flex gap-3 justify-end">
              <Button onClick={() => setShowDebloquerDialog(false)} variant="outline">
                Annuler
              </Button>
              <Button onClick={handleDebloquer}>Débloquer et facturer</Button>
            </div>
          </div>
        </Dialog>
      </div>
    </ScreenLayout>
  );
};
```