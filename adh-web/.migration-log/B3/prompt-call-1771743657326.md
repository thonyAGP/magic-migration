Review the generated code against the original specification.

Produce a JSON report:
```json
{
  "programId": 0,
  "programName": "",
  "coveragePct": 0,
  "rulesImplemented": 0,
  "rulesTotal": 0,
  "missingRules": [
    "rule descriptions not implemented"
  ],
  "recommendations": [
    "improvement suggestions"
  ]
}
```

Check:
1. Every business rule from the contract is implemented in the store
2. Every table from the contract has corresponding entity types
3. Every API endpoint is wired to the store
4. UI layout matches the spec description
5. Error handling is present for all actions

CONTRACT RULES:
[
  {
    "id": "RM-001",
    "description": "Si Trim([AA])='OD' alors 'OD' sinon '')",
    "condition": "IF(Trim([AA])='OD','OD','')",
    "variables": [
      "B"
    ],
    "status": "IMPL",
    "targetFile": "adh-web/src/stores/saisieContenuCaisseStore.ts",
    "gapNotes": ""
  },
  {
    "id": "RM-002",
    "description": "Si p.Annulation [B]='O' alors [EG]+(ABS([AZ])) sinon [EG]-(ABS([AZ])))",
    "condition": "IF(p.Annulation [B]='O',[EG]+(ABS([AZ])),[EG]-(ABS([AZ])))",
    "variables": [
      "B"
    ],
    "status": "IMPL",
    "targetFile": "adh-web/src/services/printer/generators/ouvertureTicketGenerator.ts",
    "gapNotes": ""
  },
  {
    "id": "RM-003",
    "description": "Si [CN] alors [CQ] sinon v0.Date Encaissement [BC])",
    "condition": "IF([CN],[CQ],v0.Date Encaissement [BC])",
    "variables": [
      "BC"
    ],
    "status": "IMPL",
    "targetFile": "adh-web/src/types/calculEquivalent.ts",
    "gapNotes": ""
  }
]

SPEC EXCERPT:
﻿# ADH IDE 247 - Deversement Transaction

> **Analyse**: Phases 1-4 2026-01-30 09:43 -> 09:43 (8s) | Assemblage 09:43
> **Pipeline**: V7.2 Enrichi
> **Structure**: 4 onglets (Resume | Ecrans | Donnees | Connexions)

<!-- TAB:Resume -->

## 1. FICHE D'IDENTITE

| Attribut | Valeur |
|----------|--------|
| Projet | ADH |
| IDE Position | 247 |
| Nom Programme | Deversement Transaction |
| Fichier source | `Prg_247.xml` |
| Domaine metier | Ventes |
| Taches | 25 (3 ecrans visibles) |
| Tables modifiees | 11 |
| Programmes appeles | 1 |

## 2. DESCRIPTION FONCTIONNELLE

**Deversement Transaction** est le **moteur de comptabilisation des ventes** qui **transforme une vente validee en ecritures comptables et met a jour toutes les tables transactionnelles**.

**Objectif metier** : Effectuer le deversement comptable apres validation d'une vente. Ce programme critique (25 taches, 1467 lignes, 30 tables dont 11 en ecriture) cree les OD (operations diverses), met a jour les comptes GM, l'hebergement, les ventes, les statistiques et les compteurs. Il gere egalement les cas d'annulation, les ventes VRL/VSL, les affectations de transfert et les complements biking. C'est le coeur du traitement comptable post-vente.

Ce programme est accessible depuis [Histo ventes payantes /PMS-623 (IDE 245)](ADH-IDE-245.md), [Transaction Nouv vente avec GP (IDE 237)](ADH-IDE-237.md), [Transaction Nouv vente PMS-584 (IDE 238)](ADH-IDE-238.md), [Transaction Nouv vente PMS-721 (IDE 239)](ADH-IDE-239.md), [Transaction Nouv vente PMS-710 (IDE 240)](ADH-IDE-240.md), [Histo ventes payantes (IDE 243)](ADH-IDE-243.md), [Histo ventes payantes /PMS-605 (IDE 244)](ADH-IDE-244.md), [Histo ventes Gratuités (IDE 253)](ADH-IDE-253.md), [Ventes Gratuites (IDE 305)](ADH-IDE-305.md), [Saisie transaction 154  N.U (IDE 307)](ADH-IDE-307.md), [Saisie transaction Nouv vente (IDE 310)](ADH-IDE-310.md), [Historique des ventes - Gratui (IDE 312)](ADH-IDE-312.md), [Ventes Gratuites (IDE 315)](ADH-IDE-315.md), [Historique des ventes P247 (IDE 318)](ADH-IDE-318.md), [Annulation Ventes Gratuites (IDE 319)](ADH-IDE-319.md).

Le flux de traitement s'organise en **5 blocs fonctionnels** :

- **Traitement** (10 taches) : traitements metier divers
- **Creation** (9 taches) : insertion d'enregistrements en base (mouvements, prestations)
- **Saisie** (4 taches) : ecrans de saisie utilisateur (formulaires, champs, donnees)
- **Transfert** (1 tache) : transferts de donnees entre modules ou deversements
- **Impression** (1 tache) : generation de tickets et documents

**Donnees modifiees** : 11 tables en ecriture (hebergement______heb, comptable_gratuite, compte_gm________cgm, compteurs________cpt, vente, vente_gratuite, comptage_caisse, valeur_credit_bar_defaut, Boo_ResultsRechercheHoraire, Table_1033, Table_1069).

**Logique metier** : 3 regles identifiees couvrant conditions metier.

<details>
<summary>Detail : phases du traitement</summary>

#### Phase 1 : Saisie (4 taches)

- **T1** - Deversement Transaction **[ECRAN]**
- **T11** - Vente VRL VSL
- **T12** - Compte ligne vente
- **T24** - create vente_assurance

#### Phase 2 : Creation (9 taches)

- **T2** - Creation d'un O.D
- **T3** - Creation d'un O.D
- **T4** - Creation d'un O.D
- **T5** - Creation d'un O.D
- **T7** - Creation d'un O.D
- **T8** - Creation d'un O.D
- **T9** - Creation d'un O.D
- **T14** - Creation d'un O.D
- **T16** - Creation Enregistrement Transf **[ECRAN]**

#### Phase 3 : Traitement (10 taches)

- **T6** - Maj Service
- **T10** - Maj Service
- **T15** - Affectation **[ECRAN]**
- **T17** - Maj hebergement Z
- **T19** - Màj compléments biking
- **T20** - Màj compléments biking
- **T21** - Maj LCO liberation
- **T22** - Maj heure liberation
- **T23** - check mail
- **T25** - (sans nom)

#### Phase 4 : Impression (1 tache)

- **T13** - Increment Num. Ticket(VRL/VSL)

#### Phase 5 : Transfert (1 tache)

- **T18** - Raz Affectation Transfert

#### Tables impactees

| Table | Operations | Role metier |
|-------|-----------|-------------|
| vente | R/**W**/L (5 usages) | Donnees de ventes |
| vente_gratuite | **W**/L (4 usages) | Donnees de ventes |
| hebergement______heb | **W**/L (3 usages) | Hebergement (chambres) |
| comptable_gratuite | **W**/L (3 usages) |  |
| Table_1033 | **W** (2 usages) |  |
| compte_gm________cgm | **W** (2 usages) | Comptes GM (generaux) |
| Boo_ResultsRechercheHoraire | R/**W** (2 usages) | Index de recherche |
| Table_1069 | **W** (1 usages) |  |
| comptage_caisse | **W** (1 usages) | Sessions de caisse |
| valeur_credit_bar_defaut | **W** (1 usages) |  |
| compteurs________cpt | **W** (1 usages) | Comptes GM (generaux) |

</details>

## 3. BLOCS FONCTIONNELS

### 3.1 Saisie (4 taches)

L'operateur saisit les donnees de la transaction via 1 ecran (Deversement Transaction).

---

#### <a id="t1"></a>T1 - Deversement Transaction [ECRAN]

**Role** : Ecran de saisie pour la transaction.
**Ecran** : 646 x 548 DLU (MDI) | [Voir mockup](#ecran-t1)

---

#### <a id="t11"></a>T11 - Ve

GENERATED FILES:

--- types/deversementTransaction.ts ---
import type { ApiResponse } from "@/services/api/apiClient";

export type VenteType = 'standard' | 'VRL' | 'VSL' | 'OD';
export type HebergementStatut = 'actif' | 'libere' | 'bloque' | 'termine';
export type OperationDiverseType = 'compte' | 'service' | 'statistiques' | 'biking' | 'lco';

export interface Vente {
  id: number;
  societe: string;
  compte: string;
  filiation: number;
  dateEncaissement: Date | null;
  montant: number;
  annulation: boolean;
  typeVente: VenteType | null;
  modePaiement?: string;
  operateur?: string;
}

export interface OperationDiverse {
  id: number;
  societe: string;
  compte: string;
  typeOD: OperationDiverseType;
  montant: number;
  dateOperation: Date;
  description?: string;
}

export interface CompteGM {
  societe: string;
  compte: string;
  solde: number;
  dateMAJ: Date;
}

export interface Hebergement {
  societe: string;
  compte: string;
  chambre: string | null;
  dateDebut: Date | null;
  dateFin: Date | null;
  statut: HebergementStatut | null;
}

export interface TransfertAffectation {
  id: number;
  venteId: number;
  affectation: string | null;
  dateTransfert: Date;
}

export interface ComplementBiking {
  id: number;
  venteId: number;
  typeVelo: string;
  quantite: number;
  dateRetour: Date | null;
}

export interface DeversementResult {
  success: boolean;
  venteId: number;
  operationsDiverses: OperationDiverse[];
  numeroTicket?: number;
  compteGMAncienSolde: number;
  compteGMNouveauSolde: number;
  transfertAffectationId?: number;
}

export interface DeverserVenteRequest {
  venteId: number;
  annulation: boolean;
  affectation?: string;
}

export interface DeverserVenteResponse extends ApiResponse<DeversementResult> {}

export interface AffecterTransfertRequest {
  venteId: number;
  affectation: string;
}

export interface AffecterTransfertResponse extends ApiResponse<{ success: boolean; transfertId: number }> {}

export interface RazAffectationRequest {
  venteId: number;
}

export interface Ra

--- stores/deversementTransactionStore.ts ---
import { create } from 'zustand';
import type {
  Vente,
  OperationDiverse,
  CompteGM,
  Hebergement,
  TransfertAffectation,
  ComplementBiking,
  DeversementResult,
  DeverserVenteRequest,
  DeverserVenteResponse,
  AffecterTransfertRequest,
  AffecterTransfertResponse,
  RazAffectationRequest,
  RazAffectationResponse,
  IncrementNumeroTicketRequest,
  IncrementNumeroTicketResponse,
  GetCompteGMRequest,
  GetCompteGMResponse,
  GetOperationsDiversesRequest,
  GetOperationsDiversesResponse,
  VenteType,
  HebergementStatut,
  OperationDiverseType,
  DeversementState,
  DeversementActions,
} from '@/types/deversementTransaction';
import { apiClient } from '@/services/api/apiClient';
import type { ApiResponse } from '@/services/api/apiClient';
import { useDataSourceStore } from '@/stores/dataSourceStore';

type DeversementStore = DeversementState & DeversementActions;

const MOCK_VENTES: Vente[] = [
  {
    id: 1,
    societe: 'SOC1',
    compte: 'C1001',
    filiation: 0,
    dateEncaissement: new Date('2026-02-20T10:30:00'),
    montant: 150.00,
    annulation: false,
    typeVente: 'standard',
    modePaiement: 'CB',
    operateur: 'MARTIN S.',
  },
  {
    id: 2,
    societe: 'SOC1',
    compte: 'C1002',
    filiation: 1,
    dateEncaissement: new Date('2026-02-20T11:15:00'),
    montant: 75.50,
    annulation: true,
    typeVente: 'standard',
    modePaiement: 'Especes',
    operateur: 'DUPONT J.',
  },
  {
    id: 3,
    societe: 'SOC1',
    compte: 'C1003',
    filiation: 0,
    dateEncaissement: new Date('2026-02-20T14:00:00'),
    montant: 220.00,
    annulation: false,
    typeVente: 'VRL',
    modePaiement: 'CB',
    operateur: 'BERNARD L.',
  },
  {
    id: 4,
    societe: 'SOC2',
    compte: 'C2001',
    filiation: 2,
    dateEncaissement: new Date('2026-02-20T16:45:00'),
    montant: 185.75,
    annulation: false,
    typeVente: 'VSL',
    modePaiement: 'Virement',
    operateur: 'MARTIN S.',
  },
  {
    id: 5,
    societe: 'SOC2',
    compte: 'C20

--- services/api/endpoints-deversementTransaction.ts ---
import { apiClient, type ApiResponse } from "@/services/api/apiClient";
import type {
  Vente,
  OperationDiverse,
  CompteGM,
  Hebergement,
  TransfertAffectation,
  ComplementBiking,
  DeversementResult,
  DeverserVenteRequest,
  AffecterTransfertRequest,
  RazAffectationRequest,
  IncrementNumeroTicketRequest,
  GetCompteGMRequest,
  GetOperationsDiversesRequest,
  OperationDiverseType,
} from "@/types/deversementTransaction";

export const deversementApi = {
  // POST /api/ventes/deversement - Créer un déversement de vente
  deverserVente: (data: DeverserVenteRequest) =>
    apiClient.post<
      ApiResponse<{
        success: boolean;
        operationsDiverses: OperationDiverse[];
        numeroTicket?: number;
      }>
    >("/api/ventes/deversement", data),

  // GET /api/ventes/:id/od - Récupérer les opérations diverses d'une vente
  getOperationsDiverses: (venteId: number) =>
    apiClient.get<ApiResponse<OperationDiverse[]>>(
      `/api/ventes/${venteId}/od`,
    ),

  // POST /api/ventes/:id/affectation - Affecter un transfert à une vente
  affecterTransfert: (venteId: number, data: AffecterTransfertRequest) =>
    apiClient.post<ApiResponse<{ success: boolean; transfertId: number }>>(
      `/api/ventes/${venteId}/affectation`,
      data,
    ),

  // DELETE /api/ventes/:id/affectation - Supprimer l'affectation d'une vente
  razAffectation: (venteId: number, data: RazAffectationRequest) =>
    apiClient.delete<ApiResponse<{ success: boolean }>>(
      `/api/ventes/${venteId}/affectation`,
    ),

  // GET /api/comptes/gm/:societe/:compte - Récupérer les informations du compte GM
  getCompteGM: (societe: string, compte: string) =>
    apiClient.get<ApiResponse<CompteGM>>(
      `/api/comptes/gm/${societe}/${compte}`,
    ),

  // POST /api/tickets/increment - Incrémenter le numéro de ticket
  incrementerNumeroTicket: (typeVente: "VRL" | "VSL") =>
    apiClient.post<ApiResponse<{ numeroTicket: number }>>(
      `/api/tickets/increment?type=${typeVente}

--- pages/DeversementTransactionPage.tsx ---
import { useState, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { ScreenLayout } from '@/components/layout';
import { Button, Dialog, Input } from '@/components/ui';
import { useDeversementTransactionStore } from '@/stores/deversementTransactionStore';
import { useAuthStore } from '@/stores';
import { cn } from '@/lib/utils';
import type { Vente, OperationDiverse, VenteType, OperationDiverseType } from '@/types/deversementTransaction';

type Phase = 'form' | 'result';

export function DeversementTransactionPage() {
  const navigate = useNavigate();
  const user = useAuthStore((s) => s.user);

  const vente = useDeversementTransactionStore((s) => s.vente);
  const operationsDiverses = useDeversementTransactionStore((s) => s.operationsDiverses);
  const compteGM = useDeversementTransactionStore((s) => s.compteGM);
  const hebergement = useDeversementTransactionStore((s) => s.hebergement);
  const transfertAffectation = useDeversementTransactionStore((s) => s.transfertAffectation);
  const isProcessing = useDeversementTransactionStore((s) => s.isProcessing);
  const error = useDeversementTransactionStore((s) => s.error);
  const affectationTransfert = useDeversementTransactionStore((s) => s.affectationTransfert);
  const showAffectationModal = useDeversementTransactionStore((s) => s.showAffectationModal);
  const numeroTicket = useDeversementTransactionStore((s) => s.numeroTicket);
  const venteVrlVsl = useDeversementTransactionStore((s) => s.venteVrlVsl);
  const complementsBiking = useDeversementTransactionStore((s) => s.complementsBiking);
  const deversementHistory = useDeversementTransactionStore((s) => s.deversementHistory);

  const setVente = useDeversementTransactionStore((s) => s.setVente);
  const setAffectationTransfert = useDeversementTransactionStore((s) => s.setAffectationTransfert);
  const setShowAffectationModal = useDeversementTransactionStore((s) => s.setShowAffectationModal);
  const deverserVente = 

--- components/caisse/deversementTransaction/AffectationModalPanel.tsx ---
import { useState } from 'react';
import { Dialog, Button, Input } from '@/components/ui';
import { cn } from '@/lib/utils';

interface AffectationModalPanelProps {
  isOpen: boolean;
  onClose: () => void;
  affectation: string;
  onAffectationChange: (value: string) => void;
  onConfirm: () => void;
  isProcessing?: boolean;
}

export const AffectationModalPanel = ({
  isOpen,
  onClose,
  affectation,
  onAffectationChange,
  onConfirm,
  isProcessing = false,
}: AffectationModalPanelProps) => {
  const [localAffectation, setLocalAffectation] = useState(affectation);

  const handleConfirm = () => {
    onAffectationChange(localAffectation);
    onConfirm();
  };

  const handleCancel = () => {
    setLocalAffectation(affectation);
    onClose();
  };

  return (
    <Dialog open={isOpen} onOpenChange={(open) => !open && handleCancel()}>
      <Dialog.Content className="max-w-md">
        <Dialog.Header>
          <Dialog.Title>Affectation du transfert</Dialog.Title>
        </Dialog.Header>

        <div className="space-y-4 py-4">
          <div className="space-y-2">
            <label htmlFor="affectation-input" className="text-sm font-medium">
              Code d'affectation
            </label>
            <Input
              id="affectation-input"
              value={localAffectation}
              onChange={(e) => setLocalAffectation(e.target.value)}
              placeholder="Saisir le code d'affectation"
              disabled={isProcessing}
              className="w-full"
              autoFocus
            />
          </div>
        </div>

        <Dialog.Footer>
          <Button
            variant="outline"
            onClick={handleCancel}
            disabled={isProcessing}
          >
            Annuler
          </Button>
          <Button
            onClick={handleConfirm}
            disabled={isProcessing || !localAffectation.trim()}
          >
            {isProcessing ? 'Traitement...' : 'Confirmer'}
          </Button>
        <

--- components/caisse/deversementTransaction/DeversementFormPanel.tsx ---
import { useState } from 'react';
import { Input, Button } from '@/components/ui';
import { cn } from '@/lib/utils';
import type { VenteType } from '@/types/deversementTransaction';

interface DeversementFormPanelProps {
  className?: string;
  onDeverser?: (data: {
    societe: string;
    compte: string;
    filiation: number;
    montant: number;
    annulation: boolean;
    typeVente: VenteType | null;
  }) => void;
  disabled?: boolean;
}

export const DeversementFormPanel = ({
  className,
  onDeverser,
  disabled = false,
}: DeversementFormPanelProps) => {
  const [societe, setSociete] = useState('');
  const [compte, setCompte] = useState('');
  const [filiation, setFiliation] = useState('');
  const [montant, setMontant] = useState('');
  const [annulation, setAnnulation] = useState(false);
  const [typeVente, setTypeVente] = useState<VenteType | null>(null);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!societe || !compte || !filiation || !montant) {
      return;
    }

    const filiationNum = parseInt(filiation, 10);
    const montantNum = parseFloat(montant);

    if (isNaN(filiationNum) || isNaN(montantNum)) {
      return;
    }

    onDeverser?.({
      societe,
      compte,
      filiation: filiationNum,
      montant: montantNum,
      annulation,
      typeVente,
    });
  };

  const isFormValid = societe && compte && filiation && montant && !isNaN(parseFloat(montant));

  return (
    <div className={cn('bg-white rounded-lg border border-gray-200 p-6', className)}>
      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="grid grid-cols-3 gap-4">
          <div className="space-y-1">
            <label htmlFor="societe" className="text-sm font-medium text-gray-700">
              Société
            </label>
            <Input
              id="societe"
              value={societe}
              onChange={(e) => setSociete(e.target.value.toUpperCase())}
              disabled=

--- components/caisse/deversementTransaction/OperationsDiversesTablePanel.tsx ---
import type { OperationDiverse } from "@/types/deversementTransaction";
import { cn } from "@/lib/utils";

interface OperationsDiversesTablePanelProps {
  operations: OperationDiverse[];
  className?: string;
}

const TYPE_OD_LABELS: Record<string, string> = {
  compte: "Compte",
  service: "Service",
  statistiques: "Statistiques",
  biking: "Biking",
  lco: "LCO",
};

const formatMontant = (montant: number): string => {
  return new Intl.NumberFormat("fr-FR", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(montant);
};

const formatDate = (date: Date): string => {
  return new Intl.DateTimeFormat("fr-FR", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
  }).format(new Date(date));
};

export const OperationsDiversesTablePanel = ({
  operations,
  className,
}: OperationsDiversesTablePanelProps) => {
  if (operations.length === 0) {
    return (
      <div className={cn("flex items-center justify-center py-8 text-gray-500", className)}>
        Aucune opération diverse
      </div>
    );
  }

  return (
    <div className={cn("overflow-auto", className)}>
      <table className="w-full border-collapse">
        <thead>
          <tr className="border-b border-gray-300 bg-gray-100">
            <th className="px-4 py-2 text-left text-sm font-semibold">Type OD</th>
            <th className="px-4 py-2 text-right text-sm font-semibold">Montant</th>
            <th className="px-4 py-2 text-left text-sm font-semibold">Date</th>
            <th className="px-4 py-2 text-left text-sm font-semibold">Description</th>
          </tr>
        </thead>
        <tbody>
          {operations.map((operation, index) => (
            <tr
              key={operation.id}
              className={cn(
                "border-b border-gray-200 hover:bg-gray-50",
                index % 2 === 0 ? "bg-white" : "bg-gray-50"
              )}
            >
              <td className="px-4 py-2 text-sm"

--- components/caisse/deversementTransaction/ResultatDeversementPanel.tsx ---
import type { DeversementResult } from "@/types/deversementTransaction";
import { cn } from "@/lib/utils";

interface ResultatDeversementPanelProps {
  result: DeversementResult | null;
  numeroTicket?: number | null;
  error?: string | null;
  className?: string;
}

export const ResultatDeversementPanel = ({
  result,
  numeroTicket,
  error,
  className,
}: ResultatDeversementPanelProps) => {
  if (error) {
    return (
      <div className={cn("bg-red-50 border border-red-200 rounded-lg p-6", className)}>
        <div className="flex items-start gap-3">
          <div className="flex-shrink-0 w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
            <svg className="w-5 h-5 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </div>
          <div className="flex-1">
            <h3 className="text-sm font-semibold text-red-800 mb-1">Erreur de déversement</h3>
            <p className="text-sm text-red-700">{error}</p>
          </div>
        </div>
      </div>
    );
  }

  if (!result) {
    return null;
  }

  return (
    <div className={cn("bg-green-50 border border-green-200 rounded-lg p-6", className)}>
      <div className="flex items-start gap-3 mb-4">
        <div className="flex-shrink-0 w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
          <svg className="w-5 h-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <div className="flex-1">
          <h3 className="text-sm font-semibold text-green-800 mb-1">Déversement effectué avec succès</h3>
          <p className="text-sm text-green-700">La transaction a été traitée correctement</p>
        </div>
      </div>

      <div className="grid grid-co