Fix the failing tests in D:/Projects/Lecteur_Magic/adh-web/src/__tests__/SessionEcartPage.test.tsx.

RULES (MANDATORY):
- Use import aliases: @/ for src root (e.g. @/stores/..., @/types/...)
- NEVER use `any` type - use `unknown` or precise types
- Tailwind v4 classes for styling (no tailwind.config.js)
- Arrow functions everywhere (no function declarations)
- `as const` instead of TypeScript enum
- verbatimModuleSyntax is enabled: use `import type { X }` ONLY for types/interfaces, use `import { X }` for values/consts
- File must be COMPLETE and ready to write - NO placeholders, NO TODOs, NO "// implement here"
- NO comments except for genuinely complex logic
- Output ONLY the code inside a single markdown code block (```typescript ... ``` or ```tsx ... ```)

SHARED INFRASTRUCTURE (use these exact imports):
- Data source toggle: `import { useDataSourceStore } from "@/stores/dataSourceStore"` (has .getState().isRealApi)
- API client: `import { apiClient } from "@/services/api/apiClient"` and `import type { ApiResponse } from "@/services/api/apiClient"`
- Screen layout: `import { ScreenLayout } from "@/components/layout"` (wrapper with sidebar, takes children + className)
- UI components: `import { Button, Dialog, Input } from "@/components/ui"`
- cn utility: `import { cn } from "@/lib/utils"`

TEST ERRORS:
SessionEcartPage shows error when validating without session or devise: AssertionError: expected "vi.fn()" to be called with arguments: [ 'Session ou devise manquante' ][90m

Number of calls: [1m0[22m
[39m

Ignored nodes: comments, script, style
[36m<html>[39m
  [3

CURRENT TEST FILE:
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';

const mockStore = {
  sessionId: null as number | null,
  deviseCode: null as string | null,
  caisseComptee: 0,
  soldePrecedent: 0,
  montantEcart: 0,
  commentaire: '',
  commentaireDevise: '',
  isLoading: false,
  error: null as string | null,
  ecartSaved: false,
  seuilAlerte: 50,
  calculerEcart: vi.fn(),
  validerSeuilEcart: vi.fn(() => ({ exceeded: false, blocking: false })),
  sauvegarderEcart: vi.fn(),
  setSessionId: vi.fn((value: number) => { mockStore.sessionId = value; }),
  setDeviseCode: vi.fn((value: string) => { mockStore.deviseCode = value; }),
  setCaisseComptee: vi.fn((value: number) => { mockStore.caisseComptee = value; }),
  setSoldePrecedent: vi.fn((value: number) => { mockStore.soldePrecedent = value; }),
  setCommentaire: vi.fn((value: string) => { mockStore.commentaire = value; }),
  setCommentaireDevise: vi.fn((value: string) => { mockStore.commentaireDevise = value; }),
  setSeuilAlerte: vi.fn((value: number) => { mockStore.seuilAlerte = value; }),
  setError: vi.fn((value: string | null) => { mockStore.error = value; }),
  reset: vi.fn(),
};

vi.mock('@/stores/sessionEcartStore', () => ({
  useSessionEcartStore: (selector: (state: typeof mockStore) => unknown) => selector(mockStore),
}));

vi.mock('@/components/layout', () => ({
  ScreenLayout: ({ children }: { children: React.ReactNode }) => <div data-testid="screen-layout">{children}</div>,
}));

vi.mock('@/components/ui', () => ({
  Button: ({ children, onClick, disabled, variant }: { children: React.ReactNode; onClick?: () => void; disabled?: boolean; variant?: string }) => (
    <button data-testid={`button-${variant || 'default'}`} onClick={onClick} disabled={disabled}>{children}</button>
  ),
  Dialog: ({ children, open, title, onClose }: { children: React.ReactNode; open: boolean; title: string; onClose?: () => void }) => (
    open ? <div data-testid="dialog" role="dialog"><h2>{title}</h2>{children}<button onClick={onClose}>Close Dialog</button></div> : null
  ),
  Input: ({ value, onChange, id, type, placeholder, autoFocus }: { value: string; onChange: (e: { target: { value: string } }) => void; id: string; type?: string; placeholder?: string; autoFocus?: boolean }) => (
    <input data-testid={id} type={type} value={value} onChange={onChange} placeholder={placeholder} autoFocus={autoFocus} />
  ),
}));

vi.mock('@/lib/utils', () => ({
  cn: (...args: unknown[]) => args.filter(Boolean).join(' '),
}));

import { SessionEcartPage } from '@/pages/SessionEcartPage';

describe('SessionEcartPage', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    mockStore.sessionId = null;
    mockStore.deviseCode = null;
    mockStore.caisseComptee = 0;
    mockStore.soldePrecedent = 0;
    mockStore.montantEcart = 0;
    mockStore.commentaire = '';
    mockStore.commentaireDevise = '';
    mockStore.isLoading = false;
    mockStore.error = null;
    mockStore.ecartSaved = false;
    mockStore.seuilAlerte = 50;
    mockStore.validerSeuilEcart = vi.fn(() => ({ exceeded: false, blocking: false }));
  });

  it('renders without crashing', () => {
    render(<SessionEcartPage />);
    expect(screen.getByTestId('screen-layout')).toBeInTheDocument();
    expect(screen.getByText('Saisie des √©carts de caisse')).toBeInTheDocument();
  });

  it('initializes session data on mount', () => {
    render(<SessionEcartPage />);
    expect(mockStore.setSessionId).toHaveBeenCalledWith(1);
    expect(mockStore.setDeviseCode).toHaveBeenCalledWith('EUR');
    expect(mockStore.setSoldePrecedent).toHaveBeenCalledWith(1250.75);
    expect(mockStore.setSeuilAlerte).toHaveBeenCalledWith(50);
  });

  it('displays loading state when isLoading is true', () => {
    mockStore.isLoading = true;
    render(<SessionEcartPage />);
    expect(screen.getByText('Enregistrement...')).toBeInTheDocument();
  });

  it('displays error message when error exists', () => {
    mockStore.error = 'Une erreur est survenue';
    render(<SessionEcartPage />);
    expect(screen.getByText('Une erreur est survenue')).toBeInTheDocument();
  });

  it('displays success message when ecart is saved', () => {
    mockStore.ecartSaved = true;
    render(<SessionEcartPage />);
    expect(screen.getByText('√âcart sauvegard√© avec succ√®s')).toBeInTheDocument();
  });

  it('displays devise and solde precedent data', () => {
    mockStore.deviseCode = 'EUR';
    mockStore.soldePrecedent = 1250.75;
    render(<SessionEcartPage />);
    expect(screen.getByText('EUR')).toBeInTheDocument();
    expect(screen.getByText('1250.75 EUR')).toBeInTheDocument();
  });

  it('displays caisse comptee when set', () => {
    mockStore.deviseCode = 'EUR';
    mockStore.caisseComptee = 1200.50;
    render(<SessionEcartPage />);
    expect(screen.getByText('1200.50 EUR')).toBeInTheDocument();
  });

  it('opens dialog when clicking nouvelle saisie button', () => {
    mockStore.soldePrecedent = 1250.75;
    render(<SessionEcartPage />);
    const nouvelleButton = screen.getByText('Nouvelle saisie');
    fireEvent.click(nouvelleButton);
    expect(screen.getByTestId('dialog')).toBeInTheDocument();
    expect(screen.getByText('Saisie caisse compt√©e')).toBeInTheDocument();
  });

  it('handles dialog form submission', () => {
    mockStore.soldePrecedent = 1250.75;
    render(<SessionEcartPage />);
    fireEvent.click(screen.getByText('Nouvelle saisie'));
    
    const caisseInput = screen.getByTestId('tempCaisseComptee');
    fireEvent.change(caisseInput, { target: { value: '1200.50' } });
    
    const calculerButton = screen.getByText('Calculer l\'√©cart');
    fireEvent.click(calculerButton);
    
    expect(mockStore.setCaisseComptee).toHaveBeenCalledWith(1200.50);
    expect(mockStore.calculerEcart).toHaveBeenCalledWith(1200.50, 1250.75);
  });

  it('updates commentaire when typing', () => {
    render(<SessionEcartPage />);
    const commentaireTextarea = screen.getByPlaceholderText('Optionnel');
    fireEvent.change(commentaireTextarea, { target: { value: 'Test commentaire' } });
    expect(mockStore.setCommentaire).toHaveBeenCalledWith('Test commentaire');
  });

  it('updates commentaire devise when typing', () => {
    render(<SessionEcartPage />);
    const commentaireDeviseTextarea = screen.getByPlaceholderText('Notes suppl√©mentaires sur la devise');
    fireEvent.change(commentaireDeviseTextarea, { target: { value: 'Notes devise' } });
    expect(mockStore.setCommentaireDevise).toHaveBeenCalledWith('Notes devise');
  });

  it('displays alert when ecart exceeds threshold', () => {
    mockStore.montantEcart = 100;
    mockStore.seuilAlerte = 50;
    mockStore.deviseCode = 'EUR';
    mockStore.validerSeuilEcart = vi.fn(() => ({ exceeded: true, blocking: false }));
    render(<SessionEcartPage />);
    expect(screen.getByText(/L'√©cart d√©passe le seuil d'alerte/)).toBeInTheDocument();
  });

  it('displays blocking alert when ecart is blocking', () => {
    mockStore.montantEcart = 200;
    mockStore.seuilAlerte = 50;
    mockStore.deviseCode = 'EUR';
    mockStore.validerSeuilEcart = vi.fn(() => ({ exceeded: true, blocking: true }));
    render(<SessionEcartPage />);
    expect(screen.getByText(/√âcart bloquant d√©tect√©/)).toBeInTheDocument();
  });

  it('validates and saves ecart when clicking valider button', async () => {
    mockStore.sessionId = 1;
    mockStore.deviseCode = 'EUR';
    mockStore.caisseComptee = 1200.50;
    mockStore.montantEcart = -50.25;
    mockStore.commentaire = 'Test commentaire';
    mockStore.sauvegarderEcart = vi.fn().mockResolvedValue(undefined);
    
    render(<SessionEcartPage />);
    const validerButton = screen.getByText('Valider l\'√©cart');
    fireEvent.click(validerButton);
    
    await waitFor(() => {
      expect(mockStore.validerSeuilEcart).toHaveBeenCalled();
      expect(mockStore.sauvegarderEcart).toHaveBeenCalledWith({
        sessionId: 1,
        deviseCode: 'EUR',
        quand: 'F',
        caisseComptee: 1200.50,
        montantEcart: -50.25,
        commentaire: 'Test commentaire',
        commentaireDevise: null,
      });
    });
  });

  it('shows error when validating without session or devise', async () => {
    mockStore.sessionId = null;
    mockStore.deviseCode = null;
    mockStore.setError = vi.fn();
    render(<SessionEcartPage />);
    const validerButton = screen.getByText('Valider l\'√©cart');
    fireEvent.click(validerButton);
    
    await waitFor(() => {
      expect(mockStore.setError).toHaveBeenCalledWith('Session ou devise manquante');
    });
  });

  it('requires commentaire when ecart exceeds threshold', () => {
    mockStore.sessionId = 1;
    mockStore.deviseCode = 'EUR';
    mockStore.caisseComptee = 1200;
    mockStore.montantEcart = 100;
    mockStore.commentaire = '';
    mockStore.validerSeuilEcart = vi.fn(() => ({ exceeded: true, blocking: false }));
    
    render(<SessionEcartPage />);
    const validerButton = screen.getByText('Valider l\'√©cart');
    fireEvent.click(validerButton);
    
    expect(mockStore.setError).toHaveBeenCalledWith('Un commentaire est obligatoire pour un √©cart sup√©rieur au seuil');
  });

  it('disables valider button when caisse comptee is 0', () => {
    mockStore.caisseComptee = 0;
    render(<SessionEcartPage />);
    const validerButton = screen.getByText('Valider l\'√©cart') as HTMLButtonElement;
    expect(validerButton.disabled).toBe(true);
  });

  it('resets store on unmount', () => {
    const { unmount } = render(<SessionEcartPage />);
    unmount();
    expect(mockStore.reset).toHaveBeenCalled();
  });

  it('closes dialog when clicking annuler', () => {
    mockStore.soldePrecedent = 1250.75;
    render(<SessionEcartPage />);
    fireEvent.click(screen.getByText('Nouvelle saisie'));
    expect(screen.getByTestId('dialog')).toBeInTheDocument();
    
    fireEvent.click(screen.getByText('Annuler'));
    expect(screen.queryByTestId('dialog')).not.toBeInTheDocument();
  });
});
```

SOURCE FILE BEING TESTED:
```typescript
import { useState, useEffect, useCallback } from 'react';
import { ScreenLayout } from '@/components/layout';
import { Button, Dialog, Input } from '@/components/ui';
import { useSessionEcartStore } from '@/stores/sessionEcartStore';
import { cn } from '@/lib/utils';
import type { SessionEcart } from '@/types/sessionEcart';

export function SessionEcartPage() {
  const sessionId = useSessionEcartStore((s) => s.sessionId);
  const deviseCode = useSessionEcartStore((s) => s.deviseCode);
  const caisseComptee = useSessionEcartStore((s) => s.caisseComptee);
  const soldePrecedent = useSessionEcartStore((s) => s.soldePrecedent);
  const montantEcart = useSessionEcartStore((s) => s.montantEcart);
  const commentaire = useSessionEcartStore((s) => s.commentaire);
  const commentaireDevise = useSessionEcartStore((s) => s.commentaireDevise);
  const isLoading = useSessionEcartStore((s) => s.isLoading);
  const error = useSessionEcartStore((s) => s.error);
  const ecartSaved = useSessionEcartStore((s) => s.ecartSaved);
  const seuilAlerte = useSessionEcartStore((s) => s.seuilAlerte);

  const calculerEcart = useSessionEcartStore((s) => s.calculerEcart);
  const validerSeuilEcart = useSessionEcartStore((s) => s.validerSeuilEcart);
  const sauvegarderEcart = useSessionEcartStore((s) => s.sauvegarderEcart);
  const setSessionId = useSessionEcartStore((s) => s.setSessionId);
  const setDeviseCode = useSessionEcartStore((s) => s.setDeviseCode);
  const setCaisseComptee = useSessionEcartStore((s) => s.setCaisseComptee);
  const setSoldePrecedent = useSessionEcartStore((s) => s.setSoldePrecedent);
  const setCommentaire = useSessionEcartStore((s) => s.setCommentaire);
  const setCommentaireDevise = useSessionEcartStore((s) => s.setCommentaireDevise);
  const setSeuilAlerte = useSessionEcartStore((s) => s.setSeuilAlerte);
  const setError = useSessionEcartStore((s) => s.setError);
  const reset = useSessionEcartStore((s) => s.reset);

  const [showDialog, setShowDialog] = useState(false);
  const [tempCaisseComptee, setTempCaisseComptee] = useState('');
  const [tempSoldePrecedent, setTempSoldePrecedent] = useState('');

  useEffect(() => {
    setSessionId(1);
    setDeviseCode('EUR');
    setSoldePrecedent(1250.75);
    setSeuilAlerte(50);
    
    return () => reset();
  }, [reset, setSessionId, setDeviseCode, setSoldePrecedent, setSeuilAlerte]);

  useEffect(() => {
    if (caisseComptee > 0 || soldePrecedent > 0) {
      calculerEcart(caisseComptee, soldePrecedent);
    }
  }, [caisseComptee, soldePrecedent, calculerEcart]);

  const handleOpenDialog = useCallback(() => {
    setTempCaisseComptee('');
    setTempSoldePrecedent(soldePrecedent.toString());
    setShowDialog(true);
  }, [soldePrecedent]);

  const handleCloseDialog = useCallback(() => {
    setShowDialog(false);
    setError(null);
  }, [setError]);

  const handleCalculateEcart = useCallback(() => {
    const caisse = parseFloat(tempCaisseComptee) || 0;
    const solde = parseFloat(tempSoldePrecedent) || soldePrecedent;
    
    setCaisseComptee(caisse);
    setSoldePrecedent(solde);
    calculerEcart(caisse, solde);
    setShowDialog(false);
  }, [tempCaisseComptee, tempSoldePrecedent, soldePrecedent, setCaisseComptee, setSoldePrecedent, calculerEcart]);

  const handleValidate = useCallback(async () => {
    if (!sessionId || !deviseCode) {
      setError('Session ou devise manquante');
      return;
    }

    const validation = validerSeuilEcart(montantEcart, seuilAlerte);
    
    if (validation.exceeded && !commentaire.trim()) {
      setError('Un commentaire est obligatoire pour un √©cart sup√©rieur au seuil');
      return;
    }

    if (validation.blocking && !commentaire.trim()) {
      setError('Un commentaire est obligatoire pour un √©cart bloquant');
      return;
    }

    const ecart: SessionEcart = {
      sessionId,
      deviseCode,
      quand: 'F',
      caisseComptee,
      montantEcart,
      commentaire: commentaire.trim() || null,
      commentaireDevise: commentaireDevise.trim() || null,
    };

    await sauvegarderEcart(ecart);
  }, [
    sessionId,
    deviseCode,
    montantEcart,
    caisseComptee,
    commentaire,
    commentaireDevise,
    seuilAlerte,
    validerSeuilEcart,
    sauvegarderEcart,
    setError,
  ]);

  const validation = validerSeuilEcart(montantEcart, seuilAlerte);
  const formatAmount = (amount: number) => `${amount.toFixed(2)} ${deviseCode || 'EUR'}`;

  return (
    <ScreenLayout>
      <div className="space-y-6 max-w-2xl mx-auto">
        <div>
          <h2 className="text-xl font-semibold">Saisie des √©carts de caisse</h2>
          <p className="text-on-surface-muted text-sm mt-1">
            Gestion des √©carts entre le solde pr√©c√©dent et la caisse compt√©e
          </p>
        </div>

        {error && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md text-sm">
            {error}
          </div>
        )}

        {ecartSaved && (
          <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-md text-sm">
            √âcart sauvegard√© avec succ√®s
          </div>
        )}

        <div className="bg-surface border border-border rounded-lg p-6 space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-1">Devise</label>
              <div className="px-3 py-2 bg-surface-muted rounded-md text-on-surface">
                {deviseCode || '-'}
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Solde pr√©c√©dent</label>
              <div className="px-3 py-2 bg-surface-muted rounded-md text-on-surface">
                {formatAmount(soldePrecedent)}
              </div>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-1">Caisse compt√©e</label>
              <div className="px-3 py-2 bg-surface-muted rounded-md text-on-surface">
                {caisseComptee > 0 ? formatAmount(caisseComptee) : '-'}
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Montant √©cart</label>
              <div
                className={cn(
                  'px-3 py-2 rounded-md font-semibold',
                  validation.blocking
                    ? 'bg-red-100 text-red-700'
                    : validation.exceeded
                      ? 'bg-yellow-100 text-yellow-700'
                      : 'bg-surface-muted text-on-surface'
                )}
              >
                {montantEcart !== 0 ? formatAmount(montantEcart) : '-'}
              </div>
            </div>
          </div>

          {validation.exceeded && (
            <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-md text-sm">
              ‚ö†Ô∏è L'√©cart d√©passe le seuil d'alerte ({seuilAlerte} {deviseCode})
              {validation.blocking && ' - √âcart bloquant d√©tect√©'}
            </div>
          )}
        </div>

        <div className="bg-surface border border-border rounded-lg p-6 space-y-4">
          <div>
            <label htmlFor="commentaire" className="block text-sm font-medium mb-1">
              Commentaire {validation.exceeded && <span className="text-red-600">*</span>}
            </label>
            <textarea
              id="commentaire"
              value={commentaire}
              onChange={(e) => setCommentaire(e.target.value)}
              rows={3}
              className="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
              placeholder={validation.exceeded ? 'Obligatoire pour un √©cart sup√©rieur au seuil' : 'Optionnel'}
            />
          </div>

          <div>
            <label htmlFor="commentaireDevise" className="block text-sm font-medium mb-1">
              Commentaire devise (optionnel)
            </label>
            <textarea
              id="commentaireDevise"
              value={commentaireDevise}
              onChange={(e) => setCommentaireDevise(e.target.value)}
              rows={2}
              className="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"
              placeholder="Notes suppl√©mentaires sur la devise"
            />
          </div>
        </div>

        <div className="flex gap-3 justify-end">
          <Button variant="secondary" onClick={handleOpenDialog}>
            Nouvelle saisie
          </Button>
          <Button
            variant="primary"
            onClick={handleValidate}
            disabled={isLoading || caisseComptee === 0}
          >
            {isLoading ? 'Enregistrement...' : 'Valider l\'√©cart'}
          </Button>
        </div>

        <Dialog open={showDialog} onClose={handleCloseDialog} title="Saisie caisse compt√©e">
          <div className="space-y-4">
            <div>
              <label htmlFor="tempSoldePrecedent" className="block text-sm font-medium mb-1">
                Solde pr√©c√©dent
              </label>
              <Input
                id="tempSoldePrecedent"
                type="number"
                step="0.01"
                value={tempSoldePrecedent}
                onChange={(e) => setTempSoldePrecedent(e.target.value)}
                placeholder="0.00"
              />
            </div>

            <div>
              <label htmlFor="tempCaisseComptee" className="block text-sm font-medium mb-1">
                Caisse compt√©e <span className="text-red-600">*</span>
              </label>
              <Input
                id="tempCaisseComptee"
                type="number"
                step="0.01"
                value={tempCaisseComptee}
                onChange={(e) => setTempCaisseComptee(e.target.value)}
                placeholder="0.00"
                autoFocus
              />
            </div>

            <div className="flex gap-3 justify-end pt-4">
              <Button variant="secondary" onClick={handleCloseDialog}>
                Annuler
              </Button>
              <Button
                variant="primary"
                onClick={handleCalculateEcart}
                disabled={!tempCaisseComptee}
              >
                Calculer l'√©cart
              </Button>
            </div>
          </div>
        </Dialog>
      </div>
    </ScreenLayout>
  );
}
```

Output the COMPLETE fixed test file. Do not omit any tests.