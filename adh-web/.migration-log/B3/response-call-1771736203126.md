```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { BrowserRouter } from 'react-router-dom';
import type { HistoriqueAppel, ReseauCloture } from '@/types/facturationAppel';

const mockNavigate = vi.fn();
vi.mock('react-router-dom', async () => {
  const actual = await vi.importActual('react-router-dom');
  return {
    ...actual,
    useNavigate: () => mockNavigate,
  };
});

const mockStore = {
  historiqueAppels: [] as HistoriqueAppel[],
  coefficientTelephone: null as number | null,
  cloture: null as ReseauCloture | null,
  isLoading: false,
  error: null as string | null,
  filterSociete: '',
  filterDateDebut: null as Date | null,
  filterDateFin: null as Date | null,
  chargerHistoriqueAppels: vi.fn(),
  recupererCoefficient: vi.fn(),
  facturerAppel: vi.fn(),
  verifierCloture: vi.fn(),
  debloquerCloture: vi.fn(),
  marquerGratuit: vi.fn(),
  annulerFacturation: vi.fn(),
  setFilterSociete: vi.fn(),
  setFilterDateDebut: vi.fn(),
  setFilterDateFin: vi.fn(),
  resetFilters: vi.fn(),
  reset: vi.fn(),
};

vi.mock('@/stores/facturationAppelStore', () => ({
  useFacturationAppelStore: (selector: (state: typeof mockStore) => unknown) => selector(mockStore),
}));

vi.mock('@/stores', () => ({
  useAuthStore: () => ({ prenom: 'Jean', nom: 'Dupont' }),
}));

import { FacturationAppelPage } from '@/pages/FacturationAppelPage';

const renderComponent = () => {
  return render(
    <BrowserRouter>
      <FacturationAppelPage />
    </BrowserRouter>
  );
};

describe('FacturationAppelPage', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    mockStore.historiqueAppels = [];
    mockStore.coefficientTelephone = null;
    mockStore.cloture = null;
    mockStore.isLoading = false;
    mockStore.error = null;
    mockStore.filterSociete = '';
    mockStore.filterDateDebut = null;
    mockStore.filterDateFin = null;
  });

  it('renders without crashing', () => {
    renderComponent();
    expect(screen.getByText('Facturation Appels')).toBeInTheDocument();
    expect(screen.getByText('Gestion de la facturation des appels telephoniques')).toBeInTheDocument();
  });

  it('displays user info', () => {
    renderComponent();
    expect(screen.getByText('Jean Dupont')).toBeInTheDocument();
  });

  it('displays loading state', () => {
    mockStore.isLoading = true;
    renderComponent();
    expect(screen.getByText('Chargement...')).toBeInTheDocument();
  });

  it('displays error state', () => {
    mockStore.error = 'Erreur de chargement des appels';
    renderComponent();
    expect(screen.getByText('Erreur de chargement des appels')).toBeInTheDocument();
  });

  it('displays empty state when no appels', () => {
    mockStore.historiqueAppels = [];
    renderComponent();
    expect(screen.getByText('Aucun appel trouvé')).toBeInTheDocument();
  });

  it('displays appels data when loaded', () => {
    mockStore.historiqueAppels = [
      {
        id: 1,
        societe: 'SOC1',
        prefixe: 'CAI01',
        dateAppel: new Date('2025-01-15'),
        heureAppel: '10:30',
        numeroTel: '+33612345678',
        duree: '00:05:30',
        montant: 2.5,
        qualite: 'OK',
        gratuite: false,
        raisonGratuite: null,
        facture: false,
      },
      {
        id: 2,
        societe: 'SOC1',
        prefixe: 'CAI01',
        dateAppel: new Date('2025-01-16'),
        heureAppel: '14:20',
        numeroTel: '+33698765432',
        duree: '00:10:15',
        montant: 5.0,
        qualite: 'Mauvaise',
        gratuite: true,
        raisonGratuite: 'Urgence médicale',
        facture: true,
      },
    ];
    mockStore.coefficientTelephone = 0.5;
    mockStore.cloture = { cloture_enCours: false, testReseau: null };

    renderComponent();

    expect(screen.getByText('+33612345678')).toBeInTheDocument();
    expect(screen.getByText('+33698765432')).toBeInTheDocument();
    expect(screen.getByText('00:05:30')).toBeInTheDocument();
    expect(screen.getByText('00:10:15')).toBeInTheDocument();
    expect(screen.getByText('2.50 €')).toBeInTheDocument();
    expect(screen.getByText('5.00 €')).toBeInTheDocument();
  });

  it('displays stats correctly', () => {
    mockStore.historiqueAppels = [
      {
        id: 1,
        societe: 'SOC1',
        prefixe: 'CAI01',
        dateAppel: new Date('2025-01-15'),
        heureAppel: '10:30',
        numeroTel: '+33612345678',
        duree: '00:05:30',
        montant: 2.5,
        qualite: 'OK',
        gratuite: false,
        raisonGratuite: null,
        facture: false,
      },
      {
        id: 2,
        societe: 'SOC1',
        prefixe: 'CAI01',
        dateAppel: new Date('2025-01-16'),
        heureAppel: '14:20',
        numeroTel: '+33698765432',
        duree: '00:10:15',
        montant: 5.0,
        qualite: 'OK',
        gratuite: false,
        raisonGratuite: null,
        facture: true,
      },
    ];
    mockStore.coefficientTelephone = 0.5;

    renderComponent();

    expect(screen.getByText('2')).toBeInTheDocument();
    expect(screen.getByText('7.50 €')).toBeInTheDocument();
    expect(screen.getByText('0.5000')).toBeInTheDocument();
  });

  it('displays cloture status', () => {
    mockStore.cloture = { cloture_enCours: true, testReseau: null };
    renderComponent();
    expect(screen.getByText('Clôturé')).toBeInTheDocument();

    mockStore.cloture = { cloture_enCours: false, testReseau: null };
    renderComponent();
    expect(screen.getByText('Ouvert')).toBeInTheDocument();
  });

  it('handles filter changes', () => {
    renderComponent();

    const societeInput = screen.getByPlaceholderText('SOC1');
    fireEvent.change(societeInput, { target: { value: 'SOC2' } });
    expect(mockStore.setFilterSociete).toHaveBeenCalledWith('SOC2');

    const prefixeInput = screen.getByPlaceholderText('CAI01');
    fireEvent.change(prefixeInput, { target: { value: 'CAI02' } });
    expect(prefixeInput).toHaveValue('CAI02');
  });

  it('handles search action', async () => {
    mockStore.filterSociete = 'SOC1';
    mockStore.chargerHistoriqueAppels.mockResolvedValue(undefined);

    renderComponent();

    const prefixeInput = screen.getByPlaceholderText('CAI01');
    fireEvent.change(prefixeInput, { target: { value: 'CAI01' } });

    const searchButton = screen.getByText('Rechercher');
    fireEvent.click(searchButton);

    await waitFor(() => {
      expect(mockStore.chargerHistoriqueAppels).toHaveBeenCalledWith(
        'SOC1',
        'CAI01',
        undefined,
        undefined
      );
    });
  });

  it('disables search when societe or prefixe is empty', () => {
    mockStore.filterSociete = '';
    renderComponent();

    const searchButton = screen.getByText('Rechercher');
    expect(searchButton).toBeDisabled();
  });

  it('handles reset filters', () => {
    renderComponent();

    const resetButton = screen.getByText('Réinitialiser');
    fireEvent.click(resetButton);

    expect(mockStore.resetFilters).toHaveBeenCalled();
  });

  it('handles appel selection', () => {
    mockStore.historiqueAppels = [
      {
        id: 1,
        societe: 'SOC1',
        prefixe: 'CAI01',
        dateAppel: new Date('2025-01-15'),
        heureAppel: '10:30',
        numeroTel: '+33612345678',
        duree: '00:05:30',
        montant: 2.5,
        qualite: 'OK',
        gratuite: false,
        raisonGratuite: null,
      },
    ];

    renderComponent();

    const checkboxes = screen.getAllByRole('checkbox');
    const appelCheckbox = checkboxes[1];

    fireEvent.click(appelCheckbox);
    expect(appelCheckbox).toBeChecked();

    fireEvent.click(appelCheckbox);
    expect(appelCheckbox).not.toBeChecked();
  });

  it('handles select all appels', () => {
    mockStore.historiqueAppels = [
      {
        id: 1,
        societe: 'SOC1',
        prefixe: 'CAI01',
        dateAppel: new Date('2025-01-15'),
        heureAppel: '10:30',
        numeroTel: '+33612345678',
        duree: '00:05:30',
        montant: 2.5,
        qualite: 'OK',
        gratuite: false,
        raisonGratuite: null,
      },
      {
        id: 2,
        societe: 'SOC1',
        prefixe: 'CAI01',
        dateAppel: new Date('2025-01-16'),
        heureAppel: '14:20',
        numeroTel: '+33698765432',
        duree: '00:10:15',
        montant: 5.0,
        qualite: 'OK',
        gratuite: false,
        raisonGratuite: null,
      },
    ];

    renderComponent();

    const checkboxes = screen.getAllByRole('checkbox');
    const selectAllCheckbox = checkboxes[0];

    fireEvent.click(selectAllCheckbox);
    expect(selectAllCheckbox).toBeChecked();
    expect(checkboxes[1]).toBeChecked();
    expect(checkboxes[2]).toBeChecked();
  });

  it('disables action buttons when no appels selected', () => {
    renderComponent();

    const facturerButton = screen.getByText(/Facturer/);
    const gratuitButton = screen.getByText('Marquer gratuit');
    const annulerButton = screen.getByText('Annuler facturation');

    expect(facturerButton).toBeDisabled();
    expect(gratuitButton).toBeDisabled();
    expect(annulerButton).toBeDisabled();
  });

  it('opens facturation dialog when facturer clicked', async () => {
    mockStore.historiqueAppels = [
      {
        id: 1,
        societe: 'SOC1',
        prefixe: 'CAI01',
        dateAppel: new Date('2025-01-15'),
        heureAppel: '10:30',
        numeroTel: '+33612345678',
        duree: '00:05:30',
        montant: 2.5,
        qualite: 'OK',
        gratuite: false,
        raisonGratuite: null,
      },
    ];

    renderComponent();

    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);

    const facturerButton = screen.getByText(/Facturer/);
    fireEvent.click(facturerButton);

    await waitFor(() => {
      expect(screen.getByText('Facturer les appels sélectionnés')).toBeInTheDocument();
    });
  });

  it('opens gratuit dialog when marquer gratuit clicked', async () => {
    mockStore.historiqueAppels = [
      {
        id: 1,
        societe: 'SOC1',
        prefixe: 'CAI01',
        dateAppel: new Date('2025-01-15'),
        heureAppel: '10:30',
        numeroTel: '+33612345678',
        duree: '00:05:30',
        montant: 2.5,
        qualite: 'OK',
        gratuite: false,
        raisonGratuite: null,
      },
    ];

    renderComponent();

    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);

    const gratuitButton = screen.getByText('Marquer gratuit');
    fireEvent.click(gratuitButton);

    await waitFor(() => {
      expect(screen.getByText('Marquer comme gratuit')).toBeInTheDocument();
    });
  });

  it('handles facturation submission', async () => {
    mockStore.historiqueAppels = [
      {
        id: 1,
        societe: 'SOC1',
        prefixe: 'CAI01',
        dateAppel: new Date('2025-01-15'),
        heureAppel: '10:30',
        numeroTel: '+33612345678',
        duree: '00:05:30',
        montant: 2.5,
        qualite: 'OK',
        gratuite: false,
        raisonGratuite: null,
      },
    ];
    mockStore.verifierCloture.mockResolvedValue(false);
    mockStore.facturerAppel.mockResolvedValue(undefined);
    mockStore.chargerHistoriqueAppels.mockResolvedValue(undefined);

    renderComponent();

    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);

    const facturerButton = screen.getByText(/Facturer/);
    fireEvent.click(facturerButton);

    await waitFor(() => {
      expect(screen.getByText('Facturer les appels sélectionnés')).toBeInTheDocument();
    });

    const compteInput = screen.getByPlaceholderText('12345');
    const filiationInput = screen.getByPlaceholderText('1');

    fireEvent.change(compteInput, { target: { value: '12345' } });
    fireEvent.change(filiationInput, { target: { value: '1' } });

    const confirmerButtons = screen.getAllByText('Confirmer');
    fireEvent.click(confirmerButtons[0]);

    await waitFor(() => {
      expect(mockStore.verifierCloture).toHaveBeenCalled();
      expect(mockStore.facturerAppel).toHaveBeenCalled();
    });
  });

  it('shows cloture warning when network is closed', async () => {
    mockStore.historiqueAppels = [
      {
        id: 1,
        societe: 'SOC1',
        prefixe: 'CAI01',
        dateAppel: new Date('2025-01-15'),
        heureAppel: '10:30',
        numeroTel: '+33612345678',
        duree: '00:05:30',
        montant: 2.5,
        qualite: 'OK',
        gratuite: false,
        raisonGratuite: null,
      },
    ];
    mockStore.verifierCloture.mockResolvedValue(true);

    renderComponent();

    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);

    const facturerButton = screen.getByText(/Facturer/);
    fireEvent.click(facturerButton);

    await waitFor(() => {
      expect(screen.getByText('Facturer les appels sélectionnés')).toBeInTheDocument();
    });

    const compteInput = screen.getByPlaceholderText('12345');
    const filiationInput = screen.getByPlaceholderText('1');

    fireEvent.change(compteInput, { target: { value: '12345' } });
    fireEvent.change(filiationInput, { target: { value: '1' } });

    const confirmerButtons = screen.getAllByText('Confirmer');
    fireEvent.click(confirmerButtons[0]);

    await waitFor(() => {
      expect(screen.getByText('Réseau clôturé')).toBeInTheDocument();
    });
  });

  it('handles marquer gratuit submission', async () => {
    mockStore.historiqueAppels = [
      {
        id: 1,
        societe: 'SOC1',
        prefixe: 'CAI01',
        dateAppel: new Date('2025-01-15'),
        heureAppel: '10:30',
        numeroTel: '+33612345678',
        duree: '00:05:30',
        montant: 2.5,
        qualite: 'OK',
        gratuite: false,
        raisonGratuite: null,
      },
    ];
    mockStore.marquerGratuit.mockResolvedValue(undefined);
    mockStore.chargerHistoriqueAppels.mockResolvedValue(undefined);

    renderComponent();

    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);

    const gratuitButton = screen.getByText('Marquer gratuit');
    fireEvent.click(gratuitButton);

    await waitFor(() => {
      expect(screen.getByText('Marquer comme gratuit')).toBeInTheDocument();
    });

    const raisonInput = screen.getByPlaceholderText('Appel urgence médicale');
    fireEvent.change(raisonInput, { target: { value: 'Urgence' } });

    const confirmerButtons = screen.getAllByText('Confirmer');
    fireEvent.click(confirmerButtons[0]);

    await waitFor(() => {
      expect(mockStore.marquerGratuit).toHaveBeenCalledWith(1, 'Urgence');
    });
  });

  it('handles annuler facturation', async () => {
    mockStore.historiqueAppels = [
      {
        id: 1,
        societe: 'SOC1',
        prefixe: 'CAI01',
        dateAppel: new Date('2025-01-15'),
        heureAppel: '10:30',
        numeroTel: '+33612345678',
        duree: '00:05:30',
        montant: 2.5,
        qualite: 'OK',
        gratuite: false,
        raisonGratuite: null,
        facture: true,
      },
    ];
    mockStore.annulerFacturation.mockResolvedValue(undefined);
    mockStore.chargerHistoriqueAppels.mockResolvedValue(undefined);

    renderComponent();

    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);

    const annulerButton = screen.getByText('Annuler facturation');
    fireEvent.click(annulerButton);

    await waitFor(() => {
      expect(mockStore.annulerFacturation).toHaveBeenCalledWith(1);
    });
  });

  it('handles navigation back to menu', () => {
    renderComponent();

    const retourButton = screen.getByText('Retour au menu');
    fireEvent.click(retourButton);

    expect(mockNavigate).toHaveBeenCalledWith('/caisse/menu');
  });

  it('calls recupererCoefficient on mount', () => {
    renderComponent();
    expect(mockStore.recupererCoefficient).toHaveBeenCalled();
  });

  it('calls reset on unmount', () => {
    const { unmount } = renderComponent();
    unmount();
    expect(mockStore.reset).toHaveBeenCalled();
  });
});
```