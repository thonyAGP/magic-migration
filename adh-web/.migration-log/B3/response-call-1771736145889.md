```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { BrowserRouter } from 'react-router-dom';
import type { HistoriqueAppel, ReseauCloture } from '@/types/facturationAppel';

vi.mock('@/stores/authStore', () => ({
  useAuthStore: vi.fn(() => ({
    user: { prenom: 'Test', nom: 'User' },
  })),
}));

vi.mock('@/stores/facturationAppelStore', () => ({
  useFacturationAppelStore: vi.fn(),
}));

import { useFacturationAppelStore } from '@/stores/facturationAppelStore';
import { FacturationAppelPage } from '@/pages/FacturationAppelPage';

const mockHistoriqueAppels: HistoriqueAppel[] = [
  {
    id: 1,
    societe: 'SOC1',
    prefixe: 'CAI01',
    dateAppel: new Date('2026-02-20'),
    heureAppel: '14:30',
    numeroTel: '+33612345678',
    duree: '00:05:30',
    montant: 12.5,
    qualite: 'OK',
    gratuite: false,
    raisonGratuite: null,
    facture: false,
  },
  {
    id: 2,
    societe: 'SOC1',
    prefixe: 'CAI01',
    dateAppel: new Date('2026-02-21'),
    heureAppel: '10:15',
    numeroTel: '+33687654321',
    duree: '00:02:10',
    montant: 5.8,
    qualite: 'Mauvaise',
    gratuite: true,
    raisonGratuite: 'Urgence médicale',
    facture: true,
  },
];

const mockCloture: ReseauCloture = {
  cloture_enCours: false,
  testReseau: null,
};

const mockStoreDefaults = {
  historiqueAppels: [],
  coefficientTelephone: 1.2345,
  cloture: mockCloture,
  isLoading: false,
  error: null,
  filterSociete: '',
  filterDateDebut: null,
  filterDateFin: null,
  chargerHistoriqueAppels: vi.fn(),
  recupererCoefficient: vi.fn(),
  facturerAppel: vi.fn(),
  verifierCloture: vi.fn(() => Promise.resolve(false)),
  debloquerCloture: vi.fn(),
  marquerGratuit: vi.fn(),
  annulerFacturation: vi.fn(),
  setFilterSociete: vi.fn(),
  setFilterDateDebut: vi.fn(),
  setFilterDateFin: vi.fn(),
  resetFilters: vi.fn(),
  reset: vi.fn(),
};

const renderComponent = () => {
  return render(
    <BrowserRouter>
      <FacturationAppelPage />
    </BrowserRouter>
  );
};

describe('FacturationAppelPage', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector(mockStoreDefaults as never)
    );
  });

  it('renders without crashing', () => {
    renderComponent();
    expect(screen.getByText('Facturation Appels')).toBeInTheDocument();
    expect(screen.getByText('Gestion de la facturation des appels telephoniques')).toBeInTheDocument();
  });

  it('displays loading state', () => {
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, isLoading: true } as never)
    );

    renderComponent();
    expect(screen.getByText('Chargement...')).toBeInTheDocument();
  });

  it('displays error state', () => {
    const errorMessage = 'Erreur de connexion au serveur';
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, error: errorMessage } as never)
    );

    renderComponent();
    expect(screen.getByText(errorMessage)).toBeInTheDocument();
  });

  it('displays data when loaded', () => {
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, historiqueAppels: mockHistoriqueAppels } as never)
    );

    renderComponent();
    
    expect(screen.getByText('+33612345678')).toBeInTheDocument();
    expect(screen.getByText('+33687654321')).toBeInTheDocument();
    expect(screen.getByText('00:05:30')).toBeInTheDocument();
    expect(screen.getByText('12.50 €')).toBeInTheDocument();
  });

  it('displays empty state when no appels', () => {
    renderComponent();
    expect(screen.getByText('Aucun appel trouvé')).toBeInTheDocument();
  });

  it('displays summary statistics', () => {
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, historiqueAppels: mockHistoriqueAppels } as never)
    );

    renderComponent();
    
    expect(screen.getByText('2')).toBeInTheDocument();
    expect(screen.getByText('18.30 €')).toBeInTheDocument();
    expect(screen.getByText('1.2345')).toBeInTheDocument();
  });

  it('displays cloture status badge', () => {
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, cloture: mockCloture } as never)
    );

    renderComponent();
    expect(screen.getByText('Ouvert')).toBeInTheDocument();
  });

  it('displays cloture status as closed when cloture_enCours is true', () => {
    const cloturedCloture: ReseauCloture = {
      cloture_enCours: true,
      testReseau: null,
    };
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, cloture: cloturedCloture } as never)
    );

    renderComponent();
    expect(screen.getByText('Clôturé')).toBeInTheDocument();
  });

  it('handles filter changes', () => {
    const setFilterSociete = vi.fn();
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, setFilterSociete } as never)
    );

    renderComponent();
    
    const societeInput = screen.getByPlaceholderText('SOC1');
    fireEvent.change(societeInput, { target: { value: 'SOC2' } });
    
    expect(setFilterSociete).toHaveBeenCalledWith('SOC2');
  });

  it('handles search button click', async () => {
    const chargerHistoriqueAppels = vi.fn();
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({
        ...mockStoreDefaults,
        filterSociete: 'SOC1',
        chargerHistoriqueAppels,
      } as never)
    );

    renderComponent();
    
    const prefixeInput = screen.getByPlaceholderText('CAI01');
    fireEvent.change(prefixeInput, { target: { value: 'CAI01' } });
    
    const searchButton = screen.getByRole('button', { name: /rechercher/i });
    fireEvent.click(searchButton);
    
    await waitFor(() => {
      expect(chargerHistoriqueAppels).toHaveBeenCalledWith('SOC1', 'CAI01', undefined, undefined);
    });
  });

  it('disables search button when filters are incomplete', () => {
    renderComponent();
    
    const searchButton = screen.getByRole('button', { name: /rechercher/i });
    expect(searchButton).toBeDisabled();
  });

  it('handles reset filters', () => {
    const resetFilters = vi.fn();
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, resetFilters } as never)
    );

    renderComponent();
    
    const resetButton = screen.getByRole('button', { name: /réinitialiser/i });
    fireEvent.click(resetButton);
    
    expect(resetFilters).toHaveBeenCalled();
  });

  it('handles row selection', () => {
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, historiqueAppels: mockHistoriqueAppels } as never)
    );

    renderComponent();
    
    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);
    
    expect(checkboxes[1]).toBeChecked();
  });

  it('handles select all checkbox', () => {
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, historiqueAppels: mockHistoriqueAppels } as never)
    );

    renderComponent();
    
    const checkboxes = screen.getAllByRole('checkbox');
    const selectAllCheckbox = checkboxes[0];
    
    fireEvent.click(selectAllCheckbox);
    
    checkboxes.forEach((checkbox) => {
      expect(checkbox).toBeChecked();
    });
  });

  it('opens facturation dialog on button click', async () => {
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, historiqueAppels: mockHistoriqueAppels } as never)
    );

    renderComponent();
    
    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);
    
    const facturerButton = screen.getByRole('button', { name: /facturer \(1\)/i });
    fireEvent.click(facturerButton);
    
    await waitFor(() => {
      expect(screen.getByText('Facturer les appels sélectionnés')).toBeInTheDocument();
    });
  });

  it('handles facturation submission', async () => {
    const facturerAppel = vi.fn();
    const chargerHistoriqueAppels = vi.fn();
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({
        ...mockStoreDefaults,
        historiqueAppels: mockHistoriqueAppels,
        filterSociete: 'SOC1',
        facturerAppel,
        chargerHistoriqueAppels,
      } as never)
    );

    renderComponent();
    
    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);
    
    const facturerButton = screen.getByRole('button', { name: /facturer \(1\)/i });
    fireEvent.click(facturerButton);
    
    await waitFor(() => {
      expect(screen.getByText('Facturer les appels sélectionnés')).toBeInTheDocument();
    });
    
    const compteInput = screen.getByPlaceholderText('12345');
    const filiationInput = screen.getByPlaceholderText('1');
    
    fireEvent.change(compteInput, { target: { value: '12345' } });
    fireEvent.change(filiationInput, { target: { value: '1' } });
    
    const confirmerButtons = screen.getAllByRole('button', { name: /confirmer/i });
    fireEvent.click(confirmerButtons[0]);
    
    await waitFor(() => {
      expect(facturerAppel).toHaveBeenCalled();
    });
  });

  it('opens marquer gratuit dialog', async () => {
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, historiqueAppels: mockHistoriqueAppels } as never)
    );

    renderComponent();
    
    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);
    
    const gratuitButton = screen.getByRole('button', { name: /marquer gratuit/i });
    fireEvent.click(gratuitButton);
    
    await waitFor(() => {
      expect(screen.getByText('Marquer comme gratuit')).toBeInTheDocument();
    });
  });

  it('handles marquer gratuit submission', async () => {
    const marquerGratuit = vi.fn();
    const chargerHistoriqueAppels = vi.fn();
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({
        ...mockStoreDefaults,
        historiqueAppels: mockHistoriqueAppels,
        filterSociete: 'SOC1',
        marquerGratuit,
        chargerHistoriqueAppels,
      } as never)
    );

    renderComponent();
    
    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);
    
    const gratuitButton = screen.getByRole('button', { name: /marquer gratuit/i });
    fireEvent.click(gratuitButton);
    
    await waitFor(() => {
      expect(screen.getByText('Marquer comme gratuit')).toBeInTheDocument();
    });
    
    const raisonInput = screen.getByPlaceholderText('Appel urgence médicale');
    fireEvent.change(raisonInput, { target: { value: 'Test raison' } });
    
    const confirmerButtons = screen.getAllByRole('button', { name: /confirmer/i });
    fireEvent.click(confirmerButtons[0]);
    
    await waitFor(() => {
      expect(marquerGratuit).toHaveBeenCalledWith(1, 'Test raison');
    });
  });

  it('handles annuler facturation', async () => {
    const annulerFacturation = vi.fn();
    const chargerHistoriqueAppels = vi.fn();
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({
        ...mockStoreDefaults,
        historiqueAppels: mockHistoriqueAppels,
        filterSociete: 'SOC1',
        annulerFacturation,
        chargerHistoriqueAppels,
      } as never)
    );

    renderComponent();
    
    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);
    
    const annulerButton = screen.getByRole('button', { name: /annuler facturation/i });
    fireEvent.click(annulerButton);
    
    await waitFor(() => {
      expect(annulerFacturation).toHaveBeenCalledWith(1);
    });
  });

  it('shows cloture warning when trying to facturer with cloture active', async () => {
    const verifierCloture = vi.fn(() => Promise.resolve(true));
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({
        ...mockStoreDefaults,
        historiqueAppels: mockHistoriqueAppels,
        filterSociete: 'SOC1',
        verifierCloture,
      } as never)
    );

    renderComponent();
    
    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);
    
    const facturerButton = screen.getByRole('button', { name: /facturer \(1\)/i });
    fireEvent.click(facturerButton);
    
    await waitFor(() => {
      expect(screen.getByText('Facturer les appels sélectionnés')).toBeInTheDocument();
    });
    
    const compteInput = screen.getByPlaceholderText('12345');
    const filiationInput = screen.getByPlaceholderText('1');
    
    fireEvent.change(compteInput, { target: { value: '12345' } });
    fireEvent.change(filiationInput, { target: { value: '1' } });
    
    const confirmerButtons = screen.getAllByRole('button', { name: /confirmer/i });
    fireEvent.click(confirmerButtons[0]);
    
    await waitFor(() => {
      expect(screen.getByText('Réseau clôturé')).toBeInTheDocument();
    });
  });

  it('handles debloquer cloture', async () => {
    const debloquerCloture = vi.fn();
    const verifierCloture = vi.fn(() => Promise.resolve(true));
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({
        ...mockStoreDefaults,
        historiqueAppels: mockHistoriqueAppels,
        filterSociete: 'SOC1',
        verifierCloture,
        debloquerCloture,
      } as never)
    );

    renderComponent();
    
    const checkboxes = screen.getAllByRole('checkbox');
    fireEvent.click(checkboxes[1]);
    
    const facturerButton = screen.getByRole('button', { name: /facturer \(1\)/i });
    fireEvent.click(facturerButton);
    
    await waitFor(() => {
      expect(screen.getByText('Facturer les appels sélectionnés')).toBeInTheDocument();
    });
    
    const compteInput = screen.getByPlaceholderText('12345');
    const filiationInput = screen.getByPlaceholderText('1');
    
    fireEvent.change(compteInput, { target: { value: '12345' } });
    fireEvent.change(filiationInput, { target: { value: '1' } });
    
    const confirmerButtons = screen.getAllByRole('button', { name: /confirmer/i });
    fireEvent.click(confirmerButtons[0]);
    
    await waitFor(() => {
      expect(screen.getByText('Réseau clôturé')).toBeInTheDocument();
    });
    
    const debloquerButton = screen.getByRole('button', { name: /débloquer et continuer/i });
    fireEvent.click(debloquerButton);
    
    await waitFor(() => {
      expect(debloquerCloture).toHaveBeenCalled();
    });
  });

  it('displays qualite badges correctly', () => {
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, historiqueAppels: mockHistoriqueAppels } as never)
    );

    renderComponent();
    
    expect(screen.getByText('OK')).toBeInTheDocument();
    expect(screen.getByText('Mauvaise')).toBeInTheDocument();
  });

  it('displays gratuite and facture badges', () => {
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, historiqueAppels: mockHistoriqueAppels } as never)
    );

    renderComponent();
    
    expect(screen.getByText('Gratuit')).toBeInTheDocument();
    expect(screen.getByText('Facturé')).toBeInTheDocument();
    expect(screen.getByText('En attente')).toBeInTheDocument();
  });

  it('calls recupererCoefficient on mount', () => {
    const recupererCoefficient = vi.fn();
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, recupererCoefficient } as never)
    );

    renderComponent();
    
    expect(recupererCoefficient).toHaveBeenCalled();
  });

  it('disables actions when no selection', () => {
    vi.mocked(useFacturationAppelStore).mockImplementation((selector) =>
      selector({ ...mockStoreDefaults, historiqueAppels: mockHistoriqueAppels } as never)
    );

    renderComponent();
    
    const facturerButton = screen.getByRole('button', { name: /facturer \(0\)/i });
    const gratuitButton = screen.getByRole('button', { name: /marquer gratuit/i });
    const annulerButton = screen.getByRole('button', { name: /annuler facturation/i });
    
    expect(facturerButton).toBeDisabled();
    expect(gratuitButton).toBeDisabled();
    expect(annulerButton).toBeDisabled();
  });
});
```