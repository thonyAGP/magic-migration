Basé sur l'analyse du contrat YAML et de la spécification fournie, voici le rapport de conformité :

```json
{
  "programId": 135,
  "programName": "Generation tableau recap WS",
  "coveragePct": 45,
  "rulesImplemented": 0,
  "rulesTotal": 0,
  "missingRules": [
    "Aucune règle métier documentée dans le contrat ou la spec"
  ],
  "recommendations": [
    "CRITIQUE: Table pv_discounts (ID 510) marquée MISSING - aucune entité TypeScript correspondante générée",
    "CRITIQUE: Aucune logique de calcul de summary implémentée - calculateSummary() retourne des totaux vides",
    "CRITIQUE: Format d'export TXT non implémenté - seul le téléchargement de blob existe",
    "MAJEUR: Aucune gestion des devises multiples - la spec mentionne 'différentes devises selon configuration locale'",
    "MAJEUR: Aucune logique d'agrégation des mouvements de trésorerie par type (vente, appro, versement coffre, etc.)",
    "MAJEUR: Aucune détection ou consolidation des écarts - la spec mentionne 'écarts détectés'",
    "MAJEUR: Export CSV/JSON non implémenté - seule la structure existe",
    "MINEUR: RecapWorksheetEntry contient 24 champs mais aucune validation Zod n'est visible",
    "MINEUR: Mock data présent dans le store (MOCK_ENTRIES) sans switch API/Mock configuré",
    "MINEUR: Aucun endpoint API réel documenté - endpoints-recapWorksheet.ts existe mais pas de backend",
    "MINEUR: calculateSummary() devrait implémenter la logique métier : totalParDevise, totalParType, totalParModePaiement",
    "MINEUR: exportRecapWorksheet() devrait formatter selon le format demandé (TXT avec colonnes alignées, CSV avec séparateurs, JSON structuré)",
    "PERFORMANCE: RecapitulatifPanel utilise useMemo pour columns mais pas pour le tri des entries",
    "DESIGN: ExportPanel devrait afficher un aperçu du fichier généré avant téléchargement",
    "DESIGN: FiltresPanel ne valide pas si la session existe avant de générer",
    "UX: Aucun message d'erreur personnalisé si la session n'a pas de données",
    "UX: Pas de loader visuel pendant la génération (isGenerating existe mais non affiché)",
    "SECURITE: Aucune validation des permissions utilisateur avant export",
    "AUDIT: Aucun log de traçabilité pour l'export de fichiers (audit de caisse)"
  ]
}
```

## Analyse détaillée

### Points positifs ✅
1. **Structure TypeScript correcte** : Types bien définis pour RecapWorksheetEntry et RecapWorksheetSummary
2. **Store Zustand complet** : Actions CRUD présentes (generate, export, fetch, calculate)
3. **Composants modulaires** : Séparation claire FiltresPanel, RecapitulatifPanel, ExportPanel
4. **API endpoints définis** : Structure prête pour intégration backend

### Écarts critiques ⚠️

**1. Table manquante (pv_discounts)**
```yaml
# Contrat
- id: 510
  name: pv_discounts
  mode: R
  status: MISSING  # ❌ Aucune entité générée
```

**2. Logique métier absente**
La spec dit : *"agrège les mouvements de trésorerie, les écarts détectés et génère un fichier résumé"*

Code actuel :
```typescript
calculateSummary: (entries) => {
  // ❌ Implémentation vide - devrait calculer :
  // - totalParDevise : { EUR: 1250, USD: 340, ... }
  // - totalParType : { vente: 5000, appro: 2000, ... }
  // - totalParModePaiement : { especes: 3000, carte: 2000, ... }
  // - Détection écarts (montant attendu vs compté)
}
```

**3. Export non fonctionnel**
```typescript
exportRecapWorksheet: async (summary, format) => {
  // ❌ Ne formate pas selon le format
  // Devrait :
  // - TXT : colonnes alignées, largeur fixe
  // - CSV : séparateur ;, quotes si nécessaire
  // - JSON : structure hiérarchique lisible
}
```

### Recommandations d'implémentation

**Priorité 1 : Calculer le summary**
```typescript
calculateSummary(entries: RecapWorksheetEntry[]): RecapWorksheetSummary {
  const totalParDevise: Record<string, number> = {};
  const totalParType: Record<string, number> = {};
  const totalParModePaiement: Record<string, number> = {};
  let totalGeneral = 0;

  entries.forEach((entry) => {
    // Agrégation par devise
    totalParDevise[entry.codeDevise] = 
      (totalParDevise[entry.codeDevise] || 0) + entry.montant;

    // Agrégation par type
    totalParType[entry.type] = 
      (totalParType[entry.type] || 0) + entry.montant;

    // Agrégation par mode paiement
    if (entry.modePaiement) {
      totalParModePaiement[entry.modePaiement] =
        (totalParModePaiement[entry.modePaiement] || 0) + entry.montant;
    }

    totalGeneral += entry.montant;
  });

  return {
    numeroSession: entries[0]?.numeroSession || 0,
    dateComptable: entries[0]?.dateComptable || new Date(),
    totalParDevise,
    totalParType,
    totalParModePaiement,
    totalGeneral,
  };
}
```

**Priorité 2 : Implémenter l'export TXT**
```typescript
function formatTxt(summary: RecapWorksheetSummary): string {
  const lines: string[] = [];
  lines.push('RECAP WORKSHEET - SESSION ' + summary.numeroSession);
  lines.push('Date: ' + summary.dateComptable.toLocaleDateString());
  lines.push('');
  lines.push('TOTAUX PAR DEVISE:');
  Object.entries(summary.totalParDevise).forEach(([dev, montant]) => {
    lines.push(`  ${dev.padEnd(5)} : ${montant.toFixed(2).padStart(12)}`);
  });
  // ...
  return lines.join('\n');
}
```

**Priorité 3 : Ajouter validation**
```typescript
const RecapWorksheetEntrySchema = z.object({
  dateComptable: z.date(),
  numeroSession: z.number().positive(),
  type: z.string().min(1),
  codeDevise: z.string().length(3),
  montant: z.number(),
  // ...
});
```

Le code généré fournit une **structure solide** mais **manque la logique métier essentielle**. La couverture de 45% est justifiée car les types et composants UI sont présents, mais les règles de calcul et d'export (cœur du programme) sont absentes.