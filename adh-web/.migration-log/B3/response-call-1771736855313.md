```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { BrowserRouter } from 'react-router-dom';

vi.mock('@/stores/reinitAffPyrStore');
vi.mock('@/stores', () => ({
  useAuthStore: vi.fn(),
}));

import { ReinitAffPyrPage } from '@/pages/ReinitAffPyrPage';
import { useReinitAffPyrStore } from '@/stores/reinitAffPyrStore';
import { useAuthStore } from '@/stores';

const mockNavigate = vi.fn();
vi.mock('react-router-dom', async () => {
  const actual = await vi.importActual('react-router-dom');
  return {
    ...actual,
    useNavigate: () => mockNavigate,
  };
});

const renderPage = () => {
  return render(
    <BrowserRouter>
      <ReinitAffPyrPage />
    </BrowserRouter>
  );
};

describe('ReinitAffPyrPage', () => {
  const mockReinitAffectationPyr = vi.fn();
  const mockResetAllAffectations = vi.fn();
  const mockGetAffectationStatus = vi.fn();
  const mockClearError = vi.fn();
  const mockReset = vi.fn();

  beforeEach(() => {
    vi.clearAllMocks();

    vi.mocked(useAuthStore).mockReturnValue({
      prenom: 'Jean',
      nom: 'Dupont',
    } as never);

    vi.mocked(useReinitAffPyrStore).mockImplementation((selector) => {
      const state = {
        isProcessing: false,
        error: null,
        lastResetCount: 0,
        reinitAffectationPyr: mockReinitAffectationPyr,
        resetAllAffectations: mockResetAllAffectations,
        getAffectationStatus: mockGetAffectationStatus,
        clearError: mockClearError,
        reset: mockReset,
      };
      return selector(state);
    });

    mockGetAffectationStatus.mockResolvedValue({
      hasActiveAffectations: true,
      count: 5,
    });
  });

  afterEach(() => {
    vi.restoreAllMocks();
  });

  it('renders without crashing', () => {
    renderPage();
    expect(screen.getByText('Réinitialiser affectations PYR')).toBeInTheDocument();
    expect(screen.getByText('Gestion des affectations PYR dans les dossiers d\'hébergement')).toBeInTheDocument();
  });

  it('displays user info', () => {
    renderPage();
    expect(screen.getByText('Jean Dupont')).toBeInTheDocument();
  });

  it('loads affectation status when compte is entered', async () => {
    renderPage();
    
    const compteInput = screen.getByPlaceholderText('Numéro de compte');
    fireEvent.change(compteInput, { target: { value: '12345' } });

    await waitFor(() => {
      expect(mockGetAffectationStatus).toHaveBeenCalledWith('ADH', 12345);
    });

    await waitFor(() => {
      expect(screen.getByText('5 affectation(s) active(s)')).toBeInTheDocument();
    });
  });

  it('does not load status for invalid compte', () => {
    renderPage();
    
    const compteInput = screen.getByPlaceholderText('Numéro de compte');
    fireEvent.change(compteInput, { target: { value: 'invalid' } });

    expect(mockGetAffectationStatus).not.toHaveBeenCalled();
  });

  it('displays loading state when processing', () => {
    vi.mocked(useReinitAffPyrStore).mockImplementation((selector) => {
      const state = {
        isProcessing: true,
        error: null,
        lastResetCount: 0,
        reinitAffectationPyr: mockReinitAffectationPyr,
        resetAllAffectations: mockResetAllAffectations,
        getAffectationStatus: mockGetAffectationStatus,
        clearError: mockClearError,
        reset: mockReset,
      };
      return selector(state);
    });

    renderPage();

    const buttons = screen.getAllByRole('button');
    const resetButtons = buttons.filter(btn => 
      btn.textContent?.includes('Réinitialiser')
    );
    
    resetButtons.forEach(btn => {
      expect(btn).toBeDisabled();
    });
  });

  it('displays error state', () => {
    const errorMessage = 'Erreur de réinitialisation';
    vi.mocked(useReinitAffPyrStore).mockImplementation((selector) => {
      const state = {
        isProcessing: false,
        error: new Error(errorMessage),
        lastResetCount: 0,
        reinitAffectationPyr: mockReinitAffectationPyr,
        resetAllAffectations: mockResetAllAffectations,
        getAffectationStatus: mockGetAffectationStatus,
        clearError: mockClearError,
        reset: mockReset,
      };
      return selector(state);
    });

    renderPage();
    expect(screen.getByText(errorMessage)).toBeInTheDocument();
  });

  it('clears error after timeout', async () => {
    vi.useFakeTimers();
    
    vi.mocked(useReinitAffPyrStore).mockImplementation((selector) => {
      const state = {
        isProcessing: false,
        error: new Error('Test error'),
        lastResetCount: 0,
        reinitAffectationPyr: mockReinitAffectationPyr,
        resetAllAffectations: mockResetAllAffectations,
        getAffectationStatus: mockGetAffectationStatus,
        clearError: mockClearError,
        reset: mockReset,
      };
      return selector(state);
    });

    renderPage();

    vi.advanceTimersByTime(5000);

    await waitFor(() => {
      expect(mockClearError).toHaveBeenCalled();
    });

    vi.useRealTimers();
  });

  it('opens targeted reset dialog', async () => {
    renderPage();
    
    const compteInput = screen.getByPlaceholderText('Numéro de compte');
    fireEvent.change(compteInput, { target: { value: '12345' } });

    const targetedResetButton = screen.getByText('Réinitialiser pour un compte');
    fireEvent.click(targetedResetButton);

    await waitFor(() => {
      expect(screen.getByText('Réinitialisation ciblée')).toBeInTheDocument();
    });
  });

  it('handles targeted reset', async () => {
    mockReinitAffectationPyr.mockResolvedValue(3);

    renderPage();
    
    const compteInput = screen.getByPlaceholderText('Numéro de compte');
    fireEvent.change(compteInput, { target: { value: '12345' } });

    const targetedResetButton = screen.getByText('Réinitialiser pour un compte');
    fireEvent.click(targetedResetButton);

    await waitFor(() => {
      expect(screen.getByText('Réinitialisation ciblée')).toBeInTheDocument();
    });

    const confirmButton = screen.getAllByText('Réinitialiser')[1];
    fireEvent.click(confirmButton);

    await waitFor(() => {
      expect(mockReinitAffectationPyr).toHaveBeenCalledWith({
        societe: 'ADH',
        compte: 12345,
        chambre: undefined,
      });
    });

    await waitFor(() => {
      expect(screen.getByText(/Réinitialisation ciblée réussie/)).toBeInTheDocument();
    });
  });

  it('handles targeted reset with chambre', async () => {
    mockReinitAffectationPyr.mockResolvedValue(1);

    renderPage();
    
    const compteInput = screen.getByPlaceholderText('Numéro de compte');
    fireEvent.change(compteInput, { target: { value: '12345' } });

    const targetedResetButton = screen.getByText('Réinitialiser pour un compte');
    fireEvent.click(targetedResetButton);

    await waitFor(() => {
      expect(screen.getByText('Réinitialisation ciblée')).toBeInTheDocument();
    });

    const chambreInput = screen.getByPlaceholderText('Numéro de chambre');
    fireEvent.change(chambreInput, { target: { value: '101' } });

    const confirmButton = screen.getAllByText('Réinitialiser')[1];
    fireEvent.click(confirmButton);

    await waitFor(() => {
      expect(mockReinitAffectationPyr).toHaveBeenCalledWith({
        societe: 'ADH',
        compte: 12345,
        chambre: '101',
      });
    });
  });

  it('opens global reset confirmation dialog', async () => {
    renderPage();

    const globalResetButton = screen.getByText('Réinitialiser toutes les affectations');
    fireEvent.click(globalResetButton);

    await waitFor(() => {
      expect(screen.getByText('Confirmation')).toBeInTheDocument();
      expect(screen.getByText(/Êtes-vous sûr de vouloir réinitialiser/)).toBeInTheDocument();
    });
  });

  it('handles global reset', async () => {
    mockResetAllAffectations.mockResolvedValue(50);

    renderPage();

    const globalResetButton = screen.getByText('Réinitialiser toutes les affectations');
    fireEvent.click(globalResetButton);

    await waitFor(() => {
      expect(screen.getByText('Confirmation')).toBeInTheDocument();
    });

    const confirmButton = screen.getByText('Confirmer');
    fireEvent.click(confirmButton);

    await waitFor(() => {
      expect(mockResetAllAffectations).toHaveBeenCalled();
    });

    await waitFor(() => {
      expect(screen.getByText(/Réinitialisation globale réussie/)).toBeInTheDocument();
    });
  });

  it('disables targeted reset button when compte is invalid', () => {
    renderPage();

    const targetedResetButton = screen.getByText('Réinitialiser pour un compte');
    expect(targetedResetButton).toBeDisabled();

    const compteInput = screen.getByPlaceholderText('Numéro de compte');
    fireEvent.change(compteInput, { target: { value: 'invalid' } });

    expect(targetedResetButton).toBeDisabled();
  });

  it('navigates back to menu', () => {
    renderPage();

    const backButton = screen.getByText('Retour au menu');
    fireEvent.click(backButton);

    expect(mockNavigate).toHaveBeenCalledWith('/caisse/menu');
  });

  it('displays last reset count', () => {
    vi.mocked(useReinitAffPyrStore).mockImplementation((selector) => {
      const state = {
        isProcessing: false,
        error: null,
        lastResetCount: 15,
        reinitAffectationPyr: mockReinitAffectationPyr,
        resetAllAffectations: mockResetAllAffectations,
        getAffectationStatus: mockGetAffectationStatus,
        clearError: mockClearError,
        reset: mockReset,
      };
      return selector(state);
    });

    renderPage();
    expect(screen.getByText(/Dernière réinitialisation: 15 affectation/)).toBeInTheDocument();
  });

  it('calls reset on unmount', () => {
    const { unmount } = renderPage();
    unmount();
    expect(mockReset).toHaveBeenCalled();
  });

  it('cancels targeted reset dialog', async () => {
    renderPage();
    
    const compteInput = screen.getByPlaceholderText('Numéro de compte');
    fireEvent.change(compteInput, { target: { value: '12345' } });

    const targetedResetButton = screen.getByText('Réinitialiser pour un compte');
    fireEvent.click(targetedResetButton);

    await waitFor(() => {
      expect(screen.getByText('Réinitialisation ciblée')).toBeInTheDocument();
    });

    const cancelButton = screen.getAllByText('Annuler')[0];
    fireEvent.click(cancelButton);

    await waitFor(() => {
      expect(screen.queryByText('Réinitialisation ciblée')).not.toBeInTheDocument();
    });

    expect(mockReinitAffectationPyr).not.toHaveBeenCalled();
  });

  it('cancels global reset dialog', async () => {
    renderPage();

    const globalResetButton = screen.getByText('Réinitialiser toutes les affectations');
    fireEvent.click(globalResetButton);

    await waitFor(() => {
      expect(screen.getByText('Confirmation')).toBeInTheDocument();
    });

    const cancelButton = screen.getByText('Annuler');
    fireEvent.click(cancelButton);

    await waitFor(() => {
      expect(screen.queryByText('Confirmation')).not.toBeInTheDocument();
    });

    expect(mockResetAllAffectations).not.toHaveBeenCalled();
  });
});
```