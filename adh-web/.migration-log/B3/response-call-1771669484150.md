```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { BrowserRouter } from 'react-router-dom';
import type { RecapWorksheetEntry, RecapWorksheetSummary } from '@/types/recapWorksheet';

const mockNavigate = vi.fn();
vi.mock('react-router-dom', async () => {
  const actual = await vi.importActual('react-router-dom');
  return {
    ...actual,
    useNavigate: () => mockNavigate,
  };
});

const mockUseAuthStore = vi.fn();
vi.mock('@/stores', () => ({
  useAuthStore: (selector: unknown) => mockUseAuthStore(selector),
}));

const mockGenerateRecapWorksheet = vi.fn();
const mockExportRecapWorksheet = vi.fn();
const mockSetFilters = vi.fn();
const mockReset = vi.fn();

vi.mock('@/stores/recapWorksheetStore', () => ({
  useRecapWorksheetStore: (selector: (state: unknown) => unknown) => {
    const state = {
      entries: mockUseRecapWorksheetStore.entries || [],
      summary: mockUseRecapWorksheetStore.summary || null,
      isGenerating: mockUseRecapWorksheetStore.isGenerating || false,
      error: mockUseRecapWorksheetStore.error || null,
      filters: mockUseRecapWorksheetStore.filters || {},
      generateRecapWorksheet: mockGenerateRecapWorksheet,
      exportRecapWorksheet: mockExportRecapWorksheet,
      setFilters: mockSetFilters,
      reset: mockReset,
    };
    return selector(state);
  },
}));

const mockUseRecapWorksheetStore = {
  entries: [] as RecapWorksheetEntry[],
  summary: null as RecapWorksheetSummary | null,
  isGenerating: false,
  error: null as string | null,
  filters: {},
};

import { RecapWorksheetPage } from '@/pages/RecapWorksheetPage';

const renderWithRouter = (component: React.ReactElement) => {
  return render(<BrowserRouter>{component}</BrowserRouter>);
};

describe('RecapWorksheetPage', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    mockUseRecapWorksheetStore.entries = [];
    mockUseRecapWorksheetStore.summary = null;
    mockUseRecapWorksheetStore.isGenerating = false;
    mockUseRecapWorksheetStore.error = null;
    mockUseRecapWorksheetStore.filters = {};
    mockUseAuthStore.mockReturnValue({ nom: 'Dupont', prenom: 'Jean' });
  });

  it('renders without crashing', () => {
    renderWithRouter(<RecapWorksheetPage />);
    expect(screen.getByText('Récapitulatif Worksheet')).toBeInTheDocument();
  });

  it('displays user info when logged in', () => {
    renderWithRouter(<RecapWorksheetPage />);
    expect(screen.getByText('Jean Dupont')).toBeInTheDocument();
  });

  it('displays filters section with inputs', () => {
    renderWithRouter(<RecapWorksheetPage />);
    expect(screen.getByText('Filtres')).toBeInTheDocument();
    expect(screen.getByPlaceholderText('Ex: 1001')).toBeInTheDocument();
    expect(screen.getByLabelText('Date comptable')).toBeInTheDocument();
  });

  it('displays generate button in disabled state when no session number', () => {
    renderWithRouter(<RecapWorksheetPage />);
    const generateButton = screen.getByRole('button', { name: /Générer/i });
    expect(generateButton).toBeDisabled();
  });

  it('enables generate button when session number is entered', () => {
    renderWithRouter(<RecapWorksheetPage />);
    const sessionInput = screen.getByPlaceholderText('Ex: 1001');
    fireEvent.change(sessionInput, { target: { value: '1001' } });
    const generateButton = screen.getByRole('button', { name: /Générer/i });
    expect(generateButton).not.toBeDisabled();
  });

  it('displays loading state when generating', () => {
    mockUseRecapWorksheetStore.isGenerating = true;
    renderWithRouter(<RecapWorksheetPage />);
    expect(screen.getByText('Génération...')).toBeInTheDocument();
  });

  it('displays error message when error occurs', () => {
    mockUseRecapWorksheetStore.error = 'Session introuvable';
    renderWithRouter(<RecapWorksheetPage />);
    expect(screen.getByText('Session introuvable')).toBeInTheDocument();
  });

  it('displays empty state when no data', () => {
    renderWithRouter(<RecapWorksheetPage />);
    expect(
      screen.getByText(
        'Saisissez un numéro de session et cliquez sur Générer pour afficher le récapitulatif'
      )
    ).toBeInTheDocument();
  });

  it('calls generateRecapWorksheet when generate button is clicked', async () => {
    const mockSummary: RecapWorksheetSummary = {
      numeroSession: 1001,
      dateComptable: new Date('2024-01-15'),
      totalParDevise: { EUR: 1000 },
      totalParType: { vente: 1000 },
      totalParModePaiement: { especes: 1000 },
      totalGeneral: 1000,
    };
    mockGenerateRecapWorksheet.mockResolvedValue(mockSummary);

    renderWithRouter(<RecapWorksheetPage />);
    const sessionInput = screen.getByPlaceholderText('Ex: 1001');
    fireEvent.change(sessionInput, { target: { value: '1001' } });
    const generateButton = screen.getByRole('button', { name: /Générer/i });
    fireEvent.click(generateButton);

    await waitFor(() => {
      expect(mockGenerateRecapWorksheet).toHaveBeenCalledWith(
        1001,
        expect.any(Date)
      );
    });
  });

  it('displays data when entries are loaded', () => {
    const mockEntries: RecapWorksheetEntry[] = [
      {
        dateComptable: new Date('2024-01-15'),
        numeroSession: 1001,
        type: 'vente',
        typeApproVersCoffre: null,
        modePaiement: 'especes',
        avecChange: null,
        codeDevise: 'EUR',
        quantiteDevise: null,
        tauxDevise: null,
        montant: 100,
        montantMonnaie: null,
        montantProduits: null,
        montantCartes: null,
        montantCheque: null,
        montantOd: null,
        societe: 'SOC001',
        compteVillage: 123,
        filiation: 1,
        imputation: null,
        sousImputation: null,
        libelle: 'Test vente',
        libelleComplementaire: null,
        nomGm: 'GM Test',
        quantiteArticle: null,
        prixArticle: null,
      },
    ];
    const mockSummary: RecapWorksheetSummary = {
      numeroSession: 1001,
      dateComptable: new Date('2024-01-15'),
      totalParDevise: { EUR: 100 },
      totalParType: { vente: 100 },
      totalParModePaiement: { especes: 100 },
      totalGeneral: 100,
    };

    mockUseRecapWorksheetStore.entries = mockEntries;
    mockUseRecapWorksheetStore.summary = mockSummary;

    renderWithRouter(<RecapWorksheetPage />);
    expect(screen.getByText('Récapitulatif')).toBeInTheDocument();
    expect(screen.getByText('vente')).toBeInTheDocument();
    expect(screen.getByText('especes')).toBeInTheDocument();
    expect(screen.getByText('Test vente')).toBeInTheDocument();
  });

  it('displays summary sections when data is loaded', () => {
    const mockSummary: RecapWorksheetSummary = {
      numeroSession: 1001,
      dateComptable: new Date('2024-01-15'),
      totalParDevise: { EUR: 500, USD: 300 },
      totalParType: { vente: 600, change: 200 },
      totalParModePaiement: { especes: 400, carte: 400 },
      totalGeneral: 800,
    };

    mockUseRecapWorksheetStore.entries = [
      {
        dateComptable: new Date('2024-01-15'),
        numeroSession: 1001,
        type: 'vente',
        typeApproVersCoffre: null,
        modePaiement: 'especes',
        avecChange: null,
        codeDevise: 'EUR',
        quantiteDevise: null,
        tauxDevise: null,
        montant: 500,
        montantMonnaie: null,
        montantProduits: null,
        montantCartes: null,
        montantCheque: null,
        montantOd: null,
        societe: 'SOC001',
        compteVillage: 123,
        filiation: 1,
        imputation: null,
        sousImputation: null,
        libelle: 'Test',
        libelleComplementaire: null,
        nomGm: 'GM Test',
        quantiteArticle: null,
        prixArticle: null,
      },
    ];
    mockUseRecapWorksheetStore.summary = mockSummary;

    renderWithRouter(<RecapWorksheetPage />);
    expect(screen.getByText('Totaux par devise')).toBeInTheDocument();
    expect(screen.getByText('Totaux par type')).toBeInTheDocument();
    expect(screen.getByText('Totaux par mode paiement')).toBeInTheDocument();
    expect(screen.getByText('Total général')).toBeInTheDocument();
  });

  it('displays export section when data is loaded', () => {
    mockUseRecapWorksheetStore.entries = [
      {
        dateComptable: new Date('2024-01-15'),
        numeroSession: 1001,
        type: 'vente',
        typeApproVersCoffre: null,
        modePaiement: 'especes',
        avecChange: null,
        codeDevise: 'EUR',
        quantiteDevise: null,
        tauxDevise: null,
        montant: 100,
        montantMonnaie: null,
        montantProduits: null,
        montantCartes: null,
        montantCheque: null,
        montantOd: null,
        societe: 'SOC001',
        compteVillage: 123,
        filiation: 1,
        imputation: null,
        sousImputation: null,
        libelle: 'Test',
        libelleComplementaire: null,
        nomGm: 'GM Test',
        quantiteArticle: null,
        prixArticle: null,
      },
    ];
    mockUseRecapWorksheetStore.summary = {
      numeroSession: 1001,
      dateComptable: new Date('2024-01-15'),
      totalParDevise: { EUR: 100 },
      totalParType: { vente: 100 },
      totalParModePaiement: { especes: 100 },
      totalGeneral: 100,
    };

    renderWithRouter(<RecapWorksheetPage />);
    expect(screen.getByText('Export')).toBeInTheDocument();
    expect(screen.getByLabelText('TXT')).toBeInTheDocument();
    expect(screen.getByLabelText('CSV')).toBeInTheDocument();
    expect(screen.getByLabelText('JSON')).toBeInTheDocument();
  });

  it('calls exportRecapWorksheet when export button is clicked', async () => {
    const mockBlob = new Blob(['test'], { type: 'text/plain' });
    mockExportRecapWorksheet.mockResolvedValue(mockBlob);

    const mockSummary: RecapWorksheetSummary = {
      numeroSession: 1001,
      dateComptable: new Date('2024-01-15'),
      totalParDevise: { EUR: 100 },
      totalParType: { vente: 100 },
      totalParModePaiement: { especes: 100 },
      totalGeneral: 100,
    };

    mockUseRecapWorksheetStore.entries = [
      {
        dateComptable: new Date('2024-01-15'),
        numeroSession: 1001,
        type: 'vente',
        typeApproVersCoffre: null,
        modePaiement: 'especes',
        avecChange: null,
        codeDevise: 'EUR',
        quantiteDevise: null,
        tauxDevise: null,
        montant: 100,
        montantMonnaie: null,
        montantProduits: null,
        montantCartes: null,
        montantCheque: null,
        montantOd: null,
        societe: 'SOC001',
        compteVillage: 123,
        filiation: 1,
        imputation: null,
        sousImputation: null,
        libelle: 'Test',
        libelleComplementaire: null,
        nomGm: 'GM Test',
        quantiteArticle: null,
        prixArticle: null,
      },
    ];
    mockUseRecapWorksheetStore.summary = mockSummary;

    const createObjectURLSpy = vi
      .spyOn(URL, 'createObjectURL')
      .mockReturnValue('blob:mock-url');
    const revokeObjectURLSpy = vi.spyOn(URL, 'revokeObjectURL');

    renderWithRouter(<RecapWorksheetPage />);
    const exportButton = screen.getByRole('button', { name: /Exporter/i });
    fireEvent.click(exportButton);

    await waitFor(() => {
      expect(mockExportRecapWorksheet).toHaveBeenCalledWith(mockSummary, 'txt');
    });

    createObjectURLSpy.mockRestore();
    revokeObjectURLSpy.mockRestore();
  });

  it('changes export format when radio button is clicked', () => {
    mockUseRecapWorksheetStore.entries = [
      {
        dateComptable: new Date('2024-01-15'),
        numeroSession: 1001,
        type: 'vente',
        typeApproVersCoffre: null,
        modePaiement: 'especes',
        avecChange: null,
        codeDevise: 'EUR',
        quantiteDevise: null,
        tauxDevise: null,
        montant: 100,
        montantMonnaie: null,
        montantProduits: null,
        montantCartes: null,
        montantCheque: null,
        montantOd: null,
        societe: 'SOC001',
        compteVillage: 123,
        filiation: 1,
        imputation: null,
        sousImputation: null,
        libelle: 'Test',
        libelleComplementaire: null,
        nomGm: 'GM Test',
        quantiteArticle: null,
        prixArticle: null,
      },
    ];
    mockUseRecapWorksheetStore.summary = {
      numeroSession: 1001,
      dateComptable: new Date('2024-01-15'),
      totalParDevise: { EUR: 100 },
      totalParType: { vente: 100 },
      totalParModePaiement: { especes: 100 },
      totalGeneral: 100,
    };

    renderWithRouter(<RecapWorksheetPage />);
    const csvRadio = screen.getByLabelText('CSV') as HTMLInputElement;
    fireEvent.click(csvRadio);
    expect(csvRadio.checked).toBe(true);
  });

  it('navigates back when retour button is clicked', () => {
    renderWithRouter(<RecapWorksheetPage />);
    const retourButton = screen.getByRole('button', { name: /Retour au menu/i });
    fireEvent.click(retourButton);
    expect(mockNavigate).toHaveBeenCalledWith('/caisse/menu');
  });

  it('calls reset on unmount', () => {
    const { unmount } = renderWithRouter(<RecapWorksheetPage />);
    unmount();
    expect(mockReset).toHaveBeenCalled();
  });
});
```