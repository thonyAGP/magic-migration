<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Changement Compte - Separation/Fusion</title>
    <style>
        /* Style Windows classique - fidele a Magic Unipaas */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'MS Sans Serif', 'Segoe UI', Tahoma, sans-serif;
            font-size: 11px;
            background-color: #808080;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .magic-window {
            background-color: #d4d0c8;
            border: 2px outset #ffffff;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.4);
            width: 900px;
        }

        .title-bar {
            background: linear-gradient(to right, #0a246a, #a6caf0);
            color: white;
            padding: 3px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 11px;
        }

        .title-bar .title { display: flex; align-items: center; gap: 5px; }
        .title-bar .icon { width: 16px; height: 16px; background: #c44; border-radius: 2px; }

        .window-controls { display: flex; gap: 2px; }
        .window-controls button {
            width: 16px; height: 14px;
            border: 1px outset #c0c0c0;
            font-size: 9px; cursor: pointer;
            background: #c0c0c0;
        }

        .window-content { padding: 8px; }

        /* Toolbar */
        .toolbar {
            background: #d4d0c8;
            border: 1px inset #808080;
            padding: 4px;
            margin-bottom: 8px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .toolbar-btn {
            min-width: 80px;
            height: 22px;
            border: 2px outset #d4d0c8;
            background: linear-gradient(to bottom, #e8e8e8 0%, #c8c8c8 100%);
            font-size: 11px;
            cursor: pointer;
            padding: 0 8px;
        }
        .toolbar-btn:active { border-style: inset; }
        .toolbar-btn.active {
            border-style: inset;
            background: #a6caf0;
        }

        /* Fieldsets */
        fieldset {
            border: 1px solid #808080;
            padding: 8px;
            margin-bottom: 8px;
        }

        fieldset legend {
            background: #0a246a;
            color: white;
            padding: 2px 8px;
            font-weight: bold;
        }

        /* Form groups */
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .form-row label {
            width: 120px;
            font-weight: bold;
        }

        .form-row input, .form-row select {
            border: 1px inset #808080;
            padding: 2px 4px;
            font-size: 11px;
            background: white;
        }

        .form-row input[type="text"],
        .form-row input[type="number"] {
            width: 150px;
        }

        /* Account panels */
        .account-panels {
            display: flex;
            gap: 16px;
            margin-bottom: 8px;
        }

        .account-panel {
            flex: 1;
            background: #f0f0f0;
            border: 1px inset #808080;
            padding: 8px;
        }

        .account-panel h3 {
            background: #0a246a;
            color: white;
            padding: 2px 6px;
            margin: -8px -8px 8px -8px;
            font-size: 11px;
        }

        .arrow-section {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #0a246a;
            font-weight: bold;
        }

        .info-panel {
            background: #ffffcc;
            border: 1px solid #808080;
            padding: 6px;
            margin-top: 8px;
            display: none;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 10px;
        }

        .info-row .label { color: #666; }
        .info-row .value { font-weight: bold; }

        .solde-box {
            background: #000080;
            color: white;
            padding: 8px;
            text-align: center;
            margin-top: 8px;
        }

        .solde-box .label { font-size: 10px; }
        .solde-box .value { font-size: 16px; font-weight: bold; font-family: 'Courier New', monospace; }

        /* Data grid */
        .data-grid {
            border: 1px inset #808080;
            background: white;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
        }

        .data-grid table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }

        .data-grid thead {
            background: #0a246a;
            color: white;
            position: sticky;
            top: 0;
        }

        .data-grid th {
            padding: 3px 6px;
            text-align: left;
            font-weight: bold;
            border-right: 1px solid #a6caf0;
        }

        .data-grid tbody tr {
            border-bottom: 1px solid #d4d0c8;
        }

        .data-grid tbody tr:nth-child(even) {
            background: #f0f0f0;
        }

        .data-grid tbody tr:hover {
            background: #0a246a;
            color: white;
        }

        .data-grid td {
            padding: 2px 6px;
            border-right: 1px solid #e0e0e0;
        }

        .data-grid td.number {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        /* Buttons */
        .action-btn {
            min-width: 90px;
            height: 22px;
            border: 2px outset #d4d0c8;
            background: linear-gradient(to bottom, #e8e8e8 0%, #c8c8c8 100%);
            font-size: 11px;
            cursor: pointer;
            padding: 0 10px;
        }
        .action-btn:active { border-style: inset; }
        .action-btn:disabled { color: #808080; cursor: not-allowed; }

        /* Warning box */
        .warning-box {
            background: #ffcccc;
            border: 2px solid #cc0000;
            padding: 8px;
            margin: 8px 0;
        }

        .warning-box .title {
            font-weight: bold;
            color: #cc0000;
            margin-bottom: 6px;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .checkbox-row input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }

        /* Button bar */
        .button-bar {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding-top: 8px;
            margin-top: 8px;
            border-top: 1px solid #808080;
        }

        /* Status bar */
        .status-bar {
            background: #d4d0c8;
            border-top: 1px solid #808080;
            padding: 2px 8px;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
        }

        .status-bar .message { color: #006600; }
        .status-bar .error { color: red; }

        /* Navigation */
        .nav-link {
            color: #0000ff;
            text-decoration: underline;
            cursor: pointer;
            font-size: 10px;
        }
        .nav-link:hover { color: #ff0000; }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="magic-window">
        <div class="title-bar">
            <div class="title">
                <div class="icon"></div>
                <span>Changement Compte - Prg_27/28</span>
            </div>
            <div class="window-controls">
                <button>_</button>
                <button>[]</button>
                <button onclick="window.location='index.html'">X</button>
            </div>
        </div>

        <div class="window-content">
            <!-- Toolbar - Operation selection -->
            <div class="toolbar">
                <button class="toolbar-btn active" id="btnSeparation" onclick="selectOperation('separation')">Separation</button>
                <button class="toolbar-btn" id="btnFusion" onclick="selectOperation('fusion')">Fusion</button>
                <span style="margin-left: 16px;">|</span>
                <span class="nav-link" onclick="window.location='index.html'" style="margin-left: 16px;">&larr; Retour Menu</span>
            </div>

            <!-- SEPARATION FORM -->
            <div id="separationForm">
                <fieldset>
                    <legend>Parametres</legend>
                    <div class="form-row">
                        <label>Societe:</label>
                        <input type="text" id="societe" value="CSK" maxlength="10" style="width:80px;">
                    </div>
                </fieldset>

                <div class="account-panels">
                    <div class="account-panel">
                        <h3>Compte Source</h3>
                        <div class="form-row">
                            <label>Code GM:</label>
                            <input type="number" id="compteSource" placeholder="Code GM">
                        </div>
                        <div class="form-row">
                            <label>Filiation:</label>
                            <input type="number" id="filiationSource" value="0" style="width:60px;">
                        </div>
                        <button class="action-btn" onclick="chargerCompteSource()">Charger</button>

                        <div id="sourceInfo" class="info-panel">
                            <div class="info-row">
                                <span class="label">Client:</span>
                                <span class="value" id="sourceNom">-</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Village:</span>
                                <span class="value" id="sourceVillage">-</span>
                            </div>
                        </div>

                        <div id="sourceSolde" class="solde-box" style="display:none;">
                            <div class="label">Solde Actuel</div>
                            <div class="value" id="sourceSoldeValue">0.00 EUR</div>
                        </div>
                    </div>

                    <div class="arrow-section">&rarr;</div>

                    <div class="account-panel">
                        <h3>Compte Destination</h3>
                        <div class="form-row">
                            <label>Code GM:</label>
                            <input type="number" id="compteDest" placeholder="Code GM">
                        </div>
                        <div class="form-row">
                            <label>Filiation:</label>
                            <input type="number" id="filiationDest" value="0" style="width:60px;">
                        </div>
                        <button class="action-btn" onclick="chargerCompteDest()">Charger</button>

                        <div id="destInfo" class="info-panel">
                            <div class="info-row">
                                <span class="label">Client:</span>
                                <span class="value" id="destNom">-</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Village:</span>
                                <span class="value" id="destVillage">-</span>
                            </div>
                        </div>

                        <div id="destSolde" class="solde-box" style="display:none;">
                            <div class="label">Solde Actuel</div>
                            <div class="value" id="destSoldeValue">0.00 EUR</div>
                        </div>
                    </div>
                </div>

                <fieldset>
                    <legend>Mouvements a Transferer</legend>
                    <div class="data-grid">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width:30px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                    <th style="width:80px;">Date</th>
                                    <th style="width:60px;">Service</th>
                                    <th>Description</th>
                                    <th style="width:100px;">Montant</th>
                                </tr>
                            </thead>
                            <tbody id="mouvementsBody">
                                <tr><td colspan="5" class="empty-state">Chargez un compte source</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="form-row" style="margin-top: 8px;">
                        <label>Montant Transfert:</label>
                        <input type="number" id="montantTransfert" step="0.01" placeholder="0.00" style="width:100px;">
                        <span style="margin-left:8px; font-size:10px; color:#666;">(si selection partielle)</span>
                    </div>
                </fieldset>

                <div class="warning-box">
                    <div class="title">Attention</div>
                    <p>Cette operation est irreversible. Les mouvements selectionnes seront transferes du compte source vers le compte destination.</p>
                    <div class="checkbox-row">
                        <input type="checkbox" id="confirmSeparation">
                        <label for="confirmSeparation">Je confirme vouloir effectuer cette separation</label>
                    </div>
                </div>

                <div class="button-bar">
                    <button class="action-btn" onclick="executerSeparation()">Executer</button>
                    <button class="action-btn" onclick="annuler()">Annuler</button>
                </div>
            </div>

            <!-- FUSION FORM -->
            <div id="fusionForm" class="hidden">
                <fieldset>
                    <legend>Parametres</legend>
                    <div class="form-row">
                        <label>Societe:</label>
                        <input type="text" id="societeFusion" value="CSK" maxlength="10" style="width:80px;">
                    </div>
                </fieldset>

                <div class="account-panels">
                    <div class="account-panel">
                        <h3>Comptes a Fusionner</h3>
                        <div id="comptesAFusionner">
                            <div class="form-row compte-fusion-item">
                                <label>Compte 1:</label>
                                <input type="number" class="fusion-compte" placeholder="Code GM" style="width:100px;">
                                <input type="number" class="fusion-filiation" value="0" style="width:50px; margin-left:4px;" placeholder="Fil">
                            </div>
                            <div class="form-row compte-fusion-item">
                                <label>Compte 2:</label>
                                <input type="number" class="fusion-compte" placeholder="Code GM" style="width:100px;">
                                <input type="number" class="fusion-filiation" value="0" style="width:50px; margin-left:4px;" placeholder="Fil">
                            </div>
                        </div>
                        <button class="action-btn" onclick="ajouterCompteFusion()" style="margin-top:8px;">+ Ajouter</button>
                    </div>

                    <div class="arrow-section">&rarr;</div>

                    <div class="account-panel">
                        <h3>Compte Final</h3>
                        <div class="form-row">
                            <label>Code GM:</label>
                            <input type="number" id="compteFinal" placeholder="Code GM">
                        </div>
                        <div class="form-row">
                            <label>Filiation:</label>
                            <input type="number" id="filiationFinal" value="0" style="width:60px;">
                        </div>
                        <button class="action-btn" onclick="chargerCompteFinal()">Charger</button>

                        <div id="finalInfo" class="info-panel">
                            <div class="info-row">
                                <span class="label">Client:</span>
                                <span class="value" id="finalNom">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="warning-box">
                    <div class="title">Attention</div>
                    <p>Cette operation est irreversible. Tous les mouvements des comptes sources seront transferes vers le compte destination.</p>
                    <div class="checkbox-row">
                        <input type="checkbox" id="confirmFusion">
                        <label for="confirmFusion">Je confirme vouloir effectuer cette fusion</label>
                    </div>
                </div>

                <div class="button-bar">
                    <button class="action-btn" onclick="executerFusion()">Executer</button>
                    <button class="action-btn" onclick="annuler()">Annuler</button>
                </div>
            </div>

            <!-- HISTORIQUE -->
            <fieldset style="margin-top: 8px;">
                <legend>Historique Operations</legend>
                <div class="data-grid" style="max-height: 120px;">
                    <table>
                        <thead>
                            <tr>
                                <th style="width:80px;">Date</th>
                                <th style="width:70px;">Type</th>
                                <th style="width:100px;">Compte Src</th>
                                <th style="width:100px;">Compte Dest</th>
                                <th style="width:80px;">Montant</th>
                                <th>Operateur</th>
                            </tr>
                        </thead>
                        <tbody id="historiqueBody">
                            <tr><td colspan="6" class="empty-state">Aucune operation recente</td></tr>
                        </tbody>
                    </table>
                </div>
            </fieldset>
        </div>

        <div class="status-bar">
            <span id="statusMessage" class="message">Pret</span>
            <span id="operationInfo">Mode: Separation</span>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentOperation = 'separation';
        let mouvementsSource = [];
        let compteFusionIndex = 3;

        function selectOperation(operation) {
            currentOperation = operation;

            document.getElementById('btnSeparation').classList.toggle('active', operation === 'separation');
            document.getElementById('btnFusion').classList.toggle('active', operation === 'fusion');

            document.getElementById('separationForm').classList.toggle('hidden', operation !== 'separation');
            document.getElementById('fusionForm').classList.toggle('hidden', operation !== 'fusion');

            document.getElementById('operationInfo').textContent = 'Mode: ' + (operation === 'separation' ? 'Separation' : 'Fusion');
        }

        async function chargerCompteSource() {
            const societe = document.getElementById('societe').value;
            const compte = document.getElementById('compteSource').value;
            const filiation = document.getElementById('filiationSource').value;

            if (!societe || !compte) {
                alert('Societe et Compte requis');
                return;
            }

            try {
                setStatus('Chargement compte source...');
                const soldeResp = await fetch(`${API_BASE}/solde/${societe}/${compte}/${filiation}`);
                const soldeData = await soldeResp.json();

                if (soldeData.found) {
                    document.getElementById('sourceInfo').style.display = 'block';
                    document.getElementById('sourceNom').textContent =
                        `${soldeData.prenomClient || ''} ${soldeData.nomClient || ''}`.trim() || '-';
                    document.getElementById('sourceVillage').textContent = soldeData.nomVillage || '-';

                    document.getElementById('sourceSolde').style.display = 'block';
                    document.getElementById('sourceSoldeValue').textContent =
                        (soldeData.solde || 0).toFixed(2) + ' EUR';

                    const extraitResp = await fetch(`${API_BASE}/extrait/${societe}/${compte}/${filiation}`);
                    const extraitData = await extraitResp.json();

                    if (extraitData.found && extraitData.mouvements) {
                        mouvementsSource = extraitData.mouvements;
                        displayMouvements(mouvementsSource);
                    }
                    setStatus('Compte source charge');
                } else {
                    alert('Compte non trouve');
                    setStatus('Compte non trouve', true);
                }
            } catch (err) {
                console.error(err);
                setStatus('Erreur chargement', true);
            }
        }

        async function chargerCompteDest() {
            const societe = document.getElementById('societe').value;
            const compte = document.getElementById('compteDest').value;
            const filiation = document.getElementById('filiationDest').value;

            if (!societe || !compte) {
                alert('Societe et Compte requis');
                return;
            }

            try {
                setStatus('Chargement compte destination...');
                const soldeResp = await fetch(`${API_BASE}/solde/${societe}/${compte}/${filiation}`);
                const soldeData = await soldeResp.json();

                if (soldeData.found) {
                    document.getElementById('destInfo').style.display = 'block';
                    document.getElementById('destNom').textContent =
                        `${soldeData.prenomClient || ''} ${soldeData.nomClient || ''}`.trim() || '-';
                    document.getElementById('destVillage').textContent = soldeData.nomVillage || '-';

                    document.getElementById('destSolde').style.display = 'block';
                    document.getElementById('destSoldeValue').textContent =
                        (soldeData.solde || 0).toFixed(2) + ' EUR';
                    setStatus('Compte destination charge');
                } else {
                    alert('Compte non trouve');
                    setStatus('Compte non trouve', true);
                }
            } catch (err) {
                console.error(err);
                setStatus('Erreur chargement', true);
            }
        }

        function displayMouvements(mouvements) {
            const tbody = document.getElementById('mouvementsBody');

            if (mouvements.length > 0) {
                tbody.innerHTML = mouvements.map((m, i) => `
                    <tr>
                        <td><input type="checkbox" class="mouvement-check" data-index="${i}"></td>
                        <td>${formatDate(m.dateOperation)}</td>
                        <td>${m.codeService || '-'}</td>
                        <td>${m.libelle || '-'}</td>
                        <td class="number">${m.montant?.toFixed(2) || '-'}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Aucun mouvement</td></tr>';
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            document.querySelectorAll('.mouvement-check').forEach(cb => {
                cb.checked = selectAll;
            });
        }

        async function executerSeparation() {
            if (!document.getElementById('confirmSeparation').checked) {
                alert('Veuillez confirmer l\'operation');
                return;
            }

            const societe = document.getElementById('societe').value;
            const compteSource = document.getElementById('compteSource').value;
            const filiationSource = document.getElementById('filiationSource').value;
            const compteDest = document.getElementById('compteDest').value;
            const filiationDest = document.getElementById('filiationDest').value;
            const montant = parseFloat(document.getElementById('montantTransfert').value) || 0;

            const selectedIndices = [];
            document.querySelectorAll('.mouvement-check:checked').forEach(cb => {
                selectedIndices.push(parseInt(cb.dataset.index));
            });

            if (selectedIndices.length === 0 && montant <= 0) {
                alert('Selectionnez des mouvements ou saisissez un montant');
                return;
            }

            try {
                setStatus('Separation en cours...');
                const response = await fetch(`${API_BASE}/changement-compte/separation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        societe,
                        compteSource: parseInt(compteSource),
                        filiationSource: parseInt(filiationSource || 0),
                        compteDest: parseInt(compteDest),
                        filiationDest: parseInt(filiationDest || 0),
                        mouvementsIndices: selectedIndices,
                        montant
                    })
                });
                const data = await response.json();

                if (data.success) {
                    alert('Separation effectuee avec succes!');
                    chargerCompteSource();
                    chargerCompteDest();
                    loadHistorique();
                    setStatus('Separation terminee');
                } else {
                    alert(data.message || 'Erreur lors de la separation');
                    setStatus('Erreur separation', true);
                }
            } catch (err) {
                console.error(err);
                setStatus('Erreur connexion', true);
            }
        }

        function ajouterCompteFusion() {
            const container = document.getElementById('comptesAFusionner');
            const div = document.createElement('div');
            div.className = 'form-row compte-fusion-item';
            div.innerHTML = `
                <label>Compte ${compteFusionIndex++}:</label>
                <input type="number" class="fusion-compte" placeholder="Code GM" style="width:100px;">
                <input type="number" class="fusion-filiation" value="0" style="width:50px; margin-left:4px;" placeholder="Fil">
                <button class="action-btn" onclick="this.parentElement.remove()" style="margin-left:4px; min-width:30px;">X</button>
            `;
            container.appendChild(div);
        }

        async function executerFusion() {
            if (!document.getElementById('confirmFusion').checked) {
                alert('Veuillez confirmer l\'operation');
                return;
            }

            const societe = document.getElementById('societeFusion').value;
            const compteFinal = document.getElementById('compteFinal').value;
            const filiationFinal = document.getElementById('filiationFinal').value;

            const comptesSource = [];
            document.querySelectorAll('.compte-fusion-item').forEach(item => {
                const compte = item.querySelector('.fusion-compte').value;
                const filiation = item.querySelector('.fusion-filiation').value;
                if (compte) {
                    comptesSource.push({
                        compte: parseInt(compte),
                        filiation: parseInt(filiation || 0)
                    });
                }
            });

            if (comptesSource.length < 2) {
                alert('Selectionnez au moins 2 comptes a fusionner');
                return;
            }

            try {
                setStatus('Fusion en cours...');
                const response = await fetch(`${API_BASE}/changement-compte/fusion`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        societe,
                        comptesSource,
                        compteDest: parseInt(compteFinal),
                        filiationDest: parseInt(filiationFinal || 0)
                    })
                });
                const data = await response.json();

                if (data.success) {
                    alert('Fusion effectuee avec succes!');
                    loadHistorique();
                    setStatus('Fusion terminee');
                } else {
                    alert(data.message || 'Erreur lors de la fusion');
                    setStatus('Erreur fusion', true);
                }
            } catch (err) {
                console.error(err);
                setStatus('Erreur connexion', true);
            }
        }

        async function chargerCompteFinal() {
            const societe = document.getElementById('societeFusion').value;
            const compte = document.getElementById('compteFinal').value;
            const filiation = document.getElementById('filiationFinal').value;

            if (!societe || !compte) {
                alert('Societe et Compte requis');
                return;
            }

            try {
                const soldeResp = await fetch(`${API_BASE}/solde/${societe}/${compte}/${filiation}`);
                const soldeData = await soldeResp.json();

                if (soldeData.found) {
                    document.getElementById('finalInfo').style.display = 'block';
                    document.getElementById('finalNom').textContent =
                        `${soldeData.prenomClient || ''} ${soldeData.nomClient || ''}`.trim() || '-';
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function loadHistorique() {
            const tbody = document.getElementById('historiqueBody');
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Aucune operation recente</td></tr>';
        }

        function annuler() {
            if (confirm('Annuler l\'operation en cours?')) {
                window.location.reload();
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR');
        }

        function setStatus(msg, isError = false) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = msg;
            statusEl.className = isError ? 'error' : 'message';
        }

        loadHistorique();
    </script>
</body>
</html>
