<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change GM - CA0142</title>
    <style>
        /* Style Windows classique - fidèle à Magic Unipaas */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'MS Sans Serif', 'Segoe UI', Tahoma, sans-serif;
            font-size: 11px;
            background-color: #808080;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .magic-window {
            background-color: #d4d0c8;
            border: 2px outset #ffffff;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.4);
            width: 700px;
        }

        .title-bar {
            background: linear-gradient(to right, #0a246a, #a6caf0);
            color: white;
            padding: 3px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 11px;
        }

        .title-bar .title { display: flex; align-items: center; gap: 5px; }
        .title-bar .icon { width: 16px; height: 16px; background: #4a9; border-radius: 2px; }

        .window-controls { display: flex; gap: 2px; }
        .window-controls button {
            width: 16px; height: 14px;
            border: 1px outset #c0c0c0;
            font-size: 9px; cursor: pointer;
            background: #c0c0c0;
        }

        .window-content { padding: 8px; }

        /* Fieldset Magic style */
        .fieldset {
            border: 1px inset #808080;
            padding: 8px;
            margin-bottom: 8px;
        }

        .fieldset-title {
            background: #d4d0c8;
            padding: 0 4px;
            margin-left: 8px;
            margin-top: -18px;
            position: relative;
            display: inline-block;
            font-weight: bold;
        }

        /* Form layout */
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .form-row label {
            width: 140px;
            text-align: right;
            padding-right: 8px;
            font-weight: bold;
        }

        .form-row input, .form-row select {
            border: 1px inset #808080;
            padding: 2px 4px;
            font-size: 11px;
            background: white;
        }

        .form-row input[type="text"] { width: 200px; }
        .form-row input[type="number"] { width: 120px; text-align: right; }
        .form-row select { width: 200px; }

        .form-row input:focus, .form-row select:focus {
            background: #ffffcc;
        }

        .form-row input[readonly] {
            background: #e8e8e8;
        }

        .form-row .unit {
            margin-left: 8px;
            font-weight: bold;
        }

        /* Résultat du calcul */
        .result-box {
            background: #ffffcc;
            border: 2px inset #808080;
            padding: 12px;
            text-align: center;
            margin: 8px 0;
        }

        .result-box .label {
            font-size: 10px;
            color: #666;
        }

        .result-box .value {
            font-size: 18px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #006600;
        }

        /* Radio buttons */
        .radio-group {
            display: flex;
            gap: 16px;
            padding: 4px 0;
        }

        .radio-group label {
            width: auto;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            width: 14px;
            height: 14px;
        }

        /* Boutons */
        .button-bar {
            display: flex;
            justify-content: space-between;
            padding-top: 8px;
            margin-top: 8px;
            border-top: 1px solid #808080;
        }

        .button-group {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            min-width: 100px;
            height: 24px;
            border: 2px outset #d4d0c8;
            background: linear-gradient(to bottom, #e8e8e8 0%, #c8c8c8 100%);
            font-size: 11px;
            cursor: pointer;
            padding: 0 12px;
        }
        .action-btn:active { border-style: inset; }
        .action-btn:disabled { color: #808080; cursor: not-allowed; }

        .action-btn.primary {
            background: linear-gradient(to bottom, #6699ff 0%, #3366cc 100%);
            color: white;
        }

        /* Status bar */
        .status-bar {
            background: #d4d0c8;
            border-top: 1px solid #808080;
            padding: 2px 8px;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
        }

        .status-bar .message { color: #006600; }
        .status-bar .error { color: red; }

        /* Navigation */
        .nav-link {
            color: #0000ff;
            text-decoration: underline;
            cursor: pointer;
            font-size: 10px;
        }
        .nav-link:hover { color: #ff0000; }

        /* Taux de change */
        .taux-info {
            background: #e8e8e8;
            border: 1px solid #808080;
            padding: 8px;
            margin-top: 8px;
            font-size: 10px;
        }

        .taux-info table {
            width: 100%;
            border-collapse: collapse;
        }

        .taux-info th, .taux-info td {
            padding: 2px 8px;
            text-align: left;
            border-bottom: 1px solid #c0c0c0;
        }

        .taux-info th {
            background: #d4d0c8;
            font-weight: bold;
        }

        .taux-info td.number {
            text-align: right;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="magic-window">
        <div class="title-bar">
            <div class="title">
                <div class="icon"></div>
                <span>Change GM - Prg_25</span>
            </div>
            <div class="window-controls">
                <button>_</button>
                <button>□</button>
                <button onclick="window.location='index.html'">×</button>
            </div>
        </div>

        <div class="window-content">
            <!-- Info GM -->
            <div class="fieldset">
                <span class="fieldset-title">Informations GM</span>
                <div class="form-row">
                    <label>Code GM:</label>
                    <input type="text" id="codeGm" readonly>
                    <span class="unit" id="nomGm"></span>
                </div>
                <div class="form-row">
                    <label>Solde compte:</label>
                    <input type="text" id="soldeCompte" readonly>
                    <span class="unit" id="deviseLocale">XOF</span>
                </div>
            </div>

            <!-- Type d'opération -->
            <div class="fieldset">
                <span class="fieldset-title">Type d'opération</span>
                <div class="form-row">
                    <label>Opération:</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="operation" value="A" checked onchange="updateOperation()">
                            Achat (GM vend devises)
                        </label>
                        <label>
                            <input type="radio" name="operation" value="V" onchange="updateOperation()">
                            Vente (GM achète devises)
                        </label>
                    </div>
                </div>
                <div class="form-row">
                    <label>Mode:</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="mode" value="U" checked onchange="updateMode()">
                            Unilatéral
                        </label>
                        <label>
                            <input type="radio" name="mode" value="B" onchange="updateMode()">
                            Bilatéral
                        </label>
                    </div>
                </div>
            </div>

            <!-- Saisie du change -->
            <div class="fieldset">
                <span class="fieldset-title">Opération de change</span>
                <div class="form-row">
                    <label>Devise étrangère:</label>
                    <select id="deviseEtrangere" onchange="chargerTaux()">
                        <option value="">-- Sélectionner --</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Montant devises:</label>
                    <input type="number" id="montantDevises" step="0.01" min="0" oninput="calculerEquivalent()">
                    <span class="unit" id="unitDevise">EUR</span>
                </div>
                <div class="form-row">
                    <label>Taux appliqué:</label>
                    <input type="text" id="tauxApplique" readonly>
                </div>
            </div>

            <!-- Résultat -->
            <div class="result-box">
                <div class="label">Équivalent en devise locale</div>
                <div class="value" id="montantLocal">0,00 XOF</div>
            </div>

            <!-- Taux de change -->
            <div class="taux-info">
                <table>
                    <thead>
                        <tr>
                            <th>Devise</th>
                            <th>Taux Achat</th>
                            <th>Taux Vente</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="tauxBody">
                        <tr>
                            <td colspan="4" style="text-align:center">Chargement...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Boutons d'action -->
            <div class="button-bar">
                <div class="button-group">
                    <span class="nav-link" onclick="window.location='index.html'">← Retour Menu</span>
                </div>
                <div class="button-group">
                    <button class="action-btn" onclick="razSaisie()">RAZ</button>
                    <button class="action-btn primary" onclick="validerChange()" id="btnValider" disabled>Valider</button>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <span id="statusMessage" class="message">Prêt</span>
            <span id="dateComptable"></span>
        </div>
    </div>

    <script>
        const API_BASE = '';
        const societe = localStorage.getItem('societe') || 'C';
        const codeGm = localStorage.getItem('codeGm') || '';
        const filiation = localStorage.getItem('filiation') || '0';
        let deviseLocale = 'XOF';
        let tauxChange = [];

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('dateComptable').textContent = new Date().toLocaleDateString('fr-FR');
            chargerDeviseLocale();
            chargerDevises();
            chargerInfoGM();
        });

        async function chargerDeviseLocale() {
            try {
                const response = await fetch(`${API_BASE}/api/change/devise-locale?societe=${societe}`);
                if (response.ok) {
                    const data = await response.json();
                    deviseLocale = data.codeDevise || data.code || 'XOF';
                    document.getElementById('deviseLocale').textContent = deviseLocale;
                }
            } catch (error) {
                console.error('Erreur chargement devise locale:', error);
            }
        }

        async function chargerDevises() {
            try {
                const response = await fetch(`${API_BASE}/api/zooms/devises/${societe}`);
                if (response.ok) {
                    const devises = await response.json();
                    const select = document.getElementById('deviseEtrangere');

                    devises.forEach(d => {
                        if (d.codeDevise !== deviseLocale) {
                            const option = document.createElement('option');
                            option.value = d.codeDevise;
                            option.textContent = `${d.codeDevise} - ${d.libelle || d.libelleDevise || ''}`;
                            select.appendChild(option);
                        }
                    });
                }
            } catch (error) {
                console.error('Erreur chargement devises:', error);
            }
        }

        async function chargerInfoGM() {
            if (!codeGm) {
                document.getElementById('codeGm').value = '(Aucun GM sélectionné)';
                return;
            }

            document.getElementById('codeGm').value = codeGm;

            try {
                const response = await fetch(`${API_BASE}/api/solde/${societe}/${codeGm}/${filiation}`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('soldeCompte').value = formatMontant(data.solde || data.montant || 0);
                }
            } catch (error) {
                console.error('Erreur chargement solde:', error);
            }
        }

        async function chargerTaux() {
            const devise = document.getElementById('deviseEtrangere').value;
            if (!devise) {
                document.getElementById('tauxApplique').value = '';
                document.getElementById('unitDevise').textContent = '';
                return;
            }

            document.getElementById('unitDevise').textContent = devise;

            try {
                const response = await fetch(`${API_BASE}/api/change/taux?societe=${societe}&codeDevise=${devise}`);
                if (response.ok) {
                    const data = await response.json();
                    const operation = document.querySelector('input[name="operation"]:checked').value;
                    const mode = document.querySelector('input[name="mode"]:checked').value;

                    // Taux selon type d'opération
                    let taux;
                    if (operation === 'A') {
                        taux = mode === 'U' ? data.tauxAchat : data.tauxVente;
                    } else {
                        taux = data.tauxVente;
                    }

                    document.getElementById('tauxApplique').value = taux ? taux.toFixed(4) : '-';

                    // Mettre à jour le tableau
                    document.getElementById('tauxBody').innerHTML = `
                        <tr>
                            <td>${devise}</td>
                            <td class="number">${data.tauxAchat ? data.tauxAchat.toFixed(4) : '-'}</td>
                            <td class="number">${data.tauxVente ? data.tauxVente.toFixed(4) : '-'}</td>
                            <td>${data.dateValidite ? new Date(data.dateValidite).toLocaleDateString('fr-FR') : '-'}</td>
                        </tr>
                    `;

                    calculerEquivalent();
                }
            } catch (error) {
                console.error('Erreur chargement taux:', error);
                document.getElementById('tauxApplique').value = 'Erreur';
            }
        }

        function updateOperation() {
            chargerTaux();
        }

        function updateMode() {
            chargerTaux();
        }

        async function calculerEquivalent() {
            const devise = document.getElementById('deviseEtrangere').value;
            const montant = parseFloat(document.getElementById('montantDevises').value) || 0;

            if (!devise || montant <= 0) {
                document.getElementById('montantLocal').textContent = `0,00 ${deviseLocale}`;
                document.getElementById('btnValider').disabled = true;
                return;
            }

            const operation = document.querySelector('input[name="operation"]:checked').value;
            const mode = document.querySelector('input[name="mode"]:checked').value;

            try {
                const url = `${API_BASE}/api/change/calculer?societe=${societe}&codeDevise=${devise}&montant=${montant}&typeOperation=${operation}&mode=${mode}`;
                const response = await fetch(url);

                if (response.ok) {
                    const data = await response.json();
                    const equivalent = data.equivalent || data.montantLocal || 0;
                    document.getElementById('montantLocal').textContent = `${formatMontant(equivalent)} ${deviseLocale}`;
                    document.getElementById('btnValider').disabled = !codeGm;
                }
            } catch (error) {
                console.error('Erreur calcul:', error);
                // Fallback: calcul local
                const taux = parseFloat(document.getElementById('tauxApplique').value) || 1;
                const equivalent = montant * taux;
                document.getElementById('montantLocal').textContent = `${formatMontant(equivalent)} ${deviseLocale}`;
            }
        }

        function razSaisie() {
            document.getElementById('deviseEtrangere').value = '';
            document.getElementById('montantDevises').value = '';
            document.getElementById('tauxApplique').value = '';
            document.getElementById('montantLocal').textContent = `0,00 ${deviseLocale}`;
            document.getElementById('btnValider').disabled = true;
        }

        async function validerChange() {
            const devise = document.getElementById('deviseEtrangere').value;
            const montant = parseFloat(document.getElementById('montantDevises').value);
            const operation = document.querySelector('input[name="operation"]:checked').value;

            if (!devise || !montant || !codeGm) {
                alert('Veuillez remplir tous les champs');
                return;
            }

            document.getElementById('statusMessage').textContent = 'Validation en cours...';

            // TODO: Appel API pour valider l'opération
            alert(`Opération de change validée:\n- Type: ${operation === 'A' ? 'Achat' : 'Vente'}\n- Devise: ${devise}\n- Montant: ${montant}`);

            document.getElementById('statusMessage').textContent = 'Opération validée';
            razSaisie();
        }

        function formatMontant(montant) {
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(montant);
        }
    </script>
</body>
</html>
