<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CA0142 - Gestion de la caisse</title>
    <style>
        /*
         * Conversion DLU → Pixels (basé sur XML Prg_121.xml)
         * Form: Width=939 DLU, Height=178 DLU, HorizontalFactor=8
         * Navigation: 117.375 × 22.25
         * Scale X: 0.5 (DLU × 0.5 = pixels)
         * Scale Y: 1.0 (DLU = pixels)
         */
        :root {
            --scale-x: 0.62;       /* Calibré: 939 × 0.62 = 582px */
            --scale-y: 1.80;       /* Calibré: 178 × 1.80 = 320px (+35%) */
            --form-width: 582px;
            --form-height: 320px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11px;
            background-color: #808080;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .magic-window {
            background-color: #dce6f4;
            border: 2px outset #c0c0c0;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            width: var(--form-width);
        }

        /* Title bar - Windows style */
        .title-bar {
            background: linear-gradient(to right, #0058a3, #3d9eff);
            color: white;
            padding: 2px 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            height: 20px;
        }

        .title-bar .title {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .title-bar .icon {
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #4a9, #2a7);
            border-radius: 2px;
        }

        .window-controls {
            display: flex;
            gap: 1px;
        }

        .window-controls button {
            width: 18px;
            height: 14px;
            border: 1px outset #c0c0c0;
            font-size: 9px;
            cursor: pointer;
            background: #c0c0c0;
        }

        .window-controls .close-btn { background: #ff6b6b; color: white; }

        /* Window content - relative positioning container */
        .window-content {
            position: relative;
            height: var(--form-height);
            overflow: hidden;
        }

        /* Header bar (Y=2, H=21) - relief style */
        .header-bar {
            position: absolute;
            left: 0;
            top: calc(2 * var(--scale-y) * 1px);
            width: calc(931 * var(--scale-x) * 1px);
            height: calc(21 * var(--scale-y) * 1px);
            background: linear-gradient(to bottom, #e8e8e8, #d0d0d0);
            border: 1px solid #a0a0a0;
        }

        /* Logo Orace (X=5, Y=4, W=59, H=18) */
        .logo-orace {
            position: absolute;
            left: calc(5 * var(--scale-x) * 1px);
            top: calc(4 * var(--scale-y) * 1px);
            width: calc(59 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-orace img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Fallback si image non disponible */
        .logo-orace.fallback {
            background: #2d5a2d;
            color: #90ee90;
            font-size: 8px;
            font-weight: bold;
        }

        /* User info (X=75, Y=8, W=365, H=8) */
        .user-info {
            position: absolute;
            left: calc(75 * var(--scale-x) * 1px);
            top: calc(8 * var(--scale-y) * 1px);
            width: calc(365 * var(--scale-x) * 1px);
            height: calc(8 * var(--scale-y) * 1px);
            font-size: 10px;
            font-weight: bold;
            color: #000080;
            letter-spacing: 1px;
        }

        /* Coffre status (X=450, Y=8, W=203, H=8) */
        .coffre-status {
            position: absolute;
            left: calc(450 * var(--scale-x) * 1px);
            top: calc(8 * var(--scale-y) * 1px);
            width: calc(203 * var(--scale-x) * 1px);
            height: calc(8 * var(--scale-y) * 1px);
            font-size: 10px;
            color: #800000;
            text-align: center;
        }

        /* Date (X=663, Y=8, W=259, H=8) */
        .date-info {
            position: absolute;
            left: calc(663 * var(--scale-x) * 1px);
            top: calc(8 * var(--scale-y) * 1px);
            width: calc(259 * var(--scale-x) * 1px);
            height: calc(8 * var(--scale-y) * 1px);
            font-size: 10px;
            color: #000080;
            text-align: right;
        }

        /* Coffre Reception label (X=7, Y=24, W=200, H=12) */
        .coffre-label {
            position: absolute;
            left: calc(7 * var(--scale-x) * 1px);
            top: calc(24 * var(--scale-y) * 1px);
            width: calc(200 * var(--scale-x) * 1px);
            height: calc(12 * var(--scale-y) * 1px);
            font-size: 10px;
            font-weight: bold;
            color: #008000;
            text-align: center;
        }

        .coffre-label.hidden { display: none; }

        /* Image caisse (X=52, Y=39, W=111, H=40) */
        .caisse-image {
            position: absolute;
            left: calc(52 * var(--scale-x) * 1px);
            top: calc(39 * var(--scale-y) * 1px);
            width: calc(111 * var(--scale-x) * 1px);
            height: calc(40 * var(--scale-y) * 1px);
            background: #f0f0f0;
            border: 1px solid #808080;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #666;
        }

        /* Status zone - simple horizontal rectangle like Magic */
        .status-zone {
            position: absolute;
            left: calc(289 * var(--scale-x) * 1px);
            top: calc(46 * var(--scale-y) * 1px);
            width: calc(353 * var(--scale-x) * 1px);
            height: calc(14 * var(--scale-y) * 1px);  /* Juste la hauteur du texte */
            border: 1px solid #808080;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Status label - centered text */
        .status-label {
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }

        .status-label.fermee { color: #cc0000; }  /* Rouge quand fermée */
        .status-label.ouverte { color: #008000; } /* Vert quand ouverte */

        /* Session info - positioned below status zone when open */
        .session-info {
            position: absolute;
            left: calc(289 * var(--scale-x) * 1px);
            top: calc(65 * var(--scale-y) * 1px);
            width: calc(353 * var(--scale-x) * 1px);
        }

        .session-row {
            display: flex;
            align-items: center;
            height: calc(12 * var(--scale-y) * 1px);
            font-size: 10px;
        }

        .session-row .label {
            width: calc(71 * var(--scale-x) * 1px);
            text-align: right;
            padding-right: 4px;
        }

        .session-row .value {
            flex: 1;
            font-weight: bold;
            color: #000080;
            text-align: center;
        }

        .session-info.hidden { display: none; }

        /* Bottom bar (Y=151, H=24) */
        .bottom-bar {
            position: absolute;
            left: 0;
            top: calc(151 * var(--scale-y) * 1px);
            width: calc(931 * var(--scale-x) * 1px);
            height: calc(24 * var(--scale-y) * 1px);
            background: linear-gradient(to bottom, #e8e8e8, #d0d0d0);
            border: 1px solid #a0a0a0;
        }

        /* Buttons - Windows 11 style */
        .magic-btn {
            position: absolute;
            background: linear-gradient(to bottom, #f9f9f9, #e5e5e5);
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 10px;
            text-align: center;
            padding: 0 4px;
            transition: background 0.15s, border-color 0.15s;
        }

        .magic-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #ffffff, #f0f0f0);
            border-color: #0078d4;
        }

        .magic-btn:active:not(:disabled) {
            background: linear-gradient(to bottom, #e0e0e0, #d0d0d0);
        }

        .magic-btn:disabled {
            color: #808080;
            cursor: default;
            opacity: 0.7;
        }

        .magic-btn.hidden { display: none; }

        /* Right side buttons (X=726) */
        .btn-appro-caisse {
            left: calc(726 * var(--scale-x) * 1px);
            top: calc(26 * var(--scale-y) * 1px);
            width: calc(200 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
        }

        .btn-appro-produits {
            left: calc(726 * var(--scale-x) * 1px);
            top: calc(48 * var(--scale-y) * 1px);
            width: calc(200 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
        }

        .btn-remise-caisse {
            left: calc(726 * var(--scale-x) * 1px);
            top: calc(70 * var(--scale-y) * 1px);
            width: calc(200 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
        }

        .btn-historiques {
            left: calc(726 * var(--scale-x) * 1px);
            top: calc(92 * var(--scale-y) * 1px);
            width: calc(200 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
        }

        /* Left side buttons */
        .btn-regul-tpe {
            left: calc(7 * var(--scale-x) * 1px);
            top: calc(85 * var(--scale-y) * 1px);
            width: calc(200 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
        }

        .btn-telecollecte-tpe {
            left: calc(7 * var(--scale-x) * 1px);
            top: calc(107 * var(--scale-y) * 1px);
            width: calc(200 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
        }

        .btn-visu-sessions {
            left: calc(7 * var(--scale-x) * 1px);
            top: calc(129 * var(--scale-y) * 1px);
            width: calc(200 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
        }

        /* Middle buttons */
        .btn-consultation {
            left: calc(238 * var(--scale-x) * 1px);
            top: calc(129 * var(--scale-y) * 1px);
            width: calc(200 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
        }

        .btn-impression {
            left: calc(485 * var(--scale-x) * 1px);
            top: calc(129 * var(--scale-y) * 1px);
            width: calc(440 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
        }

        /* Bottom row buttons (Y=154) */
        .btn-quitter {
            left: calc(7 * var(--scale-x) * 1px);
            top: calc(154 * var(--scale-y) * 1px);
            width: calc(200 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
        }

        .btn-ouvrir {
            left: calc(238 * var(--scale-x) * 1px);
            top: calc(154 * var(--scale-y) * 1px);
            width: calc(200 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
        }

        .btn-continuer {
            left: calc(469 * var(--scale-x) * 1px);
            top: calc(154 * var(--scale-y) * 1px);
            width: calc(224 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
        }

        .btn-fermer {
            left: calc(726 * var(--scale-x) * 1px);
            top: calc(154 * var(--scale-y) * 1px);
            width: calc(200 * var(--scale-x) * 1px);
            height: calc(18 * var(--scale-y) * 1px);
        }

        /* API status indicator */
        .api-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 4px 8px;
            background: #333;
            color: #0f0;
            font-family: monospace;
            font-size: 10px;
            border-radius: 4px;
        }

        .api-status.error { color: #f00; }
    </style>
</head>
<body>
    <div class="magic-window">
        <!-- Title bar -->
        <div class="title-bar">
            <div class="title">
                <div class="icon"></div>
                <span>Gestion de la caisse</span>
            </div>
            <div class="window-controls">
                <button class="min-btn">_</button>
                <button class="max-btn">□</button>
                <button class="close-btn">X</button>
            </div>
        </div>

        <!-- Window content with absolute positioning -->
        <div class="window-content">
            <!-- Header bar decoration -->
            <div class="header-bar"></div>

            <!-- Logo Orace - %club_images%orace.bmp -->
            <div class="logo-orace" id="logoOrace">
                <img src="/magic-images/orace.bmp" alt="ORACE" onerror="this.parentElement.classList.add('fallback'); this.style.display='none'; this.parentElement.textContent='ORACE';">
            </div>

            <!-- User info (Expression 1: user + terminal) -->
            <div class="user-info" id="userInfo">D S I O P (21)</div>

            <!-- Coffre status message (Expression 26) -->
            <div class="coffre-status" id="coffreStatus">Le coffre 2 est ferme</div>

            <!-- Date -->
            <div class="date-info" id="currentDate">WWW DD MMM YYYY</div>

            <!-- Coffre Reception label (Visible if session open) -->
            <div class="coffre-label" id="coffreLabel">Coffre Reception</div>

            <!-- Caisse image - hidden in Magic runtime -->
            <!-- <div class="caisse-image">%club_im</div> -->

            <!-- Status zone - simple rectangle -->
            <div class="status-zone">
                <div class="status-label fermee" id="statusLabel">Fermee</div>
            </div>

            <!-- Session info - separate, shown when session open -->
            <div class="session-info hidden" id="sessionInfo">
                <div class="session-row">
                    <span class="label">par</span>
                    <span class="value" id="sessionUser">-</span>
                </div>
                <div class="session-row">
                    <span class="label">le</span>
                    <span class="value" id="sessionDate">##/##/####</span>
                </div>
                <div class="session-row">
                    <span class="label">à</span>
                    <span class="value" id="sessionTime">HH:MM:SS</span>
                </div>
            </div>

            <!-- Right side operation buttons (Visible Exp 12/13: session open) -->
            <button class="magic-btn btn-appro-caisse hidden" id="btnApproCaisse">Appro caisse</button>
            <button class="magic-btn btn-appro-produits hidden" id="btnApproProduits">Appro produits</button>
            <button class="magic-btn btn-remise-caisse hidden" id="btnRemiseCaisse">Remise en caisse</button>
            <button class="magic-btn btn-historiques hidden" id="btnHistoriques">Historiques</button>

            <!-- Left side buttons -->
            <button class="magic-btn btn-regul-tpe" id="btnRegulTpe">Régul. Télécollecte</button>
            <button class="magic-btn btn-telecollecte-tpe" id="btnTelecollecteTpe">Telecollecte TPE</button>
            <button class="magic-btn btn-visu-sessions" id="btnVisuSessions">Visu sessions</button>

            <!-- Middle buttons -->
            <button class="magic-btn btn-consultation" id="btnConsultation">Consultation</button>
            <button class="magic-btn btn-impression hidden" id="btnImpression">Impression du dernier ticket</button>

            <!-- Bottom bar decoration -->
            <div class="bottom-bar"></div>

            <!-- Bottom row workflow buttons -->
            <button class="magic-btn btn-quitter" id="btnQuitter" onclick="quitter()">Quitter</button>
            <button class="magic-btn btn-ouvrir" id="btnOuvrir" onclick="ouvrirSession()">Ouvrir la session</button>
            <button class="magic-btn btn-continuer" id="btnContinuer" disabled>Continuer la session</button>
            <button class="magic-btn btn-fermer" id="btnFermer" disabled onclick="fermerSession()">Fermer la session</button>
        </div>
    </div>

    <div class="api-status" id="apiStatus">API: Connecting...</div>

    <script>
        const CONTEXT = {
            societe: 'C',
            utilisateur: 'DSIOP',
            terminal: 21,
            runMode: 'R',
            langue: 'E'
        };

        let sessionState = {
            status: 'F',  // F=Fermee, O=Ouverte, B=Bloquee
            chrono: null,
            utilisateur: null,
            dateOuverture: null,
            heureOuverture: null,
            coffreOuvert: false,
            hasTicket: false
        };

        document.addEventListener('DOMContentLoaded', async () => {
            updateDate();
            await checkApiConnection();
            await loadSessionState();
            updateUI();
        });

        function updateDate() {
            const now = new Date();
            const options = { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-GB', options);
        }

        async function checkApiConnection() {
            try {
                const response = await fetch('/api/sessions');
                if (response.ok) {
                    document.getElementById('apiStatus').textContent = 'API: OK';
                    document.getElementById('apiStatus').classList.remove('error');
                    return true;
                }
            } catch (e) {}
            document.getElementById('apiStatus').textContent = 'API: Error';
            document.getElementById('apiStatus').classList.add('error');
            return false;
        }

        async function loadSessionState() {
            try {
                const response = await fetch(`/api/sessions/active?utilisateur=${CONTEXT.utilisateur}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        sessionState = {
                            status: 'O',
                            chrono: result.data.chrono,
                            utilisateur: result.data.utilisateur,
                            dateOuverture: result.data.dateDebutSession,
                            heureOuverture: result.data.heureDebutSession,
                            coffreOuvert: false,
                            hasTicket: result.data.dateFinSession !== '00000000'
                        };
                    }
                }
            } catch (e) {
                console.error('Error loading session:', e);
            }
        }

        function updateUI() {
            // Expression 1: user + terminal
            document.getElementById('userInfo').textContent =
                CONTEXT.utilisateur.split('').join(' ') + ' (' + CONTEXT.terminal + ')';

            // Expression 26: coffre message
            document.getElementById('coffreStatus').textContent =
                'Le coffre 2 est ' + (sessionState.coffreOuvert ? 'ouvert' : 'ferme');

            const sessionOpen = sessionState.status === 'O';
            const sessionClosed = sessionState.status === 'F';
            const notBlocked = sessionState.status !== 'B';

            // Status label
            const statusLabel = document.getElementById('statusLabel');
            if (sessionOpen) {
                statusLabel.textContent = 'Ouverte';
                statusLabel.className = 'status-label ouverte';
            } else {
                statusLabel.textContent = 'Fermee';
                statusLabel.className = 'status-label fermee';
            }

            // Session info (Visible Exp 8: session open)
            const sessionInfo = document.getElementById('sessionInfo');
            if (sessionOpen) {
                sessionInfo.classList.remove('hidden');
                document.getElementById('sessionUser').textContent = sessionState.utilisateur || '-';
                document.getElementById('sessionDate').textContent = formatDate(sessionState.dateOuverture);
                document.getElementById('sessionTime').textContent = formatTime(sessionState.heureOuverture);
            } else {
                sessionInfo.classList.add('hidden');
            }

            // Coffre label (Visible Exp 24)
            document.getElementById('coffreLabel').classList.toggle('hidden', !sessionOpen);

            // Right side operations (Visible Exp 12/13: session open)
            document.getElementById('btnApproCaisse').classList.toggle('hidden', !sessionOpen);
            document.getElementById('btnApproProduits').classList.toggle('hidden', !sessionOpen);
            document.getElementById('btnRemiseCaisse').classList.toggle('hidden', !sessionOpen);
            document.getElementById('btnHistoriques').classList.toggle('hidden', !sessionOpen);

            // Consultation (Visible Exp 11: session closed)
            document.getElementById('btnConsultation').classList.toggle('hidden', sessionOpen);

            // Impression ticket (Visible Exp 17: has ticket)
            document.getElementById('btnImpression').classList.toggle('hidden', !sessionState.hasTicket);

            // Bottom buttons visibility (Visible Exp 10: not blocked)
            document.getElementById('btnOuvrir').style.display = notBlocked ? '' : 'none';
            document.getElementById('btnContinuer').style.display = notBlocked ? '' : 'none';
            document.getElementById('btnFermer').style.display = notBlocked ? '' : 'none';

            // Bottom buttons enabled (Exp 6/7)
            document.getElementById('btnOuvrir').disabled = !sessionClosed;
            document.getElementById('btnContinuer').disabled = !sessionOpen;
            document.getElementById('btnFermer').disabled = !sessionOpen;

            // Keep button text as "Continuer la session"
            // (chrono is not displayed on button in Magic)
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr.length !== 8 || dateStr === '00000000') return '##/##/####';
            return `${dateStr.substring(6,8)}/${dateStr.substring(4,6)}/${dateStr.substring(0,4)}`;
        }

        function formatTime(timeStr) {
            if (!timeStr || timeStr.length < 4) return 'HH:MM:SS';
            const p = timeStr.padStart(6, '0');
            return `${p.substring(0,2)}:${p.substring(2,4)}:${p.substring(4,6)}`;
        }

        function quitter() {
            if (confirm('Voulez-vous quitter?')) {
                window.location.href = '/';
            }
        }

        async function ouvrirSession() {
            try {
                const response = await fetch('/api/sessions/ouvrir', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        societe: CONTEXT.societe,
                        utilisateur: CONTEXT.utilisateur
                    })
                });
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        await loadSessionState();
                        updateUI();
                    } else {
                        alert('Erreur: ' + (result.errorMessage || 'Echec'));
                    }
                }
            } catch (e) {
                alert('Erreur connexion');
            }
        }

        async function fermerSession() {
            if (!confirm('Fermer la session?')) return;
            try {
                const response = await fetch('/api/sessions/fermer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        societe: CONTEXT.societe,
                        utilisateur: CONTEXT.utilisateur,
                        chrono: sessionState.chrono
                    })
                });
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        sessionState.status = 'F';
                        updateUI();
                    } else {
                        alert('Erreur: ' + (result.errorMessage || 'Echec'));
                    }
                }
            } catch (e) {
                alert('Erreur connexion');
            }
        }
    </script>
</body>
</html>
