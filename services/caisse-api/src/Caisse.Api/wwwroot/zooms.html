<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zooms Référentiels - CA0164</title>
    <style>
        /* Style Windows classique - fidèle à Magic Unipaas */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'MS Sans Serif', 'Segoe UI', Tahoma, sans-serif;
            font-size: 11px;
            background-color: #808080;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        .magic-window {
            background-color: #d4d0c8;
            border: 2px outset #ffffff;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.4);
            width: 950px;
        }

        .title-bar {
            background: linear-gradient(to right, #0a246a, #a6caf0);
            color: white;
            padding: 3px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 11px;
        }

        .title-bar .title { display: flex; align-items: center; gap: 5px; }
        .title-bar .icon { width: 16px; height: 16px; background: #4a9; border-radius: 2px; }

        .window-controls { display: flex; gap: 2px; }
        .window-controls button {
            width: 16px; height: 14px;
            border: 1px outset #c0c0c0;
            font-size: 9px; cursor: pointer;
            background: #c0c0c0;
        }

        .window-content { padding: 8px; }

        /* Toolbar */
        .toolbar {
            background: #d4d0c8;
            border: 1px inset #808080;
            padding: 4px 8px;
            margin-bottom: 8px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar label {
            font-weight: bold;
        }

        .toolbar input, .toolbar select {
            border: 1px inset #808080;
            padding: 2px 4px;
            font-size: 11px;
            background: white;
        }

        .toolbar-btn {
            min-width: 70px;
            height: 22px;
            border: 2px outset #d4d0c8;
            background: linear-gradient(to bottom, #e8e8e8 0%, #c8c8c8 100%);
            font-size: 11px;
            cursor: pointer;
            padding: 0 8px;
        }
        .toolbar-btn:active { border-style: inset; }

        /* Tabs */
        .tab-bar {
            display: flex;
            border-bottom: 1px solid #808080;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 4px 10px;
            border: 1px outset #d4d0c8;
            border-bottom: none;
            background: #c0c0c0;
            font-size: 10px;
            cursor: pointer;
            margin-right: 2px;
            margin-bottom: -1px;
        }

        .tab-btn.active {
            background: #d4d0c8;
            border-bottom: 1px solid #d4d0c8;
            font-weight: bold;
        }

        .tab-btn:hover:not(.active) {
            background: #d0d0d0;
        }

        /* Data grid */
        .data-grid {
            border: 1px inset #808080;
            background: white;
            width: 100%;
        }

        .data-grid table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .data-grid thead {
            background: #0a246a;
            color: white;
            position: sticky;
            top: 0;
        }

        .data-grid th {
            padding: 4px 8px;
            text-align: left;
            font-weight: bold;
            border-right: 1px solid #a6caf0;
            cursor: pointer;
        }

        .data-grid th:hover {
            background: #1a347a;
        }

        .data-grid tbody tr {
            border-bottom: 1px solid #d4d0c8;
        }

        .data-grid tbody tr:nth-child(even) {
            background: #f0f0f0;
        }

        .data-grid tbody tr:hover {
            background: #0a246a;
            color: white;
        }

        .data-grid tbody tr.selected {
            background: #0a246a;
            color: white;
        }

        .data-grid td {
            padding: 3px 8px;
            border-right: 1px solid #e0e0e0;
        }

        .data-grid td.number {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .grid-container {
            height: 400px;
            overflow-y: auto;
            border: 1px inset #808080;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            border: 1px solid;
        }

        .badge-oui {
            background: #90ee90;
            color: #006600;
            border-color: #006600;
        }

        .badge-non {
            background: #ffcccc;
            color: #cc0000;
            border-color: #cc0000;
        }

        /* Status bar */
        .status-bar {
            background: #d4d0c8;
            border-top: 1px solid #808080;
            padding: 2px 8px;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
        }

        .status-bar .message { color: #006600; }
        .status-bar .error { color: red; }

        /* Search */
        .search-box {
            border: 1px inset #808080;
            padding: 2px 4px;
            font-size: 11px;
            background: white;
            width: 200px;
        }

        /* Nav link */
        .nav-link {
            color: #0000ff;
            text-decoration: underline;
            cursor: pointer;
            font-size: 10px;
        }
        .nav-link:hover { color: #ff0000; }

        /* Button bar */
        .button-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #808080;
        }
    </style>
</head>
<body>
    <div class="magic-window">
        <div class="title-bar">
            <div class="title">
                <div class="icon"></div>
                <span>Zooms Référentiels - Prg_164-189</span>
            </div>
            <div class="window-controls">
                <button>_</button>
                <button>□</button>
                <button onclick="window.location='index.html'">×</button>
            </div>
        </div>

        <div class="window-content">
            <!-- Onglets -->
            <div class="tab-bar">
                <button class="tab-btn active" data-tab="devises">Devises</button>
                <button class="tab-btn" data-tab="moyens-reglement">Moyens Règlement</button>
                <button class="tab-btn" data-tab="garanties">Garanties</button>
                <button class="tab-btn" data-tab="depots-objets">Dépôts Objets</button>
                <button class="tab-btn" data-tab="depots-devises">Dépôts Devises</button>
                <button class="tab-btn" data-tab="pays">Pays</button>
                <button class="tab-btn" data-tab="types-taux-change">Types Taux</button>
                <button class="tab-btn" data-tab="tables">Tables</button>
            </div>

            <!-- Toolbar -->
            <div class="toolbar">
                <label>Société:</label>
                <input type="text" id="societe" value="C" maxlength="2" style="width:40px;">

                <div id="tableNameGroup" style="display:none;">
                    <label>Table:</label>
                    <select id="nomTable">
                        <option value="M_SER">Services (M_SER)</option>
                        <option value="M_ART">Articles (M_ART)</option>
                        <option value="M_OPE">Opérateurs (M_OPE)</option>
                        <option value="M_CAI">Caisses (M_CAI)</option>
                    </select>
                </div>

                <button class="toolbar-btn" onclick="charger()">Charger</button>

                <div style="flex:1;"></div>

                <label>Recherche:</label>
                <input type="text" id="searchInput" class="search-box" placeholder="Filtrer..." oninput="filtrer()">
            </div>

            <!-- Grille -->
            <div class="grid-container">
                <div class="data-grid">
                    <table>
                        <thead id="tableHead">
                            <tr>
                                <th>Société</th>
                                <th>Code</th>
                                <th>Libellé</th>
                                <th>Taux</th>
                                <th>Numéro</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="5" style="text-align:center; padding:40px;">
                                    Sélectionnez un onglet et cliquez sur Charger
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="button-bar">
                <span id="selectedInfo"></span>
                <span class="nav-link" onclick="window.location='index.html'">← Retour Menu</span>
            </div>
        </div>

        <div class="status-bar">
            <span id="statusMessage" class="message">Prêt</span>
            <span id="recordCount">0 élément(s)</span>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let currentTab = 'devises';
        let currentData = [];
        let selectedRow = null;

        const societe = localStorage.getItem('societe') || 'C';
        document.getElementById('societe').value = societe;

        // Configuration des onglets
        const tabConfig = {
            'devises': {
                title: 'Devises',
                endpoint: (s) => `/api/zooms/devises/${s}`,
                columns: ['societe', 'codeDevise', 'libelle', 'taux', 'numero'],
                headers: ['Société', 'Code', 'Libellé', 'Taux', 'Numéro'],
                needsSociete: true
            },
            'moyens-reglement': {
                title: 'Moyens de Règlement',
                endpoint: (s) => `/api/zooms/moyens-reglement/${s}`,
                columns: ['societe', 'mop', 'devise', 'typeOperation', 'tauxDeChange'],
                headers: ['Société', 'MOP', 'Devise', 'Type Op.', 'Taux Change'],
                needsSociete: true
            },
            'garanties': {
                title: 'Types de Garantie',
                endpoint: (s) => `/api/zooms/garanties/${s}`,
                columns: ['societe', 'codeGarantie', 'libelle', 'montant', 'codeClasse'],
                headers: ['Société', 'Code', 'Libellé', 'Montant', 'Classe'],
                needsSociete: true
            },
            'depots-objets': {
                title: 'Dépôts Objets',
                endpoint: (s) => `/api/zooms/depots-objets/${s}`,
                columns: ['societe', 'codeObjet', 'libelle'],
                headers: ['Société', 'Code', 'Libellé'],
                needsSociete: true
            },
            'depots-devises': {
                title: 'Dépôts Devises',
                endpoint: (s) => `/api/zooms/depots-devises/${s}`,
                columns: ['societe', 'moyenPaiement', 'libelle'],
                headers: ['Société', 'Moyen Paiement', 'Libellé'],
                needsSociete: true
            },
            'pays': {
                title: 'Pays / Nationalités',
                endpoint: () => `/api/zooms/pays`,
                columns: ['codePays', 'libelle', 'codeLangue', 'monnaie', 'codeTelephone'],
                headers: ['Code', 'Libellé', 'Langue', 'Monnaie', 'Indicatif'],
                needsSociete: false
            },
            'types-taux-change': {
                title: 'Types Taux de Change',
                endpoint: (s) => `/api/zooms/types-taux-change/${s}`,
                columns: ['societe', 'code', 'libelle', 'utilise'],
                headers: ['Société', 'Code', 'Libellé', 'Utilisé'],
                needsSociete: true
            },
            'tables': {
                title: 'Tables de Référence',
                endpoint: (s, t) => `/api/zooms/tables/${t}`,
                columns: ['nomTable', 'codeAlpha5', 'libelle20', 'valeurNumerique', 'classe'],
                headers: ['Table', 'Code', 'Libellé', 'Valeur', 'Classe'],
                needsSociete: false,
                needsTableName: true
            }
        };

        // Gestion des onglets
        document.querySelectorAll('.tab-btn').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.dataset.tab;

                const config = tabConfig[currentTab];
                document.getElementById('tableNameGroup').style.display = config.needsTableName ? 'inline-block' : 'none';

                // Mettre à jour les headers
                updateHeaders();

                // Vider les données
                currentData = [];
                renderTable();
            });
        });

        function updateHeaders() {
            const config = tabConfig[currentTab];
            const thead = document.getElementById('tableHead');
            thead.innerHTML = '<tr>' + config.headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
        }

        async function charger() {
            const soc = document.getElementById('societe').value.trim();
            const nomTable = document.getElementById('nomTable').value;
            const config = tabConfig[currentTab];

            if (config.needsSociete && !soc) {
                alert('Entrez une société');
                return;
            }

            try {
                document.getElementById('statusMessage').textContent = 'Chargement...';
                document.getElementById('statusMessage').className = 'message';

                const url = config.needsTableName
                    ? config.endpoint(soc, nomTable)
                    : config.endpoint(soc);

                const response = await fetch(API_BASE + url);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                currentData = await response.json();
                renderTable();

                document.getElementById('statusMessage').textContent = `Chargé à ${new Date().toLocaleTimeString()}`;
                document.getElementById('recordCount').textContent = `${currentData.length} élément(s)`;
            } catch (error) {
                document.getElementById('statusMessage').textContent = error.message;
                document.getElementById('statusMessage').className = 'error';
                currentData = [];
                renderTable();
            }
        }

        function renderTable() {
            const config = tabConfig[currentTab];
            const tbody = document.getElementById('tableBody');

            if (currentData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${config.columns.length}" style="text-align:center; padding:40px;">Aucune donnée</td></tr>`;
                return;
            }

            tbody.innerHTML = currentData.map((row, idx) => {
                const cells = config.columns.map(col => {
                    let val = row[col];
                    if (val === true || val === 'O') return '<span class="badge badge-oui">Oui</span>';
                    if (val === false || val === 'N') return '<span class="badge badge-non">Non</span>';
                    if (typeof val === 'number') return `<span style="font-family:'Courier New',monospace;">${val.toLocaleString('fr-FR')}</span>`;
                    return val ?? '-';
                }).join('</td><td>');
                return `<tr data-idx="${idx}" onclick="selectRow(this)"><td>${cells}</td></tr>`;
            }).join('');
        }

        function filtrer() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            let visible = 0;

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const show = text.includes(search);
                row.style.display = show ? '' : 'none';
                if (show) visible++;
            });

            document.getElementById('recordCount').textContent = `${visible} / ${currentData.length} élément(s)`;
        }

        function selectRow(tr) {
            document.querySelectorAll('#tableBody tr').forEach(r => r.classList.remove('selected'));
            tr.classList.add('selected');
            selectedRow = currentData[parseInt(tr.dataset.idx)];

            const config = tabConfig[currentTab];
            const key = config.columns[1];
            document.getElementById('selectedInfo').textContent = `Sélectionné: ${selectedRow[key] || selectedRow[config.columns[0]]}`;
        }

        // Initialisation
        updateHeaders();
    </script>
</body>
</html>
