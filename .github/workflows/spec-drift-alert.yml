# spec-drift-alert.yml
# Daily drift report - compares current KB state with saved specs
# Part of Capitalisation Optimale plan - Phase 2

name: Daily Drift Report

on:
  schedule:
    - cron: '0 6 * * *'  # 6h UTC daily (7h/8h CET/CEST)

  workflow_dispatch:
    inputs:
      project:
        description: 'Project to check (ADH, PBP, etc. or ALL)'
        required: false
        default: 'ALL'
      threshold:
        description: 'Maximum programs to check'
        required: false
        default: '100'

env:
  KB_PATH: ~/.magic-kb/knowledge.db
  SPECS_PATH: .openspec/specs
  RENDERS_PATH: .openspec/renders

jobs:
  # ============================================================================
  # Generate Drift Report
  # ============================================================================
  drift-report:
    runs-on: windows-latest
    outputs:
      has_drift: ${{ steps.report.outputs.has_drift }}
      critical_count: ${{ steps.report.outputs.critical_count }}
      report_summary: ${{ steps.report.outputs.summary }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Generate drift report
        id: report
        shell: pwsh
        run: |
          $project = '${{ github.event.inputs.project || 'ALL' }}'
          $maxPrograms = [int]'${{ github.event.inputs.threshold || '100' }}'

          Write-Host "=== Daily Drift Report ===" -ForegroundColor Cyan
          Write-Host "Project: $project | Max: $maxPrograms"

          $kbPath = "$env:USERPROFILE\.magic-kb\knowledge.db"
          $specsPath = ".openspec/specs"
          $rendersPath = ".openspec/renders"

          $driftResults = @()
          $criticalCount = 0
          $majorCount = 0
          $minorCount = 0

          # Get all spec files
          $specFiles = if ($project -eq 'ALL') {
            Get-ChildItem -Path $specsPath -Filter "*.md" -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -match '^[A-Z]+-IDE-\d+\.md$' } |
              Select-Object -First $maxPrograms
          } else {
            Get-ChildItem -Path $specsPath -Filter "$project-IDE-*.md" -ErrorAction SilentlyContinue |
              Select-Object -First $maxPrograms
          }

          Write-Host "Checking $($specFiles.Count) specs for drift..."

          foreach ($specFile in $specFiles) {
            if ($specFile.Name -match '^([A-Z]+)-IDE-(\d+)\.md$') {
              $proj = $Matches[1]
              $ide = [int]$Matches[2]

              # Read spec metrics from file
              $content = Get-Content $specFile.FullName -Raw

              $specMetrics = @{}
              if ($content -match 'Tables:\s*(\d+)') { $specMetrics['table_count'] = [int]$Matches[1] }
              if ($content -match 'Tables en ecriture:\s*(\d+)') { $specMetrics['write_table_count'] = [int]$Matches[1] }
              if ($content -match 'Expressions:\s*(\d+)') { $specMetrics['expression_count'] = [int]$Matches[1] }
              if ($content -match 'Variables.*:\s*(\d+)') { $specMetrics['variable_count'] = [int]$Matches[1] }

              # Query current KB metrics
              if (Test-Path $kbPath) {
                $query = "SELECT table_count, write_table_count, expression_count, variable_count FROM program_specs WHERE project='$proj' AND ide_position=$ide;"
                $kbResult = sqlite3 $kbPath $query 2>$null

                if ($kbResult) {
                  $parts = $kbResult -split '\|'
                  $kbMetrics = @{
                    table_count = [int]$parts[0]
                    write_table_count = [int]$parts[1]
                    expression_count = [int]$parts[2]
                    variable_count = [int]$parts[3]
                  }

                  # Compare metrics
                  $driftLevel = "IN_SYNC"
                  $driftDetails = @()

                  foreach ($metric in @('table_count', 'write_table_count', 'expression_count')) {
                    if ($specMetrics.ContainsKey($metric) -and $kbMetrics.ContainsKey($metric)) {
                      $specVal = $specMetrics[$metric]
                      $kbVal = $kbMetrics[$metric]
                      $diff = [math]::Abs($kbVal - $specVal)

                      if ($diff -gt 0) {
                        $pctDiff = if ($specVal -gt 0) { [math]::Round($diff * 100 / $specVal, 1) } else { 100 }

                        # Determine severity based on metric type and deviation
                        if ($metric -eq 'write_table_count' -and $diff -gt 0) {
                          $driftLevel = "CRITICAL"
                          $criticalCount++
                          $driftDetails += "$metric: $specVal -> $kbVal (+$diff)"
                        } elseif ($pctDiff -ge 20) {
                          if ($driftLevel -ne "CRITICAL") { $driftLevel = "MAJOR" }
                          $majorCount++
                          $driftDetails += "$metric: $specVal -> $kbVal ($pctDiff%)"
                        } elseif ($pctDiff -ge 5) {
                          if ($driftLevel -eq "IN_SYNC") { $driftLevel = "MINOR" }
                          $minorCount++
                          $driftDetails += "$metric: $specVal -> $kbVal ($pctDiff%)"
                        }
                      }
                    }
                  }

                  if ($driftLevel -ne "IN_SYNC") {
                    $driftResults += [PSCustomObject]@{
                      Project = $proj
                      IDE = $ide
                      Level = $driftLevel
                      Details = $driftDetails -join "; "
                    }
                  }
                }
              }
            }
          }

          # Generate summary
          $hasDrift = $driftResults.Count -gt 0
          $summary = "Checked: $($specFiles.Count) | Critical: $criticalCount | Major: $majorCount | Minor: $minorCount"

          Write-Host "`n=== Drift Summary ===" -ForegroundColor Cyan
          Write-Host $summary

          if ($hasDrift) {
            Write-Host "`nDrift detected in $($driftResults.Count) programs:" -ForegroundColor Yellow
            foreach ($d in $driftResults | Sort-Object Level -Descending | Select-Object -First 20) {
              $color = switch ($d.Level) {
                "CRITICAL" { "Red" }
                "MAJOR" { "Yellow" }
                default { "Gray" }
              }
              Write-Host "  [$($d.Level)] $($d.Project) IDE $($d.IDE): $($d.Details)" -ForegroundColor $color
            }
          } else {
            Write-Host "`nNo drift detected - all specs are in sync" -ForegroundColor Green
          }

          # Save full report to file
          $reportPath = ".openspec/reports/drift-report-$(Get-Date -Format 'yyyy-MM-dd').md"
          if (-not (Test-Path ".openspec/reports")) {
            New-Item -ItemType Directory -Path ".openspec/reports" -Force | Out-Null
          }

          $reportMd = @"
          # Drift Report - $(Get-Date -Format 'yyyy-MM-dd')

          ## Summary
          - **Specs Checked**: $($specFiles.Count)
          - **Critical Drift**: $criticalCount
          - **Major Drift**: $majorCount
          - **Minor Drift**: $minorCount

          ## Details

          | Project | IDE | Level | Details |
          |---------|-----|-------|---------|
          $($driftResults | ForEach-Object { "| $($_.Project) | $($_.IDE) | $($_.Level) | $($_.Details) |" } | Out-String)

          ---
          *Generated by Daily Drift Report workflow*
          "@

          $reportMd | Out-File $reportPath -Encoding UTF8

          # Output for next steps
          echo "has_drift=$hasDrift" >> $env:GITHUB_OUTPUT
          echo "critical_count=$criticalCount" >> $env:GITHUB_OUTPUT
          echo "summary=$summary" >> $env:GITHUB_OUTPUT

      - name: Upload drift report
        uses: actions/upload-artifact@v4
        with:
          name: drift-report
          path: .openspec/reports/drift-report-*.md
          retention-days: 30

  # ============================================================================
  # Create Issue if Drift Detected
  # ============================================================================
  create-issue:
    needs: drift-report
    if: needs.drift-report.outputs.has_drift == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Create issue for drift
        uses: actions/github-script@v7
        with:
          script: |
            const criticalCount = parseInt('${{ needs.drift-report.outputs.critical_count }}');
            const summary = '${{ needs.drift-report.outputs.summary }}';

            const severity = criticalCount > 0 ? ':rotating_light: CRITICAL' : ':warning: Warning';
            const labels = criticalCount > 0 ? ['critical', 'spec-drift', 'automated'] : ['spec-drift', 'automated'];

            const body = `## ${severity} Spec Drift Detected

            ${summary}

            ### Actions Required
            ${criticalCount > 0 ? '- **CRITICAL**: Write table changes detected - requires immediate review' : ''}
            - Review drift report artifact for details
            - Regenerate affected specs: \`.\tools\spec-generator\Render-Spec.ps1 -Project PROJECT -IDE IDE\`
            - Or trigger full regeneration: [Spec Sync workflow](../../actions/workflows/spec-sync.yml)

            ### Regeneration Command
            \`\`\`powershell
            # Regenerate all drifted specs
            .\tools\spec-generator\Regenerate-Changed-Specs.ps1
            \`\`\`

            ---
            *Generated by Daily Drift Report workflow*
            *Date: ${new Date().toISOString().split('T')[0]}*`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${severity} Spec Drift Detected - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: labels
            });
